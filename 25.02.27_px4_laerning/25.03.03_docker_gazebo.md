# docker容器内实现px4编译和gazebo仿真

## 安装docker

[https://www.sysgeek.cn/install-docker-ubuntu/](https://www.sysgeek.cn/install-docker-ubuntu/)  
[https://blog.csdn.net/littlewells/article/details/142616408](https://blog.csdn.net/littlewells/article/details/142616408)

---

## docker基础操作

显示全部容器
```bash
docker ps -a
```
创建实例容器
```bash
docker run hello-world
```
查看镜像
```bash
docker images
```
删除容器
```bash
docker rm xxx
```
进入容器
```bash
sudo docker exec -it xxx /bin/bash
```
另存为镜像
```bash
docker commit px4 px4v1.13.0
```
重命名
```bash
docker rename px4 new
```
删除镜像
```bash
docker rmi px4
```

---

## 成功下载ros-noetic镜像

```bash
gedit /etc/docker/daemon.json
```

```json
{
  "registry-mirrors": [
    "https://docker.m.daocloud.io ",
    "https://mirror.baidubce.com ",
    "http://hub-mirror.c.163.com "
  ]
}
```

```bash
sudo docker pull m.daocloud.io/docker.io/osrf/ros:noetic-desktop-full
```

---

## vscode下载拓展，编写容器内代码

Dev Containers

---

## 启动容器

```bash
sudo docker run -dit \
--name=px4 \
--gpus all \
-e NVIDIA_DRIVER_CAPABILITIES=all \
-v /etc/passwd:/etc/passwd:ro \
-v /etc/group:/etc/group:ro \
-v /dev:/dev \
-v /home/chen:/home/chen \
-v /tmp/.X11-unix:/tmp/.X11-unix  \
-e DISPLAY=unix$DISPLAY \
-w /home/chen \
--user $(id -u):$(id -g) \
--privileged  \
--net=host \
--restart=no \
osrf/ros:noetic-desktop-full
```

---

## 快捷脚本

```bash
gedit ~/.docker/setup/px4
```

```bash
xhost +local:docker
echo "请输入指令控制px4容器: 启动(s) 重启(r) 进入(e)  关闭(c):"
read choose
case $choose in
s) docker start px4;;
r) docker restart px4;;
e) docker exec -it px4 /bin/bash;;
c) docker stop px4;;
esac
newgrp docker
```

---

## 解决报错：安装nvidia-container-toolkit

[https://blog.csdn.net/qq_38628046/article/details/136312844](https://blog.csdn.net/qq_38628046/article/details/136312844)

```bash
chen@chen:~$ docker start px4
Error response from daemon: could not select device driver "" with capabilities: [[gpu]]
Error: failed to start containers: px4
E: 无法定位软件包 nvidia-container-toolkit
```

[https://blog.csdn.net/KingOfMyHeart/article/details/122351152](https://blog.csdn.net/KingOfMyHeart/article/details/122351152)  
官网查找到地址迁移，用官网的下载教程  
[https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html)

---

## 设置容器内免密码获取su权限

```bash
docker exec -u 0 -it px4 bash
apt update && apt install -y sudo
echo "chen ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
```

---

由于设置容器 `-v /home/chen:/home/chen`，故容器 `.bashrc` 同本机 `/root/.bashrc`，但软件源不同于本机

## 更新源

修改环境变量 `.bashrc`，应该 `/home/chen/.bashrc` 和 `/root/.bashrc` 一起修改

```bash
sudo wget http://fishros.com/install  -O fishros && . fishros
sudo apt update
sudo apt upgrade
sudo apt install gedit
```

---

## 安装px4

---

### 选项1：安装px4v1.13.0

无需下载和使用 proxychains4  
跳过 `sudo pip install --upgrade python-dateutil`  
[https://u0hfx9kgt5s.feishu.cn/docx/UUK8dicSgo0VFmxTSVBcGtdvnhe](https://u0hfx9kgt5s.feishu.cn/docx/UUK8dicSgo0VFmxTSVBcGtdvnhe)

验证
```bash
make px4_sitl
```
安装FAST和创建ROS2工作空间后
```bash
make px4_sitl_default gazebo
```
起飞：
```bash
commander takeoff
```
降落：
```bash
commander land
```
```bash
make px4_sitl jmavsim
```

---

### 选项2：安装px4v1.14.0

[https://blog.csdn.net/weixin_42037083/article/details/137102858](https://blog.csdn.net/weixin_42037083/article/details/137102858)

要在容器内git，不然会出现uid不匹配，git不能加sudo否则会触犯git的安全机制

```bash
git clone https://gitee.com/voima/PX4-Autopilot.git  -b v1.14.0
cd PX4-Autopilot/
sudo git checkout v1.14.0
sudo gedit /home/chen/PX4-Autopilot/.gitmodules  # 替换为教程中下载文件的路径
git submodule update --init --recursive
```
账号13076541053

```bash
cd ..
镜像加速下载，脚本配置环境
sudo bash ~/PX4-Autopilot/Tools/setup/ubuntu.sh
```
换源加速
```bash
sudo apt install python3-pip
pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
```
报错
```
ERROR: Invalid requirement: 'matplotlib>=3.0.*': .*
```
```bash
gedit /home/chen/PX4-Autopilot/Tools/setup/requirements.txt
```
改为
```
matplotlib>=3.0
```

以下添加到 `.bashrc`，不同版本px4的gazebo路径不同，以下为1.14.0
```bash
# >>> PX4 initialize >>>
source /home/chen/PX4-Autopilot/Tools/simulation/gazebo-classic/setup_gazebo.bash /home/chen/PX4-Autopilot /home/chen/PX4-Autopilot/build/px4_sitl_default
export ROS_PACKAGE_PATH=$ROS_PACKAGE_PATH:/home/chen/PX4-Autopilot
export ROS_PACKAGE_PATH=$ROS_PACKAGE_PATH:/home/chen/PX4-Autopilot/Tools/simulation/gazebo-classic/sitl_gazebo-classic
# <<< PX4 initialize <<<
```

```bash
sudo apt install python3-pip
pip3 install kconfiglib
pip3 install --user jinja2
pip3 install --user jsonschema
sudo apt-get update
sudo apt-get install libgstreamer1.0-0 gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly gstreamer1.0-libav gstreamer1.0-doc gstreamer1.0-tools gstreamer1.0-x gstreamer1.0-alsa gstreamer1.0-gl gstreamer1.0-gtk3 gstreamer1.0-qt5 gstreamer1.0-pulseaudio libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev
```

验证安装  
权限问题：
```bash
sudo chown -R chen:chen /home/chen/PX4-Autopilot
```
需要联网检查git
```bash
cd PX4-Autopilot/
make px4_sitl_default gazebo
```
起飞：
```bash
commander takeoff
```
降落：
```bash
commander land
```
报错
```
FAILED: src/lib/version/build_git_version.h
```

解锁文件夹
```bash
sudo chown -R chen PX4-Autopilot
```

---

## 安装MAVROS

[https://blog.csdn.net/weixin_42037083/article/details/137102858](https://blog.csdn.net/weixin_42037083/article/details/137102858)

```bash
sudo apt-get install ros-noetic-mavros ros-noetic-mavros-extras
```

---

## 安装geographiclib

[https://blog.csdn.net/zlm2004/article/details/144935740](https://blog.csdn.net/zlm2004/article/details/144935740)

```bash
cp -r GeographicLib /usr/share
```

/usr/share/GeographicLib/
```
├── geoids/          # 高程模型（Geoids）数据集目录
│   ├── egm84-5     # 示例：EGM84 高程模型（5' 分辨率）
│   ├── egm96-5     # 你安装的 EGM96-5 数据集（5' 分辨率）
│   
│
├── gravity/         # 重力模型（Gravity）数据集目录
│   ├── egm96       # EGM96 地球重力模型
│  
│
├── magnetic/        # 地磁模型（Magnetic）数据集目录
    ├── emm2015     # EMM2015 地球磁场模型
```

---

## 验证MAVROS安装

```bash
sudo apt install python3-roslaunch
```

```bash
gedit /home/chen/PX4-Autopilot/launch/mavros_posix_sitl.launch
```

```xml
<arg name="world" default="/home/chen/PX4-Autopilot/Tools/simulation/gazebo-classic/sitl_gazebo-classic/worlds/empty.world"/>
<arg name="sdf" default="/home/chen/PX4-Autopilot/Tools/simulation/gazebo-classic/sitl_gazebo-classic/models/$(arg vehicle)/$(arg vehicle).sdf"/>
```

```bash
export ROS_PACKAGE_PATH=$ROS_PACKAGE_PATH:/home/chen/PX4-Autopilot
export ROS_PACKAGE_PATH=$ROS_PACKAGE_PATH:/home/chen/PX4-Autopilot/Tools/simulation/gazebo-classic/sitl_gazebo-classic
roslaunch /home/chen/PX4-Autopilot/launch/mavros_posix_sitl.launch
```

新终端
```bash
rostopic echo mavros/state
```