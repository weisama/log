# 鲁班猫2使用SDK编译的Ubuntu22.04+ROS 2 Humble  
## Cartographer + 镭神 N10 建图全流程日志

---

### 激光里程计方案

#### laser_scan_matcher（失败，TF 超时）
```bash
sudo apt-get install build-essential cmake libgsl-dev
cd ~
git clone https://github.com/AlexKarvaev/csm
mkdir csm/build && cd csm/build
cmake .. && make -j8 && sudo make install && sudo ldconfig

cd ~/slam_ws/src
git clone https://github.com/AlexKarvaev/ros2_laser_scan_matcher
# 修改 laser_frame 默认值 laser -> laser_link
mousepad src/laser_scan_matcher.cpp
colcon build --packages-select ros2_laser_scan_matcher

# 运行
ros2 launch tf tf_broadcaster.launch.py
ros2 launch lslidar_driver lslidar_launch.py
ros2 run ros2_laser_scan_matcher laser_scan_matcher
# 卡 TF
```

---

#### rf2o_laser_odometry（可用）
```bash
sudo apt install libboost-all-dev
cd ~/slam_ws/src
git clone https://github.com/MAPIRlab/rf2o_laser_odometry
```

**rf2o_laser_odometry不发布 odom -> base_link，使得odom不被其漂移干扰**

`mousepad ~/slam_ws/src/rf2o_laser_odometry/launch/rf2o_laser_odometry.launch.py`

```bash
                    'laser_scan_topic' : '/scan',
                    'odom_topic' : '/odom_rf2o',    # 发布的坐标话题
                    'publish_tf' : True,           # 是否发布 odom -> base_link
                    'base_frame_id' : 'base_link',  # 机器人坐标系
                    'odom_frame_id' : 'odom',       # 坐标话题的坐标系
                    'init_pose_from_topic' : '',    # 初始位姿
                    'freq' : 10.0                   # 运行频率保持和雷达一致
```

**未知原因源码计算出的xy反向了，修改为正确方向**

`mousepad ~/slam_ws/src/rf2o_laser_odometry/src/CLaserOdometry2DNode.cpp`

```bash
odom.pose.pose.position.x = -rf2o_ref.robot_pose_.translation()(0);  // 添加负号
odom.pose.pose.position.y = -rf2o_ref.robot_pose_.translation()(1);  // 添加负号
// ...
odom_trans.transform.translation.x = -rf2o_ref.robot_pose_.translation()(0);  // 添加负号
odom_trans.transform.translation.y = -rf2o_ref.robot_pose_.translation()(1);  // 添加负号

mousepad ~/slam_ws/src/rf2o_laser_odometry/src/CLaserOdometry2D.cpp
RCLCPP_INFO(get_logger(), "Robot-base odom [x,y,yaw]=[%f %f %f]",
                -robot_pose_.translation()(0),
                -robot_pose_.translation()(1),
                rf2o::getYaw(robot_pose_.rotation()));
```

```bash
cd ~/slam_ws
colcon build --packages-select rf2o_laser_odometry
```

```bash
# 运行
ros2 launch tf tf_broadcaster.launch.py
ros2 launch lslidar_driver lslidar_launch.py
ros2 launch rf2o_laser_odometry rf2o_laser_odometry.launch.py
ros2 topic echo /odom_rf2o
rviz2 -d ~/slam_ws/src/lslidar_driver/rviz/lslidar.rviz
```
---

### Cartographer 建图，融合了rf2o_laser_odometry里程计
[教程](https://blog.csdn.net/m262914/article/details/141223818）

```bash
# 码源编译安装过于麻烦，故舍弃，改为apt安装
sudo apt install ros-humble-cartographer ros-humble-cartographer-ros
```

```bash
cd ~/slam_ws/src
ros2 pkg create cartographer_navigation --build-type ament_cmake --dependencies rclcpp cartographer_ros
mkdir -p ~/slam_ws/src/cartographer_navigation/launch ~/slam_ws/src/cartographer_navigation/config
```

#### 配置

**数据参考轮趣科技**

`mousepad ~/slam_ws/src/cartographer_navigation/config/mylaser.lua`

```lua
include "map_builder.lua"
include "trajectory_builder.lua"

options = {
  map_builder = MAP_BUILDER,
  trajectory_builder = TRAJECTORY_BUILDER,
  
  -- 坐标系设置
  map_frame = "map",  -- 全局地图坐标系，发布tf变换的起始点，坐标系A
  tracking_frame = "base_link",  -- SLAM算法跟踪的机器人基座坐标系
  published_frame = "base_link",  -- 通常是base_link，发布tf变换的结束点，坐标系C
  odom_frame = "odom",  -- 发布tf变换的中点，坐标系B
  
  -- 功能开关
  provide_odom_frame = true,  -- 是否添加中间点B，A->C 或 A->B->C
  publish_frame_projected_to_2d = true,  -- 将3D位姿投影到2D，忽略俯仰角带来的地图偏差
  use_odometry = true,  -- 是否使用外部里程计数据
  use_nav_sat = false,  -- 是否使用GPS数据
  use_landmarks = false,  -- 是否使用路标点
  
  -- 传感器数据设置
  num_laser_scans = 1,  -- 订阅的单线激光雷达话题数量
  num_multi_echo_laser_scans = 0,  -- 订阅的多回波激光雷达话题数量
  num_subdivisions_per_laser_scan = 1,  -- 每帧激光数据分割的子帧数
  num_point_clouds = 0,  -- 订阅的点云话题数量
  
  -- 超时和发布频率设置
  lookup_transform_timeout_sec = 0.2,  -- TF变换查找超时时间（秒）
  submap_publish_period_sec = 0.3,  -- 子地图发布周期
  pose_publish_period_sec = 5e-3,  -- 位姿发布周期（高频）
  trajectory_publish_period_sec = 30e-3,  -- 轨迹发布周期
  
  -- 数据采样率设置（1.0表示使用所有数据）
  rangefinder_sampling_ratio = 1.,  -- 测距仪数据采样率
  odometry_sampling_ratio = 1.,  -- 里程计数据采样率
  fixed_frame_pose_sampling_ratio = 1.,  -- 固定坐标系位姿采样率
  imu_sampling_ratio = 1.,  -- IMU数据采样率
  landmarks_sampling_ratio = 1.,  -- 路标数据采样率
}

MAP_BUILDER.use_trajectory_builder_2d = true  -- 启用2D轨迹构建器，适用于平面移动机器人

-- 2D轨迹构建器参数
TRAJECTORY_BUILDER_2D.min_range = 0.3  -- 激光雷达最小有效测量距离
TRAJECTORY_BUILDER_2D.max_range = 5.0  -- 激光雷达最大有效测量距离
TRAJECTORY_BUILDER_2D.missing_data_ray_length = 10.  -- 缺失数据的射线长度
TRAJECTORY_BUILDER_2D.use_imu_data = false  -- 是否使用IMU数据
TRAJECTORY_BUILDER_2D.use_online_correlative_scan_matching = true  -- 是否使用在线相关扫描匹配



-- 运动滤波参数
TRAJECTORY_BUILDER_2D.motion_filter.max_angle_radians = math.rad(0.1)  -- 位姿更新最小角度阈值

-- Ceres扫描匹配器参数
TRAJECTORY_BUILDER_2D.ceres_scan_matcher.translation_weight = 2e2  -- 平移项的优化权重，值越大对平移误差越敏感
TRAJECTORY_BUILDER_2D.ceres_scan_matcher.ceres_solver_options.max_num_iterations = 20  -- 最大迭代次数，影响优化精度和耗时
TRAJECTORY_BUILDER_2D.ceres_scan_matcher.rotation_weight = 600  -- 显著提高，加强对先验旋转的约束###############

TRAJECTORY_BUILDER_2D.num_accumulated_range_data = 1  -- 累积多帧数据，改善高速移动时的数据质量
TRAJECTORY_BUILDER_2D.voxel_filter_size = 0.05  -- 较小的体素提供更精细的地图但计算量更大
TRAJECTORY_BUILDER_2D.submaps.num_range_data = 45  -- 每个子地图包含的雷达数据帧数，值小更新快，值大更稳定
MAP_BUILDER.num_background_threads = 4  -- 后台处理线程数，CPU核心数

-- 位姿图优化参数
POSE_GRAPH.constraint_builder.min_score = 0.65  -- 闭环检测的最小匹配分数，值高减少错误闭环，值低更容易检测到闭环
POSE_GRAPH.constraint_builder.global_localization_min_score = 0.7  -- 全局定位的最小匹配分数

-- 采样率参数
POSE_GRAPH.global_sampling_ratio = 0.001  -- 全局约束采样率
POSE_GRAPH.constraint_builder.sampling_ratio = 0.001  -- 约束构建采样率

-- 优化频率设置
POSE_GRAPH.optimize_every_n_nodes = 50  -- 每N个节点执行一次优化,越小地图更新越频繁

return options
```

#### Launch

`mousepad ~/slam_ws/src/cartographer_navigation/launch/cartographer.launch.py`

```python
from launch import LaunchDescription
from launch.actions import DeclareLaunchArgument, IncludeLaunchDescription
from launch.conditions import IfCondition, UnlessCondition
from launch.substitutions import LaunchConfiguration
from launch_ros.actions import Node, SetRemap
from launch_ros.substitutions import FindPackageShare
from launch.launch_description_sources import PythonLaunchDescriptionSource
import os

def generate_launch_description():

    ## ***** Launch arguments *****
    # 定义是否使用仿真时间参数 (默认为False，实际机器人部署时通常设为False)
    use_sim_time_arg = DeclareLaunchArgument('use_sim_time', default_value = 'False')

    ## ***** File paths ******
    # 获取cartographer_ros包的共享路径
    pkg_share = FindPackageShare('cartographer_navigation').find('cartographer_navigation')

    # 配置文件的完整路径
    config_dir = os.path.join(pkg_share, 'config')
    config_file = os.path.join(config_dir, 'mylaser.lua')

    # Cartographer SLAM主节点
    cartographer_node = Node(
        package = 'cartographer_ros',
        executable = 'cartographer_node',
        arguments = [
            '-configuration_directory', config_dir,  # 使用自定义配置目录
            '-configuration_basename', 'mylaser.lua'],  # 使用自定义配置文件
        remappings = [
            ('scan', 'scan'),
            ('odom', '/odom_rf2o')],  # 添加话题重映射确保订阅正确的话题
        output = 'screen'
        )

    # Cartographer占用网格节点
    cartographer_occupancy_grid_node = Node(
        package = 'cartographer_ros',
        executable = 'cartographer_occupancy_grid_node',
        parameters = [
            {'use_sim_time': False},  # 硬编码为False (注意：应使用参数更灵活)
            {'resolution': 0.05}],    # 设置地图分辨率为5cm
        )
    
    # 构建启动描述
    return LaunchDescription([
        use_sim_time_arg,  # 时间参数
        cartographer_node,           # SLAM核心节点
        cartographer_occupancy_grid_node,  # 占用网格生成节点
    ])

```

#### package.xml

`mousepad ~/slam_ws/src/cartographer_navigation/package.xml`

```bash
<?xml version="1.0"?>
<?xml-model href="http://download.ros.org/schema/package_format3.xsd" schematypelayout="1.0"?>
<package format="3">
  <name>cartographer_navigation</name>
  <version>0.0.0</version>
  <description>Cartographer navigation with custom configuration</description>
  <maintainer email="you@example.com">Your Name</maintainer>
  <license>Apache-2.0</license>

  <buildtool_depend>ament_cmake</buildtool_depend>

  <depend>rclcpp</depend>
  <depend>cartographer_ros</depend>
  <depend>launch</depend>
  <depend>launch_ros</depend>

  <export>
    <build_type>ament_cmake</build_type>
  </export>
</package>
```

#### CMakeLists.txt

`mousepad ~/slam_ws/src/cartographer_navigation/CMakeLists.txt`

```bash
cmake_minimum_required(VERSION 3.8)
project(cartographer_navigation)

if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

find_package(ament_cmake REQUIRED)
find_package(rclcpp REQUIRED)
find_package(cartographer_ros REQUIRED)

# 安装launch文件
install(
  DIRECTORY launch
  DESTINATION share/${PROJECT_NAME}
)

# 安装配置文件
install(
  DIRECTORY config
  DESTINATION share/${PROJECT_NAME}
)

ament_package()
```

#### 编译运行

```bash
cd ~/slam_ws
colcon build --packages-select cartographer_navigation
```

```bash
ros2 launch tf tf_broadcaster.launch.py
ros2 launch lslidar_driver lslidar_launch.py
rviz2 -d ~/slam_ws/src/lslidar_driver/rviz/lslidar.rviz
ros2 launch rf2o_laser_odometry rf2o_laser_odometry.launch.py
ros2 launch cartographer_navigation cartographer.launch.py
```

---

## SLAM_TOOLBOX

[ROS官方教程](https://docs.nav2.org/tutorials/docs/navigation2_with_slam.html)

```bash
sudo apt install ros-$ROS_DISTRO-slam-toolbox
```

```bash
cd ~/slam_ws/src
ros2 pkg create --build-type ament_cmake karto_slam
mkdir -p karto_slam/launch karto_slam/config
```

`mousepad ~/slam_ws/src/karto_slam/launch/online_async_launch.py`

```bash
import os

from launch import LaunchDescription
from launch.actions import DeclareLaunchArgument
from launch.substitutions import LaunchConfiguration
from launch_ros.actions import Node
from ament_index_python.packages import get_package_share_directory


def generate_launch_description():
    use_sim_time = LaunchConfiguration('use_sim_time')
    slam_params_file = LaunchConfiguration('slam_params_file')
    scan_topic = LaunchConfiguration('scan_topic')

    declare_use_sim_time_argument = DeclareLaunchArgument(
        'use_sim_time',
        default_value='false',
        description='Use simulation/Gazebo clock')
    
    declare_slam_params_file_cmd = DeclareLaunchArgument(
        'slam_params_file',
        default_value=os.path.join(get_package_share_directory("karto_slam"),
                                   'config', 'my_async.yaml'),
        description='Full path to the ROS2 parameters file to use for the slam_toolbox node')
    
    declare_scan_topic_cmd = DeclareLaunchArgument(
        'scan_topic',
        default_value='/scan',
        description='Laser scan topic name')

    start_async_slam_toolbox_node = Node(
        parameters=[
          slam_params_file,
          {
            'use_sim_time': use_sim_time,
            'scan_topic': scan_topic
          }
        ],
        package='slam_toolbox',
        executable='async_slam_toolbox_node',
        name='slam_toolbox',
        output='screen')

    ld = LaunchDescription()

    ld.add_action(declare_use_sim_time_argument)
    ld.add_action(declare_slam_params_file_cmd)
    ld.add_action(declare_scan_topic_cmd)
    ld.add_action(start_async_slam_toolbox_node)

    return ld
```

`mousepad ~/slam_ws/src/karto_slam/config/my_async.yaml`

```bash
slam_toolbox:
  ros__parameters: # Plugin params
    
    # Ceres 求解器插件配置
    solver_plugin: solver_plugins::CeresSolver
    ceres_linear_solver: SPARSE_NORMAL_CHOLESKY  # 线性求解器类型
    ceres_preconditioner: SCHUR_JACOBI          # 预条件子类型
    ceres_trust_strategy: LEVENBERG_MARQUARDT   # 信任区域策略
    ceres_dogleg_type: TRADITIONAL_DOGLEG       # Dogleg 算法类型
    ceres_loss_function: None                   # 损失函数（None 表示不使用）

    # ROS 坐标系和话题配置
    odom_frame: odom		   # 里程计坐标系
    map_frame: map                 # 地图坐标系  
    base_frame: base_link          # 机器人基坐标系
    scan_topic: /scan              # 激光扫描数据话题
    odom_topic: /odom_rf2o          # 自定义里程计话题
    use_odom: true                # 启用里程计

    # 运行模式选择
    mode: mapping  # 建图模式（可选：mapping / localization）
    
    # 地图初始化配置（互斥选项）
    #map_file_name: test_steve                # 要加载的地图文件名
    # map_start_pose: [0.0, 0.0, 0.0]         # 地图起始位姿
    #map_start_at_dock: true                  # 是否从停靠点开始

    # 系统配置
    debug_logging: false           # 是否启用调试日志
    throttle_scans: 1              # 扫描数据节流系数（每n帧处理1帧）
    transform_publish_period: 0.02 # 坐标变换发布周期（秒），0表示不发布
    map_update_interval: 5.0       # 地图更新间隔（秒）
    resolution: 0.05               # 地图分辨率（米/像素）
    min_laser_range: 0.2           # 激光最小有效距离（米）
    max_laser_range: 20.0          # 激光最大有效距离（米）
    minimum_time_interval: 0.5     # 最小处理时间间隔（秒）
    transform_timeout: 0.2         # 坐标变换超时时间（秒）
    tf_buffer_duration: 30.        # TF 缓冲区持续时间（秒）
    stack_size_to_use: 40000000    # 堆栈大小（用于序列化大地图）
    enable_interactive_mode: true  # 是否启用交互模式

    # 通用SLAM参数
    use_scan_matching: true        # 是否使用扫描匹配
    use_scan_barycenter: true      # 是否使用扫描重心
    minimum_travel_distance: 0.5   # 最小移动距离（米）后才处理新扫描
    minimum_travel_heading: 0.5    # 最小转动角度（弧度）后才处理新扫描
    scan_buffer_size: 10           # 扫描缓冲区大小
    scan_buffer_maximum_scan_distance: 10.0  # 扫描缓冲区最大扫描距离

    # 扫描匹配参数
    link_match_minimum_response_fine: 0.1      # 精细匹配最小响应值
    link_scan_maximum_distance: 1.5            # 扫描链接最大距离
    loop_search_maximum_distance: 3.0          # 回环检测搜索最大距离
    do_loop_closing: true                      # 是否进行回环检测
    loop_match_minimum_chain_size: 10          # 回环匹配最小链长
    loop_match_maximum_variance_coarse: 3.0    # 粗匹配最大方差
    loop_match_minimum_response_coarse: 0.35   # 粗匹配最小响应值
    loop_match_minimum_response_fine: 0.45     # 精细匹配最小响应值

    # 相关性参数 - 普通匹配
    correlation_search_space_dimension: 0.5    # 搜索空间维度
    correlation_search_space_resolution: 0.01  # 搜索空间分辨率
    correlation_search_space_smear_deviation: 0.1  # 搜索空间平滑偏差

    # 相关性参数 - 回环检测
    loop_search_space_dimension: 8.0           # 回环搜索空间维度
    loop_search_space_resolution: 0.05         # 回环搜索空间分辨率  
    loop_search_space_smear_deviation: 0.03    # 回环搜索空间平滑偏差

    # 扫描匹配器参数
    distance_variance_penalty: 0.5             # 距离方差惩罚因子
    angle_variance_penalty: 1.0                # 角度方差惩罚因子
    fine_search_angle_offset: 0.00349          # 精细搜索角度偏移（≈0.2°）
    coarse_search_angle_offset: 0.349          # 粗搜索角度偏移（≈20°）
    coarse_angle_resolution: 0.0349            # 粗搜索角度分辨率（≈2°）
    minimum_angle_penalty: 0.9                 # 最小角度惩罚
    minimum_distance_penalty: 0.5              # 最小距离惩罚
    use_response_expansion: true               # 是否使用响应扩展
```

`mousepad ~/slam_ws/src/karto_slam/package.xml`

```bash
<?xml version="1.0"?>
<?xml-model href="http://download.ros.org/schema/package_format3.xsd" schematypelocation="http://www.ros.org/repos/cfg/list?rosdistro=$ROS_DISTRO&path=package-3.xsd"?>
<package format="3">
  <name>karto_slam</name>
  <version>0.0.0</version>
  <description>Karto SLAM implementation using slam_toolbox</description>
  <maintainer email="user@todo.todo">user</maintainer>
  <license>Apache-2.0</license>

  <buildtool_depend>ament_cmake</buildtool_depend>

  <depend>slam_toolbox</depend>
  <depend>launch</depend>
  <depend>launch_ros</depend>

  <test_depend>ament_lint_auto</test_depend>
  <test_depend>ament_lint_common</test_depend>

  <export>
    <build_type>ament_cmake</build_type>
  </export>
</package>
```

`mousepad ~/slam_ws/src/karto_slam/CMakeLists.txt`

```bash
cmake_minimum_required(VERSION 3.8)
project(karto_slam)

if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

# find dependencies
find_package(ament_cmake REQUIRED)

# install launch files
install(DIRECTORY
  launch
  config
  DESTINATION share/${PROJECT_NAME}/
)

ament_package()
```

### 编译运行
```bash
cd ~/slam_ws
colcon build --packages-select karto_slam
```

```bash
~/run_slam.sh
# 方法1：使用异步SLAM（适合大型地图）
ros2 launch karto_slam online_async_launch.py use_sim_time:=false scan_topic:=/scan
# 方法2：使用同步SLAM（适合实时建图）
ros2 launch karto_slam online_sync_launch.py use_sim_time:=false scan_topic:=/scan

# 分布式通信时本机启动rviz
rviz2 -d ~/lidar_mode.rviz
```










