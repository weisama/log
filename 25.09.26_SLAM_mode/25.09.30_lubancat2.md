# 鲁班猫2（LubanCat-2）开发板基础设置  
[官方文档](https://doc.embedfire.com/linux/rk356x/quick_start/zh/latest/index.html)

## SLAM 选型  
[Gitee Wiki](https://gitee.com/gwmunan/ros2/wikis/pages)

---

## 基础配置

### 鲁班猫使用非 SD 卡烧录  
[烧录教程](https://doc.embedfire.com/linux/rk356x/quick_start/zh/latest/quick_start/flash_img/flash_img.html)

### SD卡镜像下载（RK3568，仅 Ubuntu 20，仅支持 ROS2 基础版）  
[百度网盘](https://pan.baidu.com/s/19t8AZV9SYTdjn2uObBiSGA) 提取码：`hslu`

[SDK 构建文档](https://doc.embedfire.com/linux/rk356x/build_and_deploy/zh/latest/building_image/lubancat_sdk/lubancat_chip_sdk.html)

---

## vmware中ubuntu22使用SDK自行编译ubutnu22-rk3568-lubancat2

> 无法使用Docker容器，原因无法下载ssh

LubanCat_Chip_SDK教程[https://doc.embedfire.com/linux/rk356x/build_and_deploy/zh/latest/building_image/lubancat_sdk/lubancat_chip_sdk.html]

> 注意区分不是LubanCat_Gen_SDK

### 安装 SDK 构建依赖

更新软件源
```bash
sudo wget http://fishros.com/install -O fishros && . fishros
```

安装SDK构建所需要的软件包
```bash
sudo apt install git ssh make gcc libssl-dev liblz4-tool u-boot-tools curl \
expect g++ patchelf chrpath gawk texinfo chrpath diffstat binfmt-support \
qemu-user-static live-build bison flex fakeroot cmake gcc-multilib g++-multilib \
unzip device-tree-compiler python3-pip libncurses5-dev python3-pyelftools dpkg-dev
```

安装repo
```bash
mkdir ~/bin
curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
chmod a+x ~/bin/repo
echo PATH=~/bin:$PATH >> ~/.bashrc
source ~/.bashrc
repo --version
```

### SDK 源码获取

```bash
mkdir ~/LubanCat_SDK
```

切换Python 3 版本
```bash
python -V
ls /usr/bin/python*
sudo ln -sf /usr/bin/python3 /usr/bin/python
python -V
```

SDK在线下载
```bash
cd ~/LubanCat_SDK
# 拉取LubanCat-RK356x系列Linux_SDK
repo init -u https://github.com/LubanCat/manifests.git -b linux -m rk356x_linux_release.xml
```

拉取LubanCat-RK356x系列Linux_SDK，若无网络则SDK离线安装下载
```bash
repo init -u https://github.com/LubanCat/manifests.git -b linux -m lubancat_linux_generic.xml
```

[俩种SDK对比](https://doc.embedfire.com/linux/rk356x/build_and_deploy/zh/latest/building_image/lubancat_sdk/lubancat_sdk_compare.html)

[资源下载](https://doc.embedfire.com/linux/rk356x/quick_start/zh/latest/quick_start/baidu_cloud/baidu_cloud.html#id1)

[百度网盘](https://pan.baidu.com/share/init?surl=9t8AZV9SYTdjn2uObBiSGA)
提取码：hslu

**鲁班猫_瑞芯微系...>8-SDK源码压...>LubanCat...>LubanCat_Linux_rk356x_SDK_20250812.tgz**

将LubanCat_Linux_Generic_SDK简称为LubanCat_Gen_SDK；  
由于LubanCat_Linux_rk356x_SDK和LubanCat_Linux_rk3588_SDK基于同一框架，差异较小，所以统称为LubanCat_Chip_SDK

解压源码

```bash
sudo apt install tar
```

```bash
mkdir -p ~/LubanCat_SDK
mv ~/LubanCat_Linux_rk356x_SDK_*.tgz ~/LubanCat_SDK
cd ~/LubanCat_SDK
tar -xzvf LubanCat_Linux_rk356x_SDK_*.tgz
ls -al
```

检出.repo目录下的git仓库
```bash
.repo/repo/repo sync -l
```

将所有的源码仓库同步到最新版本
```bash
.repo/repo/repo sync -c
```

#### 改变ubuntu分支  
https://github.com/LubanCat/ubuntu
```bash
cd ~/LubanCat_SDK/ubuntu
git pull
git branch -a
git checkout -b ubuntu22.04 origin/ubuntu22.04
git pull
git branch
```

LubanCat_Gen_SDK自动构建
```bash
cd ~/LubanCat_SDK
./build.sh lunch
# 选择 13
./build.sh
```

出现紫色界面选择管脚电压，可以全部选择3v3，如果选择完成后报错，  
可以根据报错信息找到对应设备树文件中的&pmu_io_domains节点中的电压值选择，  
并注意顺序从pmuio2-supply开始。其中vccio_acodec为3v3、vccio_sd为3v3。

```bash
cd ~/LubanCat_SDK/kernel/arch/arm64/boot/dts/rockchip
grep -A 15 "pmu_io_domains" rk3568-lubancat-2.dtsi
```

```
&pmu_io_domains {
	status = "okay";
	pmuio2-supply = <&vcc3v3_pmu>;
	vccio1-supply = <&vccio_acodec>;
	vccio3-supply = <&vccio_sd>;
	vccio4-supply = <&vcc_1v8>;
	vccio5-supply = <&vcc_3v3>;
	vccio6-supply = <&vcc_1v8>;
	vccio7-supply = <&vcc_3v3>;
};
```

```
pmuio2-supply    → 选择 3v3    (对应 vcc3v3_pmu)
pmuio1-supply    → 选择 3v3    (设备树中未明确，但通常为3.3V)
vccio1-supply    → 选择 3v3    (对应 vccio_acodec)
vccio2-supply    → 选择 3v3    (设备树中未明确，选择3.3V)
vccio3-supply    → 选择 3v3    (对应 vccio_sd)
vccio4-supply    → 选择 1v8    (对应 vcc_1v8)
vccio5-supply    → 选择 3v3    (对应 vcc_3v3)
vccio6-supply    → 选择 1v8    (对应 vcc_1v8)
vccio7-supply    → 选择 3v3    (对应 vcc_3v3)
```

> 但是文档说全选3v3，不报错即可
### 故全部选择3v3

编译成功后
```
~/LubanCat_SDK/rockdev/update.img
```

清除构建，然后可以重新构建
```bash
./build.sh cleanall
```

---

## 默认密码

| 用户   | 用户名 | 密码   |
| ------ | ------ | ------ |
| 普通   | cat    | temppwd |
| 管理员 | root   | root   |

### 修改密码为 `123`
```bash
su root
passwd root
passwd cat
```

---

## 网络共享（无 Wi-Fi 模块）

参考：[Ubuntu 共享网络](https://blog.csdn.net/shuimanting520/article/details/125597100)

- 地址：`10.42.0.4`
- 掩码：`24`
- 网关：`10.42.0.1`
- DNS：`10.42.0.1`

### 无屏幕sd卡读卡器操作
```bash
### sd卡系统内
ls etc/netplan/
sudo gedit etc/netplan/01-netcfg.yaml
```

```bash
network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      addresses:
        - 10.42.0.4/24
      gateway4: 10.42.0.1
      nameservers:
        addresses: [10.42.0.1]
```

```bash
ssh -Y cat@10.42.0.4
```

> 设置完成后主从均需重启，每次开机主机重新开关有线连接。

---

## 基础连接

```bash
sudo wget http://fishros.com/install -O fishros && . fishros
sudo apt update && sudo apt upgrade
sudo apt install -y gedit git nano ros-$ROS_DISTRO-rviz2
```

### SSH 连接

鲁班猫端：
```bash
sudo apt install -y openssh-server
sudo systemctl enable --now ssh
ip a
```

本机端：
```bash
ssh -Y cat@10.42.0.4
```

### 本机免密登录
```bash
# 查看是否已有密匙
cat ~/.ssh/id_rsa
# 没有则生成密匙
ssh-keygen -t rsa -b 4096 -C "3329176757@qq.com"
# 设置免密登录
ssh-copy-id -i ~/.ssh/id_rsa.pub cat@10.42.0.4
```

### X11 转发

鲁班猫：
```bash
sudo apt install -y xauth x11-apps
sudo nano /etc/ssh/sshd_config
```

```text
X11Forwarding yes
X11DisplayOffset 10
X11UseLocalhost no
```

```bash
sudo systemctl restart ssh
```

本机：
```bash
sudo apt install -y xauth
ssh -Y cat@10.42.0.4
echo $DISPLAY
xeyes
```

---

## 清理空间（无 SD 卡仅 7G）

```bash
sudo apt-get purge -y chromium-x11 snapd fonts-noto-cjk ibus-data mesa-vdpau-drivers libqt5webkit5
sudo apt-get autoremove
```

---

## 编译功能包时运行内存2g太小，划分4g交换空间

```bash
# 确定有充足空间
df -h /
# 检查当前交换空间
free -h
# 创建4g交换空间
sudo dd if=/dev/zero of=/swapfile bs=1M count=4096
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
# 再次验证交换空间
free -h
```

---

## ROS2 分布式通信

> 需 ROS 版本一致，暂放弃。

### 本机测试
```bash
ping 10.42.0.4
```

### 鲁班猫关闭防火墙
```bash
sudo apt install -y ufw
sudo ufw disable
```

### 环境变量

鲁班猫 `~/.bashrc`：
```bash
source ~/slam_ws/install/setup.bash
export ROS_DOMAIN_ID=0
export ROS_IP=10.42.0.4
export ROS_LOCALHOST_ONLY=0
```

本机 `~/.bashrc`：
```bash
source /opt/ros/jazzy/setup.bash
export ROS_DOMAIN_ID=0
export ROS_IP=10.42.0.1
```

### 测试通信

鲁班猫发布：
```bash
ros2 topic pub /test_topic std_msgs/String "data: 'Hello from LubanCat'" --rate 1
```

本机查看：
```bash
ros2 topic list
ros2 topic echo /test_topic
```
