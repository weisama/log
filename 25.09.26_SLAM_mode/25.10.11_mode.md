# 第一版模块的基础配置

[KICKPI官方的RK3568_K1B](https://github.com/tan-zhihao1/kickpi-book/blob/master/rk356x-rk3588/zh/01-%E4%B8%BB%E6%9D%BF%E4%BB%8B%E7%BB%8D/03-KICKPI-K1B%E7%A1%AC%E4%BB%B6%E4%BB%8B%E7%BB%8D.md)

---

## 自行编译SDK出ubuntu22系统
[网盘链接](https://pan.baidu.com/s/1L9WfKVmkcfLkW5lpge0mfg?pwd=3aic)

**使用PC-ubuntu22编译**
#### 依赖
```bash
sudo apt install git bc bison build-essential curl flex libsdl1.2-dev 
sudo apt install g++-multilib gcc-multilib gnupg gperf libncurses5-dev libncurses5
sudo apt install imagemagick lib32ncurses5-dev lib32readline-dev squashfs-tools 
sudo apt install lib32z1-dev liblz4-tool xsltproc libssl-dev libwxgtk3.0-gtk3-dev libgmp-dev libmpc-dev
sudo apt install libxml2 libxml2-utils schedtool lzop pngcrush rsync 
sudo apt install yasm zip zlib1g-dev  device-tree-compiler 
sudo apt install python2 python3 pip
sudo apt install python-pip gawk openjdk-8-jdk u-boot-tools patchelf expect
sudo pip install pyelftools
sudo ln -s /usr/bin/python2 /usr/bin/python

sudo apt-get install binfmt-support qemu-user-static --reinstall
```

#### 网盘下载官方rootfs放在指定文件并重命名
`ls ~/rk356x-linux/ubuntu/ubuntu-rootfs.img`

```bash
# 恢复SDK
cd ~/rk356x-linux
git reset --hard

# 首次编译，设置
./build.sh lunch
# 一键编译
./build.sh
# 清除编译，然后可以重新编译
./build.sh cleanall

# 编译成功
ls ~/home/chen/rk356x-linux/rockdev/update-rk3568-kickpi-k1b*

# u盘中打开终端
sudo cp /home/chen/rk356x-linux/rockdev/update-rk3568-kickpi-k1b* ./
```

[系统烧录教程](https://github.com/tan-zhihao1/kickpi-book/blob/master/rk356x-rk3588/zh/03-%E9%95%9C%E5%83%8F%E7%83%A7%E5%BD%95/02-USB%E7%BA%BF%E7%83%A7%E5%BD%95.md)

上电后绿灯恒亮表示电源正常，蓝灯闪烁表示系统运行

---

## 编译ubuntu22,使用lubancat2在ubuntu22编译出的rootfs，其余步骤不变

板子的设置在以下路径

`/home/chen/rk356x-linux/device/rockchip/.chips/rk3566_rk3568/rockchip_rk3568_kickpi_k1b_ubuntu_defconfig`

Uboot与设备树相关，Kernel是系统内核同时兼容22和20，与设备树相关，Buildroot关系到系统的软件等，与设备树无关且决定ubuntu版本

**故编译buildroot得到ubuntu22版的rootfs即可，其他Uboot和Kernel不变**

官方SDK使用buildroot编译rootfs，根据原本一键编译，需将rootfs放在~/rk356x-linux/ubuntu/ubuntu-rootfs.img

**故使用lubancat2在ubuntu22编译出的rootfs代替原本网盘下载的**

将/home/chen/LubanCat_SDK/ubuntu/ubuntu-lite-rootfs.img重命名放置在~/rk356x-linux/ubuntu/ubuntu-rootfs.img

```bash
# 清除编译，然后可以重新编译
./build.sh cleanall
# 首次编译，设置
./build.sh lunch
# 一键编译
./build.sh

# 编译成功
ls ~/home/chen/rk356x-linux/rockdev/update-rk3568-kickpi-k1b*
```

[使用官方推荐的串口调试连接](https://github.com/tan-zhihao1/kickpi-book/blob/master/rk356x-rk3588/zh/02-%E5%85%A5%E9%97%A8%E5%BF%85%E8%AF%BB/02-%E5%BF%AB%E9%80%9F%E4%BD%BF%E7%94%A8.md)

---

## 编译出ubuntu22的rootfs的尝试，未成功，暂时保留

```bash
gedit ~/rk356x-linux/buildroot/fs/ext2/ext2.mk

wget https://cdimage.ubuntu.com/ubuntu-base/releases/22.04/release/ubuntu-base-22.04-base-arm64.tar.gz
mkdir -p ~/rk356x-linux/rootfs_ubuntu22
tar xf ubuntu-base-22.04-base-arm64.tar.gz -C ~/rk356x-linux/rootfs_ubuntu22


# 进入 rootfs_ubuntu22
cd ~/rk356x-linux/rootfs_ubuntu22

# 复制基础文件到 fs-overlay
cp -r bin/* ~/rk356x-linux/buildroot/board/rockchip/rk3566_rk3568/fs-overlay/usr/bin/
cp -r sbin/* ~/rk356x-linux/buildroot/board/rockchip/rk3566_rk3568/fs-overlay/usr/sbin/
cp -r lib/* ~/rk356x-linux/buildroot/board/rockchip/rk3566_rk3568/fs-overlay/lib/
cp -r usr/* ~/rk356x-linux/buildroot/board/rockchip/rk3566_rk3568/fs-overlay/usr/


单独编译Uboot
./build.sh uboot
镜像生成目录：rockdev/uboot.img

单独编译Kernel
./build.sh kernel
镜像生成目录：rockdev/boot.img

单独编译Buildroot
./build.sh buildroot
镜像生成目录：rockdev/rootfs.img

buildroot配置
./build.sh menuconfig
```

---

## eMMC分区不合理，根目录扩大

```bash
# 查看
lsblk
df -h
lsblk -f

#扩大根目录
sudo resize2fs /dev/mmcblk0p6
df -h
```

---

**系统可以启动但是内核头文件路径错误**

**该操作错误，并不能简单复制内核头文件，因为版本不一致**
```bash
# 查看内核头文件
ls /lib/modules
# 可见
5.10.160  5.15.0-157-generic

# 内核版本是5.10.160，但是其文件夹为空，而头文件在5.15.0-157-generic内
uname -r
ls /lib/modules/5.15.0-157-generic/build
ls /lib/modules/5.10.160/build

# 复制内核头文件到正确的文件下
sudo cp -rf /lib/modules/5.15.0-157-generic/build/* /lib/modules/5.10.160/build
```
**该操作错误，并不能简单复制内核头文件，因为版本不一致**

#### 成功解决内核头文件问题

**正确思路是从官方sdk编译出的ubuntu20镜像解包出rootfs，使用里面5.10.160版本的内核**

**后续从官方了解到他们的镜像是没有内核头文件的，该步骤其实是修复了驱动**

```bash
uname -r
ls /lib/modules

# 查看存储设备
lsblk
# 挂载sd卡
sudo mkdir -p /mnt/tf
sudo mount /dev/mmcblk1p1 /mnt/tf
cd /mnt/tf
ls

# 复制内核头文件
sudo cp -rf ./modules /lib
ls /lib/modules
```

```bash
# 加载并测试网卡驱动
sudo modprobe RTL8822CS

sudo apt update
sudo apt install iw wireless-tools

sudo ip link set wlan0 up
sudo iw dev wlan0 scan | grep SSID
```

---

## 设置有线网络，进行ssh连接

```bash
# 查看存储设备
lsblk

# 挂载sd卡
sudo mkdir -p /mnt/tf
sudo mount /dev/mmcblk1p1 /mnt/tf

# 复制网络设置
cd /mnt/tf
ls
sudo cp ./01-eth0-static.yaml /etc/netplan/01-eth0-static.yaml
sudo chmod 644 /etc/netplan/01-eth0-static.yaml
sudo chown root:root /etc/netplan/01-eth0-static.yaml
ls /etc/netplan
sudo rm /etc/netplan/01-network-manager-all.yaml

# 应用
sudo netplan apply
```

```bash
ip link

# 可见eth0正常
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: dummy0: <BROADCAST,NOARP> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether 46:cd:bc:10:f2:be brd ff:ff:ff:ff:ff:ff
3: eth0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc mq state DOWN mode DEFAULT group default qlen 1000
    link/ether d2:6e:70:05:af:ea brd ff:ff:ff:ff:ff:ff

sudo systemctl status NetworkManager
# 可见系统现在由 NetworkManager 管理网络

# 设置有线连接
sudo nano /etc/netplan/01-eth0-static.yaml

network:
  version: 2
  renderer: networkd
  ethernets:
    eth0:
      addresses:
        - 10.42.0.4/24
      routes:
        - to: default
          via: 10.42.0.1
      nameservers:
        addresses:
          - 10.42.0.1

# 应用
sudo chmod 644 /etc/netplan/01-eth0-static.yaml
sudo chown root:root /etc/netplan/01-eth0-static.yaml

sudo netplan apply
```

#### 重启到ubuntu系统，网口网线连接板子，尝试ssh连接

```bash
# 可见网口的网络上有设备
ip addr
ip route
sudo arp-scan --interface=enp45s0 --localnet
sudo ethtool enp45s0
```

```bash
# 尝试ssh连接
ssh -Y cat@10.42.0.4

# 测试上网，若失败再次重启本机和板子
ping baidu.com
```

---

## 连接wifi

**校园网wifi**

```bash
# 设置开机加载网卡驱动
sudo sh -c 'echo "RTL8822CS" >> /etc/modules'
```

**要先让板子非静态ip连上后，再固定使用被分配的ip**

```bash
# 设置网络连接
ls /etc/NetworkManager/system-connections
sudo nano /etc/NetworkManager/system-connections/SUSTech-802.1x.nmconnection
```

```bash
[connection]
id=SUSTech-802.1x
uuid=ae11fc32-b271-4e38-bb6b-c77b483897d4
type=wifi
interface-name=wlan0

[wifi]
mode=infrastructure
ssid=SUSTech-802.1x

[wifi-security]
auth-alg=open
key-mgmt=wpa-eap

[802-1x]
eap=ttls
identity=12532850
password=abc8227181
phase2-auth=mschapv2

[ipv4]
method=manual
addresses=10.28.193.22/14
gateway=10.31.255.254
dns=8.8.8.8;114.114.114.114;

[ipv6]
addr-gen-mode=stable-privacy
method=auto

[proxy]
```

```bash
sudo chown root:root /etc/NetworkManager/system-connections/SUSTech-802.1x.nmconnection
sudo chmod 600 /etc/NetworkManager/system-connections/SUSTech-802.1x.nmconnection
```

---

## 板子一些基础设置

### 修改密码

| 用户   | 用户名 | 密码   |
| ------ | ------ | ------ |
| 普通   | cat    | temppwd |
| 管理员 | root   | root   |

修改密码为 `123`

```bash
su root
passwd root
passwd cat
```

### 本机免密登录
```bash
# 查看是否已有密匙
cat ~/.ssh/id_rsa
# 没有则生成密匙
ssh-keygen -t rsa -b 4096 -C "3329176757@qq.com"
# 设置免密登录
ssh-copy-id -i ~/.ssh/id_rsa.pub cat@10.42.0.4
```

---

## 测试板子功能

[官方功能测试教程](https://github.com/tan-zhihao1/kickpi-book/blob/master/rk356x-rk3588/zh/02-%E5%85%A5%E9%97%A8%E5%BF%85%E8%AF%BB/03-%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95.md)

```bash
# 打开并搜索wifi
sudo modprobe RTL8822CS
sudo ip link set wlan0 up
sudo iw dev wlan0 scan | grep SSID

# 搜索GPU设备
ls -l /dev/dri/

# NPU测试失败
ls -l /dev/rknn*
```

---

## 板子一些基础更新

### 基础更新，软件源和软件更新，安装基础版ROS

```bash
sudo wget http://fishros.com/install -O fishros && . fishros
sudo apt update && sudo apt upgrade
sudo apt install git
sudo apt install nano
sudo apt install mousepad
```

### git新设备设置
```bash
sudo apt install git
git config --global user.name "weisama"
git config --global user.email "33229176757@qq.com"
```

使用现有或生成密匙
```bash
ls ~/.ssh/id_rsa ~/.ssh/id_rsa.pub
ssh-keygen -t rsa -b 4096 -C "3329176757@qq.com"
cat ~/.ssh/id_rsa.pub
```

**登录 GitHub → Settings → SSH and GPG keys → New SSH key**

测试连接
```bash
ssh -T git@github.com
```


### X11 转发

板子：
```bash
sudo apt install -y xauth x11-apps
sudo nano /etc/ssh/sshd_config
```

```text
X11Forwarding yes
X11DisplayOffset 10
X11UseLocalhost no
```

```bash
sudo systemctl restart ssh
```

本机：
```bash
sudo apt install -y xauth
ssh -Y cat@10.42.0.4
echo $DISPLAY
xeyes
```

---

## 编译功能包时运行内存2g太小，划分4g交换空间

```bash
# 确定有充足空间
df -h /
# 检查当前交换空间
free -h
# 创建4g交换空间
sudo dd if=/dev/zero of=/swapfile bs=1M count=4096
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
# 再次验证交换空间
free -h
# 永久生效
sudo cp /etc/fstab /etc/fstab.bak
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

```bash
# 修改交换空间活跃值（可选）
cat /proc/sys/vm/swappiness
echo 'vm.swappiness=80' | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

---

## 镜像的解包和打包

### 解包

下载官方网盘内工具

`rk356x-rk3588_data\5-DevelopmentTools\LinuxPackFirmware\Linux_Pack_Firmware.zip`

解压至~/software/rockdev

```bash
cd ~/software/rockdev
sudo chmod +x *

# 将要解包的img放到~/software/rockdev/下重命名为update.img
ls ~/software/rockdev/update.img

# 解包
./unpack.sh

# 解包成功
ls ~/software/rockdev/output/Image
cd ~/software/rockdev/output/Image
```

```bash
# 将rootfs.img挂载到/mnt/rootfs，没有找到完整内核头文件
sudo mkdir -p /mnt/rootfs
sudo mount -o loop rootfs.img /mnt/rootfs


# 复制内核头文件至sd卡
cd /mnt/rootfs/lib/modules
ls
5.10.160
cp -r 5.10.160 /media/chen/beifen


# 卸载rootfs.img
sudo umount /mnt/rootfs

# sd卡插到板子，将内核头文件覆盖
cd /mnt/sdcard
ls
sudo cp /mnt/sdcard/5.10.160/* /lib/modules/$(uname -r)/build

# 赋予内核权限
sudo chown -R root:root /lib/modules/$(uname -r)/build
sudo chmod -R u+rwX,go+rX /lib/modules/$(uname -r)/build
```

### 打包

```bash
cd ~/software/rockdev
cp -rf output/* ./ 
mv parameter.txt Image/
mv MiniLoaderAll.bin Image/
rm update.img

# 修改rk356x-package-file中路径
gedit rk356x-package-file
#######################
# NAME  PATH
package-file    package-file
parameter       Image/parameter.txt
bootloader      Image/MiniLoaderAll.bin
uboot   Image/uboot.img
misc    Image/misc.img
boot    Image/boot.img
recovery        Image/recovery.img
backup  RESERVED
rootfs  Image/rootfs.img
#######################

# 打包
./rk356x-mkupdate.sh
ls update.img
```

---

## 备份eMMc中系统为镜像

**插入至少64G的sd卡，格式为ext4**

[法一：官方脚本，推荐](https://github.com/tan-zhihao1/kickpi-book/blob/master/rk356x-rk3588/zh/07-LINUX%E7%B3%BB%E7%BB%9F%E5%AE%9A%E5%88%B6/01-Linux%E5%B8%B8%E7%94%A8%E7%B3%BB%E7%BB%9F%E5%AE%9A%E5%88%B6.md#%E5%A4%87%E4%BB%BDrootfs%E7%B3%BB%E7%BB%9F-)

```bash
# 官方脚本拷到sd卡后，挂载sd卡，脚本复制到主目录
lsblk
sudo mkdir -p /mnt/tf
sudo mount /dev/mmcblk1p1 /mnt/tf
cp /mnt/tf/ff_export_rootfs ~/
cd ~

# 执行脚本
cd ~
sudo apt install rsync
sudo chmod +x ./ff_export_rootfs
sudo ./ff_export_rootfs /mnt/tf -t ext4

ls -al /mnt/tf

# 后续可以打包为完整镜像
```

法二：自行导出
```bash
# 查看存储设备
lsblk

# 挂载sd卡
sudo mkdir -p /mnt/tf
sudo mount /dev/mmcblk1p1 /mnt/tf


# 导出eMMc中系统为sd卡内img镜像
sync
# 更快且跳过空白，但可能报错
sudo apt install partclone
sudo partclone.ext4 -c -s /dev/mmcblk0p6 -o /mnt/tf/rootfs.img
# 不挑空白
sudo dd if=/dev/mmcblk0 of=/mnt/tf/lubancat_emmc_backup.img bs=1M status=progress conv=sparse

# 压缩镜像
cd /mnt/tf
ls -al
gzip -k /mnt/tf/lubancat_emmc_backup.img
```


















