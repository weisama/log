# KICKPI官方的RK3568_K1B尝试使用MID360+fast-lio2

---

## 获取点云
BV1PeHCzvEeE  
https://github.com/Livox-SDK/livox_ros_driver2  

### 已通过PC在上位机中设置  
Lidar IP 192.168.1.20  
Points IP 192.168.1.50  
IMU IP 192.168.1.50  
Lidar info IP 192.168.1.50  

### 设置网口连接

`sudo nano /etc/NetworkManager/system-connections/lidar.nmconnection`

```
[connection]
id=lidar
uuid=4f2a2b3c-5678-4d9a-aaa1-8dff56781234
type=ethernet
interface-name=eth0
autoconnect=true

[ethernet]
mac-address-blacklist=

[ipv4]
method=manual
addresses=192.168.1.50/24
never-default=true

[ipv6]
method=ignore

[proxy]
```

```bash
sudo chmod 600 /etc/NetworkManager/system-connections/lidar.nmconnection
sudo nmcli connection reload

# 关掉原本网口，打开雷达网口
sudo nmcli connection down eth0-static
sudo nmcli connection up lidar

# 雷达连接成功
ping 192.168.1.20

# 关掉雷达网口，打开原本网口
sudo nmcli connection down lidar
sudo nmcli connection up eth0-static
```


### 下载安装SDK
```bash
cd ~
git clone https://github.com/Livox-SDK/Livox-SDK2.git 
cd Livox-SDK2
mkdir build && cd build
cmake .. && make -j8
sudo make install
```

### 下载编译功能包
https://github.com/Livox-SDK/livox_ros_driver2  
```bash
cd ~
git clone https://github.com/Livox-SDK/livox_ros_driver2.git  ws_livox/src/livox_ros_driver2
# 配置
cd ~/ws_livox/src/livox_ros_driver2
./build.sh ROS2
```

修改配置文件  
```bash
gedit ~/ws_livox/src/livox_ros_driver2/config/MID360_config.json
```
```
"cmd_data_ip" : "192.168.1.50",
"push_msg_ip": "192.168.1.50",
"point_data_ip": "192.168.1.50",	#同Points IP
"imu_data_ip" : "192.168.1.50",	#同IMU IP

"ip" : "192.168.1.20",		#同Lidar IP
```
修改完编译  
```bash
cd ~/ws_livox
colcon build --packages-select livox_ros_driver2
```

编辑环境变量  
```bash
gedit ~/.bashrc
```
```
source ~/ws_livox/install/setup.bash
```

官方给的启动点云launch  
发布pointcloud2格式数据，自动加载rviz  
```bash
ros2 launch livox_ros_driver2 rviz_MID360_launch.py
```
发布livox定制点云数据  
```bash
ros2 launch livox_ros_driver2 msg_MID360_launch.py
```
Fast-LIO2这些算法通常需要 Livox 自定义格式，RViz可视化使用PointCloud2 标准格式  
格式具体内容见https://github.com/Livox-SDK/livox_ros_driver2  

修改rviz_MID360.launch，默认不启动rviz，改为手动启动  
```bash
gedit ~/ws_livox/src/livox_ros_driver2/launch_ROS2/rviz_MID360_launch.py
```
删除rviz节点相关代码  
```bash
~/ws_livox/src/livox_ros_driver2/build.sh humble
```

启动雷达  
```bash
ros2 launch livox_ros_driver2 rviz_MID360_launch.py
```
手动启动rviz  
```bash
ros2 run rviz2 rviz2 -d ~/ws_livox/src/livox_ros_driver2/config/display_point_cloud_ROS2.rviz
```

---

## FAST-LIO
https://github.com/Ericsii/FAST_LIO_ROS2  
BV1PeHCzvEeE  

```bash
cd ~/ws_livox/src
git clone https://github.com/Ericsii/FAST_LIO_ROS2.git  --recursive
```

下载rosdepc更新组件  
```bash
wget http://fishros.com/install  -O fishros && . fishros
rosdepc update 
cd ~/ws_livox
rosdepc install --from-paths src --ignore-src -y
```

编译，忽略警告  
```bash
cd ~/ws_livox
colcon build --packages-select fast_lio
```

建图，使用的是livox自定义格式点云，与聚类的点云格式不同  
```bash
ros2 launch livox_ros_driver2 msg_MID360_launch.py
ros2 launch fast_lio mapping.launch.py
```

```
话题  
/Laser_map          构建的稠密地图  
/Odometry FAST-LIO  输出的里程计  
/livox/imu Livox    雷达内置 IMU 数据  
/livox/lidar Livox  原始点云数据  
/tf                 动态坐标变换  
/tf_static          静态坐标变换
```
