# 树莓派 Ubuntu 22.04 + ROS 2 Humble  
## Cartographer + 镭神 N10 建图全流程日志

---

### 1. 创建工作空间
```bash
rm -rf ~/slam_ws/
mkdir -p ~/slam_ws/src
cd ~/slam_ws
rosdep update
rosdep install --from-paths src --ignore-src -y
colcon build
```

---

### 2. 固定串口
```bash
ls /dev/tty*
sudo apt install udev
udevadm info -a -p $(udevadm info -q path -n /dev/ttyACM0)
```

| 字段 | 值 |
|---|---|
| idVendor | 1a86 |
| idProduct | 55d4 |
| serial | 5954004011 |
| product | USB Single Serial |

```bash
sudo nano /etc/udev/rules.d/99-usb-serial.rules
```

```udev
SUBSYSTEM=="tty", ATTRS{idVendor}=="1a86", ATTRS{idProduct}=="55d4", SYMLINK+="usb_robot", MODE="0666"
```

```bash
sudo udevadm control --reload-rules
sudo udevadm trigger
ls -l /dev/usb_robot
```

---

### 3. 获取点云（N10 驱动）
```bash
sudo apt install ros-humble-diagnostic-updater libpcap-dev

rm -rf ~/slam_ws
mkdir -p ~/slam_ws/src
cd ~/slam_ws/src

# 任选其一分支
git clone -b N10_V1.0 https://github.com/Lslidar/Lslidar_ROS2_driver.git
# git clone -b M10P/N10P https://github.com/Lslidar/Lslidar_ROS2_driver.git

cp -r Lslidar_ROS2_driver/lslidar_driver .
cp -r Lslidar_ROS2_driver/lslidar_msgs .
rm -rf Lslidar_ROS2_driver
```

#### 3.1 修改串口号
```bash
gedit ~/slam_ws/src/lslidar_driver/src/lslidar_driver.cc
# 将 ttyUSB0 改为 usb_robot
```

```bash
gedit ~/slam_ws/src/lslidar_driver/params/lsx10.yaml
# lidar_name: N10
# ttyUSB0 -> usb_robot
```

#### 3.2 注释 rviz 相关行（25-37、40 行）
```bash
gedit ~/slam_ws/src/lslidar_driver/launch/lslidar_launch.py
```

#### 3.3 编译 & 运行
```bash
cd ~/slam_ws
colcon build --packages-select lslidar_msgs
colcon build --packages-select lslidar_driver

echo "source ~/slam_ws/install/setup.bash" >> ~/.bashrc
source ~/.bashrc

ros2 launch lslidar_driver lslidar_launch.py
# 独立可视化
rviz2 -d ~/slam_ws/src/lslidar_driver/rviz/lslidar.rviz
```

---

### 4. TF 静态变换功能包
```bash
cd ~/slam_ws/src
ros2 pkg create --build-type ament_cmake laser_tf_publisher
mkdir -p laser_tf_publisher/launch
```

#### 4.1 源码
`laser_tf_publisher/src/static_tf_broadcaster.cpp`
```cpp
#include <memory>
#include "rclcpp/rclcpp.hpp"
#include "tf2_ros/static_transform_broadcaster.h"
#include "geometry_msgs/msg/transform_stamped.hpp"

class StaticTfBroadcaster : public rclcpp::Node
{
public:
    explicit StaticTfBroadcaster()
    : Node("static_tf_broadcaster")
    {
        tf_broadcaster_ = std::make_shared<tf2_ros::StaticTransformBroadcaster>(this);
        timer_ = this->create_wall_timer(
            std::chrono::milliseconds(500),
            [this]() {
                if (!published_) {
                    publish_static_transforms();
                    published_ = true;
                }
            });
    }

private:
    void publish_static_transforms()
    {
        geometry_msgs::msg::TransformStamped base_to_laser;
        base_to_laser.header.stamp = rclcpp::Time(0);
        base_to_laser.header.frame_id = "base_link";
        base_to_laser.child_frame_id = "laser_link";
        base_to_laser.transform.translation.x = 0.0;
        base_to_laser.transform.translation.y = 0.0;
        base_to_laser.transform.translation.z = 0.2;
        base_to_laser.transform.rotation.x = 0.0;
        base_to_laser.transform.rotation.y = 0.0;
        base_to_laser.transform.rotation.z = 0.0;
        base_to_laser.transform.rotation.w = 1.0;
        tf_broadcaster_->sendTransform(base_to_laser);
        RCLCPP_INFO(this->get_logger(), "Published static transform: base_link -> laser_link");
    }
    
    std::shared_ptr<tf2_ros::StaticTransformBroadcaster> tf_broadcaster_;
    rclcpp::TimerBase::SharedPtr timer_;
    bool published_ = false;
};

int main(int argc, char **argv)
{
    rclcpp::init(argc, argv);
    auto node = std::make_shared<StaticTfBroadcaster>();
    rclcpp::spin(node);
    rclcpp::shutdown();
    return 0;
}
```

#### 4.2 Launch / CMake / package.xml
`launch/tf_broadcaster.launch.py`
```python
from launch import LaunchDescription
from launch_ros.actions import Node

def generate_launch_description():
    return LaunchDescription([
        Node(
            package='laser_tf_publisher',
            executable='static_tf_broadcaster',
            name='static_tf_broadcaster',
            output='screen'
        )
    ])
```

`CMakeLists.txt`（节选）
```cmake
find_package(rclcpp REQUIRED)
find_package(tf2_ros REQUIRED)
find_package(geometry_msgs REQUIRED)

add_executable(static_tf_broadcaster src/static_tf_broadcaster.cpp)
ament_target_dependencies(static_tf_broadcaster rclcpp tf2_ros geometry_msgs)
install(TARGETS static_tf_broadcaster DESTINATION lib/${PROJECT_NAME})
install(DIRECTORY launch DESTINATION share/${PROJECT_NAME})
```

`package.xml`（节选）
```xml
<depend>rclcpp</depend>
<depend>tf2_ros</depend>
<depend>geometry_msgs</depend>
<exec_depend>launch</exec_depend>
```

#### 4.3 编译 & 测试
```bash
cd ~/slam_ws
colcon build --packages-select laser_tf_publisher
source install/setup.bash
ros2 launch laser_tf_publisher tf_broadcaster.launch.py
ros2 run tf2_tools view_frames
evince frames.pdf
```

---

### 5. 激光里程计方案

#### 5.1 laser_scan_matcher（失败，TF 超时）
```bash
sudo apt-get install build-essential cmake libgsl-dev
cd ~
git clone https://github.com/AlexKarvaev/csm
mkdir csm/build && cd csm/build
cmake .. && make -j8 && sudo make install && sudo ldconfig

cd ~/slam_ws/src
git clone https://github.com/AlexKarvaev/ros2_laser_scan_matcher
# 修改 laser_frame 默认值 laser -> laser_link
gedit src/laser_scan_matcher.cpp
colcon build --packages-select ros2_laser_scan_matcher

# 运行
ros2 launch laser_tf_publisher tf_broadcaster.launch.py
ros2 launch lslidar_driver lslidar_launch.py
ros2 run ros2_laser_scan_matcher laser_scan_matcher
# 卡 TF
```

#### 5.2 rf2o_laser_odometry（可用）
```bash
cd ~/slam_ws/src
git clone https://github.com/MAPIRlab/rf2o_laser_odometry
colcon build --packages-select rf2o_laser_odometry

# 运行
ros2 launch laser_tf_publisher tf_broadcaster.launch.py
ros2 launch lslidar_driver lslidar_launch.py
ros2 launch rf2o_laser_odometry rf2o_laser_odometry.launch.py
ros2 topic echo /odom_rf2o
```

---

### 6. Cartographer 建图
#### 6.1 配置
```bash
cd /opt/ros/humble/share/cartographer_ros/configuration_files
sudo cp backpack_2d.lua mylaser.lua && sudo chmod 777 mylaser.lua
```

`mylaser.lua`（节选）
```lua
include "map_builder.lua"
include "trajectory_builder.lua"

options = {
  map_frame = "map",
  tracking_frame = "base_link",
  published_frame = "base_link",
  odom_frame = "odom",
  provide_odom_frame = false,
  use_odometry = false,
  ...
}

MAP_BUILDER.use_trajectory_builder_2d = true
TRAJECTORY_BUILDER_2D.min_range = 0.
TRAJECTORY_BUILDER_2D.max_range = 200.
TRAJECTORY_BUILDER_2D.missing_data_ray_length = 5.
TRAJECTORY_BUILDER_2D.use_imu_data = false
TRAJECTORY_BUILDER_2D.submaps.num_range_data = 35
...
```

#### 6.2 Launch
```bash
cd /opt/ros/humble/share/cartographer_ros/launch
sudo cp backpack_2d.launch.py mylaser.launch.py && sudo chmod 777 mylaser.launch.py
```

`mylaser.launch.py`（已注释 URDF、robot_state_publisher、rviz）
```python
...
cartographer_node = Node(
    package='cartographer_ros',
    executable='cartographer_node',
    arguments=['-configuration_directory', ..., '-configuration_basename', 'mylaser.lua'],
    remappings=[('scan', 'scan')],
    output='screen'
)
cartographer_occupancy_grid_node = Node(
    package='cartographer_ros',
    executable='cartographer_occupancy_grid_node',
    parameters=[{'use_sim_time': False}, {'resolution': 0.05}]
)
...
```

#### 6.3 运行
```bash
ros2 launch laser_tf_publisher tf_broadcaster.launch.py
ros2 launch lslidar_driver lslidar_launch.py
ros2 launch cartographer_ros mylaser.launch.py
rviz2 -d ~/slam_ws/src/lslidar_driver/rviz/lslidar.rviz
```

---

### 7. 串口输出坐标（可选）
#### 7.1 固定串口（USB-TTL）
同第 2 步，设备名 `usb_robot`。

#### 7.2 GPIO 串口（ttyAMA0）
```bash
sudo nano /boot/firmware/config.txt
# 添加
dtoverlay=disable-bt
enable_uart=1
dtoverlay=miniuart-bt
```

#### 7.3 串口发送功能包
```bash
cd ~/slam_ws/src
ros2 pkg create --build-type ament_cmake serial_odom_sender --dependencies rclcpp nav_msgs
# 修改设备名、波特率 115200，协议：AA xH xL yH yL zH zL yawH yawL 0A
colcon build --packages-select serial_odom_sender
ros2 run serial_odom_sender serial_odom_sender
```

---

### 8. 开机自启动
`~/slam_autostart.sh`
```bash
#!/bin/bash
source /opt/ros/humble/setup.bash
source /home/chen/slam_ws/install/setup.bash
sleep 3
ros2 launch lslidar_driver lslidar_launch.py &
sleep 3
ros2 launch rf2o_laser_odometry rf2o_laser_odometry.launch.py &
sleep 3
ros2 run serial_odom_sender serial_odom_sender &
while true; do sleep 1000; done
```

```bash
chmod +x ~/slam_autostart.sh
```

`/etc/systemd/system/slam_autostart.service`
```ini
[Unit]
Description=ROS 2 Autostart Service
After=network.target

[Service]
Type=simple
User=chen
ExecStart=/home/chen/slam_autostart.sh
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
```

```bash
sudo systemctl daemon-reload
sudo systemctl enable slam_autostart.service
sudo systemctl start slam_autostart.service
```

---

### 9. Ubuntu 电脑接收打印
```bash
mkdir -p ~/slam_ws/src
ros2 pkg create --build-type ament_cmake serial_odom_receiver
# 实现接收节点
colcon build --packages-select serial_odom_receiver
source install/setup.bash
ros2 run serial_odom_receiver serial_odom_receiver
```
