# 基于rk3568-Humble，镭神 N10 SLAM添加pixhawk飞控的imu数据
**px4版本为1.13.3，其余版本没有验证**

---

## 机载电脑下载MAVROS

修改QGC中参数
```
# mavlink通道1设置为TELLEM2
- MAV_1_CONFIG     TELLEM2

# 设置为onborad模式才会发送线加速度
- MAV_1_MODE       Onboard

# 设置TELLEM2通信波特率
- SER_TEL2_BAUD    921600 8N1

# 设置TELLEM2的速度b/s，0则飞控自适应
- MAV_1_RATE       0
```

```
# QGC的MavLink工作台输入
mavlink status streams
# 可见imu输出频率2.5
instance #1:
HIGHRES_IMU                    50.00 (2.500)
# 设置输出频率50hz
mavlink stream -r 50 -s HIGHRES_IMU
mavlink status streams
# 可见
instance #1:
HIGHRES_IMU                    50.00 (2.500)
```

**注意飞控不能3v3供电**
```
模块通过串口/dev/ttyS3连接TELLEM2
TELLEM2  5V  TX  RX CTS RTS GND  
mode     3V3 3V3 GND TX RX
```

## 安装MAVROS

参考：https://blog.csdn.net/weixin_42037083/article/details/137102858

```bash
sudo apt-get install ros-humble-mavros ros-humble-mavros-extras
```

#### 安装geographiclib

```bash
cd ~
git clone https://github.com/weisama/GeographicLib.git
sudo cp -r ~/GeographicLib /usr/share
rm -rf ~/GeographicLib
```

#### 设置鲁班猫2串口

```bash
sudo nano /boot/uEnv/uEnv.txt
# 取消串口3m0的注释
dtoverlay=/dtb/overlay/rk356x-lubancat-uart3-m1-overlay.dtbo
```

#### 查看串口消息

```bash
sudo dmesg | tail
ls /dev/ttyS*
sudo usermod -aG dialout $USER
sudo chmod 777 /dev/ttyS3
```

### 创建功能包启动px4

**禁用不需要的模块，解决CPU占用36%的问题**

```
cd ~/slam_ws
colcon build --packages-select px4_launch
```

```bash
# 自建功能包禁用模块
ros2 launch px4_launch px4.launch.py
# 官方launch
ros2 launch mavros px4.launch
ros2 topic list
```

### 检查MAVROS状态

```bash
# 飞控状态
ros2 topic echo /mavros/state

# EKF2的imu数据,坐标系为base_link则不修改tf变换
ros2 topic echo /mavros/imu/data

# 频率50hz满足要求
ros2 topic hz /mavros/imu/data

# 原始imu数据，不建议使用
ros2 topic echo /mavros/imu/data_raw
```

---

## cartographer添加imu（未使用）

### 新建配置和launch

```bash
cd ~/slam_ws/src/cartographer_navigation
cp config/mylaser.lua config/mylaser_imu.lua
gedit ~/slam_ws/src/cartographer_navigation/config/mylaser_imu.lua
```

```bash
# 修改部分
TRAJECTORY_BUILDER_2D.use_imu_data = true  -- 是否使用IMU数据#############
-- IMU相关参数（新增）
TRAJECTORY_BUILDER_2D.imu_gravity_time_constant = 10.  -- IMU重力时间常数#############
TRAJECTORY_BUILDER_2D.pose_extrapolator.use_imu_based = false  -- 对于2D SLAM，通常设置为false#############
```

```bash
cd ~/slam_ws/src/cartographer_navigation
cp launch/cartographer.launch.py launch/cartographer_imu.launch.py
gedit ~/slam_ws/src/cartographer_navigation/launch/cartographer_imu.launch.py
```

```bash
# 修改部分
# 配置文件的完整路径
    config_dir = os.path.join(pkg_share, 'config')
    config_file = os.path.join(config_dir, 'mylaser_imu.lua')

    # Cartographer SLAM主节点
    cartographer_node = Node(
        package = 'cartographer_ros',
        executable = 'cartographer_node',
        arguments = [
            '-configuration_directory', config_dir,  # 使用自定义配置目录
            '-configuration_basename', 'mylaser_imu.lua'],  # 使用自定义配置文件
        remappings = [
            ('scan', 'scan'),  # 添加话题重映射确保订阅正确的激光话题
            ('imu', '/mavros/imu/data'), # 添加IMU话题重映射（重要修改）
            ('odom', '/odom_rf2o')], 
        output = 'screen'
        )
```

### 编译运行

```bash
cd ~/slam_ws
colcon build --packages-select cartographer_navigation
```

```bash
# 运行
ros2 launch mavros px4.launch
ros2 launch lidar_filter lidar_filter_with_driver.launch.py
ros2 launch rf2o_laser_odometry rf2o_laser_odometry.launch.py publish_tf:=false
ros2 launch cartographer_navigation cartographer_imu.launch.py
# 可视化
rviz2 -d ~/slam_ws/src/lslidar_driver/rviz/lslidar.rviz
ros2 run rqt_tf_tree rqt_tf_tree
```

---

## pose_send功能包，slam输出tf作为飞控位置输入，并发送给串口4

**根据upper/config/params.yaml的px4使能和串口使能，决定是否启动px4并发送坐标和串口发送坐标**

```bash
cd ~/slam_ws/src
ros2 pkg create --build-type ament_cmake pose_send --dependencies rclcpp tf2_ros geometry_msgs
```

`gedit ~/slam_ws/src/pose_send/src/pose_send_node.cpp`

`gedit ~/slam_ws/src/pose_send/CMakeLists.txt`

```
cd ~/slam_ws
colcon build --packages-select pose_send
```

```
# 循环播放bag，使用模拟时间
ros2 bag play ~/slam_ws/src/upper/bag/*.db3 --loop --clock
ros2 launch pose_send pose_send.launch.py --ros-args -p use_sim_time:=true
ros2 topic echo /mavros/vision_pose/pose

# 本机测试串口接收
sudo minicom -D /dev/ttyUSB0 -b 115200

#数据格式
发送频率是坐标话题频率
波特率115200
数据类型8N1
xyz单位为cm，yaw单位为度
通信协议：
帧头 0xAA
x高八位
x第八位
y高八位
y第八位
z高八位
z第八位
yaw高八位
yaw第八位
帧尾 0x0A
```

---

## QGC设置飞控使用slam外部视觉坐标和yaw输入

- EKF2_AID_MASK = 24  
- EKF2_EVP_NOISE = 0.1 
- EKF2_EVA_NOISE = 2.56 
- EKF2_EV_DELAY = 125  
- EKF2_HGT_MODE = 0

---

## 设置脚本开机自启动slam

```bash
gedit ~/autostart.sh
```

写入：

```bash
#!/bin/bash
# 加载环境
source /opt/ros/humble/setup.bash
source /home/cat/slam_ws/install/setup.bash
# 启动命令
ros2 launch lidar_filter lidar_filter_with_driver.launch.py &
sleep 3
ros2 launch rf2o_laser_odometry rf2o_laser_odometry.launch.py publish_tf:=true &
sleep 3
ros2 launch karto_slam online_launch.py &
sleep 1
ros2 launch upper upper_launch.py tcp_ip:=0.0.0.0 tcp_port:=6666 &
sleep 1
sudo nmcli dev wifi hotspot ifname wlan0 ssid slam_mode password 12345678 &
sleep 1
ros2 launch mavros px4.launch &
sleep 1
ros2 run pose_send pose_send_node &
# 防止脚本退出
while true; do sleep 1000; done
```

```bash
chmod +x ~/autostart.sh
```

```bash
sudo nano /etc/systemd/system/autostart.service
```

写入：

```
[Unit]
Description=ROS 2 Autostart Service
After=network.target
[Service]
Type=simple
User=cat
ExecStart=/home/cat/autostart.sh
Restart=on-failure
RestartSec=5s
[Install]
WantedBy=multi-user.target
```

```bash
sudo systemctl daemon-reload
sudo systemctl enable autostart.service
sudo systemctl start autostart.service
```

停止服务

```bash
sudo systemctl stop autostart.service
```

禁用开机自启动

```bash
sudo systemctl disable autostart.service
```

## 功能包可视化yaw延迟，推算EKF2_EV_DELAY


```
cd ~/slam_ws
colcon build --packages-select visualize_delay
```

```
ros2 launch visualize_delay visualize_delay.launch.py
```


