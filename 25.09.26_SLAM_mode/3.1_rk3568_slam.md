# 模块搭载ubuntu22实现slam

---

## 下载功能包编译

#### 初始化工作空间

```bash
mkdir -p ~/slam_ws/src
cd ~/slam_ws
sudo rosdepc init
rosdepc update
rosdepc install --from-paths src --ignore-src -y
colcon build
```

#### 拉取功能包编译

```bash
cd ~
git clone -b main https://github.com/weisama/slam_mode.git
sudo cp -r ~/slam_mode/* ~/slam_ws/src
sudo rm -rf ~/slam_mode

cd ~/slam_ws
rosdepc install --from-paths src --ignore-src -y
```

#### 安装功能包所需软件
```bash
sudo apt install ros-humble-diagnostic-updater libpcap-dev libicu70=70.1-2 libpcl-dev ros-$ROS_DISTRO-pcl-conversions ros-$ROS_DISTRO-pcl-ros
sudo apt-get install ros-$ROS_DISTRO-tf2-tools ros-$ROS_DISTRO-rqt-tf-tree
sudo apt install nlohmann-json3-dev -y
sudo apt install libboost-all-dev
sudo apt install ros-$ROS_DISTRO-slam-toolbox
```

#### 编译
```bahs
cd ~/slam_ws
colcon build --packages-select lslidar_msgs
colcon build --packages-select lslidar_driver
colcon build --packages-select lidar_filter
colcon build --packages-select tf
colcon build --packages-select pose_send
colcon build --packages-select upper
colcon build --packages-select rf2o_laser_odometry
colcon build --packages-select karto_slam

```

### 环境变量

```bash
gedit ~/.bashrc
source ~/slam_ws/install/setup.bash
```


---

## 基础配置

### 固定雷达串口
```bash
ls /dev/tty*
sudo nano /etc/udev/rules.d/99-usb-serial.rules
```

```udev
SUBSYSTEM=="tty", ATTRS{idVendor}=="1a86", ATTRS{idProduct}=="55d4", SYMLINK+="usb_robot", MODE="0666"
```

```bash
sudo udevadm control --reload-rules
sudo udevadm trigger
ls -l /dev/usb_robot
```

### 安装MAVROS

参考：https://blog.csdn.net/weixin_42037083/article/details/137102858

```bash
sudo apt-get install ros-humble-mavros ros-humble-mavros-extras
```

#### 安装geographiclib

```bash
cd ~
git clone https://github.com/weisama/GeographicLib.git
sudo cp -r ~/GeographicLib /usr/share
rm -rf ~/GeographicLib
```

#### 查看串口消息

```bash
sudo dmesg | tail
ls /dev/ttyS*
sudo usermod -aG dialout $USER
sudo chmod 777 /dev/ttyS3
```

#### 修改mavros串口设备和波特率

```bash
sudo nano /opt/ros/humble/share/mavros/launch/px4.launch
```

```xml
<arg name="fcu_url" default="/dev/ttyS3:921600" />
```
---

## 添加测试脚本

`sudo nano ~/test.sh`

```
#!/bin/bash
# 加载环境
source /opt/ros/humble/setup.bash
source /usr/share/chen/install/setup.bash
# 启动命令
ros2 launch lidar_filter lidar_filter_with_driver.launch.py &
sleep 3
ros2 launch rf2o_laser_odometry rf2o_laser_odometry.launch.py publish_tf:=true &
sleep 5
ros2 launch karto_slam online_launch.py &
sleep 1
ros2 launch upper upper_launch.py tcp_ip:=0.0.0.0 tcp_port:=6666 &
#sleep 1
#ros2 launch mavros px4.launch &
#sleep 1
#ros2 run pose_send pose_send_node &
# 防止脚本退出
while true; do sleep 1000; done
sudo chmod +x /usr/share/chen/autostart.sh
```

`sudo bash ~/test.sh`

---

## 功能包测试

```bash
# ssh连接
ssh -Y cat@10.28.193.22

# tf变换
ros2 launch tf tf_broadcaster.launch.py
ros2 run rqt_tf_tree rqt_tf_tree

# 启动雷达
ros2 launch lslidar_driver lslidar_launch.py
ros2 topic list

# 启动雷达并固定点云数量，发布tf
ros2 launch lidar_filter lidar_filter_with_driver.launch.py
ros2 topic echo /scan --no-arr | grep "length:"

# rf2o_laser_odometry里程计
ros2 launch lidar_filter lidar_filter_with_driver.launch.py
ros2 launch rf2o_laser_odometry rf2o_laser_odometry.launch.py publish_tf:=true

# cartographer建图
ros2 launch lidar_filter lidar_filter_with_driver.launch.py
ros2 launch rf2o_laser_odometry rf2o_laser_odometry.launch.py publish_tf:=false
ros2 launch cartographer_navigation cartographer.launch.py

# Gmapping
ros2 launch lidar_filter lidar_filter_with_driver.launch.py
ros2 launch rf2o_laser_odometry rf2o_laser_odometry.launch.py publish_tf:=true
ros2 launch gmapping_launch gmapping_launch.py

# SLAM_TOOLBOX建图
ros2 launch lidar_filter lidar_filter_with_driver.launch.py
ros2 launch rf2o_laser_odometry rf2o_laser_odometry.launch.py publish_tf:=true
# 异步建图快，同步占用少，建图会更新map，定位不更新map
# 异步建图
ros2 launch karto_slam online_launch.py mode:=mapping sync_async:=async
# 同步建图
ros2 launch karto_slam online_launch.py mode:=mapping sync_async:=sync
# 异步定位
ros2 launch karto_slam online_launch.py mode:=localization sync_async:=async
# 同步定位
ros2 launch karto_slam online_launch.py mode:=localization sync_async:=sync

# 修改设置
gedit ~/slam_ws/src/upper/config/params.yaml

# 循环播放话题
ros2 bag play ~/slam_ws/src/upper/bag/*.db3 --loop

# 启动上位机
ros2 launch upper upper_launch.py tcp_ip:=0.0.0.0 tcp_port:=6666 use_rviz:=false play_bag:=false

# 开启热点
sudo nmcli dev wifi hotspot ifname wlan0 ssid slam_mode password 12345678
```

## 录制话题

```bash
# 录制所有话题
ros2 bag record -o ~/slam_ws/src/upper/bag -a
ls ~/slam_ws/src/upper/bag

# 播放话题
ros2 bag play ~/slam_ws/src/upper/bag/*.db3

# 删除后才能重新录制
sudo rm  -rf ~/slam_ws/src/upper/bag
```







