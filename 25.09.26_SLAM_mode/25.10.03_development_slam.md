# 鲁班猫2使用SDK编译的Ubuntu22.04+ROS 2 Humble  
## 镭神 N10 建图全流程日志

---

### 激光里程计方案

#### laser_scan_matcher（失败，TF 超时）
```bash
sudo apt-get install build-essential cmake libgsl-dev
cd ~
git clone https://github.com/AlexKarvaev/csm
mkdir csm/build && cd csm/build
cmake .. && make -j8 && sudo make install && sudo ldconfig

cd ~/slam_ws/src
git clone https://github.com/AlexKarvaev/ros2_laser_scan_matcher
# 修改 laser_frame 默认值 laser -> laser_link
gedit src/laser_scan_matcher.cpp
colcon build --packages-select ros2_laser_scan_matcher

# 运行
ros2 launch lidar_filter lidar_filter_with_driver.launch.py
ros2 run ros2_laser_scan_matcher laser_scan_matcher
# 卡在 TF
```

---

#### rf2o_laser_odometry（可用）
```bash
sudo apt install libboost-all-dev
cd ~/slam_ws/src
git clone https://github.com/MAPIRlab/rf2o_laser_odometry
```

**rf2o_laser_odometry不发布 odom -> base_link，使得odom不被其漂移干扰**

`gedit ~/slam_ws/src/rf2o_laser_odometry/launch/rf2o_laser_odometry.launch.py`

```bash
import os
from pathlib import Path
from ament_index_python.packages import get_package_share_directory
from launch import LaunchDescription
from launch.actions import DeclareLaunchArgument
from launch.substitutions import LaunchConfiguration
from launch_ros.actions import Node

def generate_launch_description():

    # 声明一个 launch 参数：是否发布 tf
    declare_publish_tf_arg = DeclareLaunchArgument(
        'publish_tf',
        default_value='true',  # 默认发布 tf
        description='Whether to publish odom -> base_link transform'
    )

    # 创建 launch description
    return LaunchDescription([
        declare_publish_tf_arg,

        Node(
            package='rf2o_laser_odometry',
            executable='rf2o_laser_odometry_node',
            name='rf2o_laser_odometry',
            output='screen',
            parameters=[{
                'laser_scan_topic': '/scan',
                'odom_topic': '/odom_rf2o',    # 发布的坐标话题
                'publish_tf': LaunchConfiguration('publish_tf'),  # # 是否发布 odom -> base_link，可变参数
                'base_frame_id': 'base_link',  # 机器人坐标系
                'odom_frame_id': 'odom',       # 里程计坐标话题的坐标系
                'init_pose_from_topic': '',    # 初始位姿
                'freq': 10.0                   # 运行频率保持和雷达一致
            }],
        ),
    ])
```

**未知原因源码计算出的xy反向了，修改为正确方向**

`gedit ~/slam_ws/src/rf2o_laser_odometry/src/CLaserOdometry2DNode.cpp`

```bash
odom.pose.pose.position.x = - rf2o_ref.robot_pose_.translation()(0);  // 添加负号
odom.pose.pose.position.y = - rf2o_ref.robot_pose_.translation()(1);  // 添加负号
// ...
odom_trans.transform.translation.x = - rf2o_ref.robot_pose_.translation()(0);  // 添加负号
odom_trans.transform.translation.y = - rf2o_ref.robot_pose_.translation()(1);  // 添加负号

gedit ~/slam_ws/src/rf2o_laser_odometry/src/CLaserOdometry2D.cpp
RCLCPP_INFO(get_logger(), "Robot-base odom [x,y,yaw]=[%f %f %f]",
                -robot_pose_.translation()(0),
                -robot_pose_.translation()(1),
                rf2o::getYaw(robot_pose_.rotation()));
```

```bash
cd ~/slam_ws
colcon build --packages-select rf2o_laser_odometry
```

```bash
# 运行
ros2 launch lidar_filter lidar_filter_with_driver.launch.py
ros2 launch rf2o_laser_odometry rf2o_laser_odometry.launch.py publish_tf:=false
ros2 launch rf2o_laser_odometry rf2o_laser_odometry.launch.py publish_tf:=true

# 可视化
ros2 topic echo /odom_rf2o
rviz2 -d ~/slam_ws/src/lslidar_driver/rviz/lslidar.rviz
```

---

### Cartographer 建图，融合了rf2o_laser_odometry里程计
[教程](https://blog.csdn.net/m262914/article/details/141223818）

```bash
# 码源编译安装过于麻烦，故舍弃，改为apt安装
sudo apt install ros-humble-cartographer ros-humble-cartographer-ros
```

```bash
cd ~/slam_ws/src
ros2 pkg create cartographer_navigation --build-type ament_cmake --dependencies rclcpp cartographer_ros
mkdir -p ~/slam_ws/src/cartographer_navigation/launch ~/slam_ws/src/cartographer_navigation/config
```

#### 配置

**数据参考轮趣科技**

`gedit ~/slam_ws/src/cartographer_navigation/config/mylaser.lua`

```lua
include "map_builder.lua"
include "trajectory_builder.lua"

options = {
  map_builder = MAP_BUILDER,
  trajectory_builder = TRAJECTORY_BUILDER,
  
  -- 坐标系设置
  map_frame = "map",  -- 全局地图坐标系，发布tf变换的起始点，坐标系A
  tracking_frame = "base_link",  -- SLAM算法跟踪的机器人基座坐标系
  published_frame = "base_link",  -- 通常是base_link，发布tf变换的结束点，坐标系C
  odom_frame = "odom",  -- 发布tf变换的中点，坐标系B
  
  -- 功能开关
  provide_odom_frame = true,  -- 是否添加中间点B，A->C 或 A->B->C
  publish_frame_projected_to_2d = true,  -- 将3D位姿投影到2D，忽略俯仰角带来的地图偏差
  use_odometry = true,  -- 是否使用外部里程计数据
  use_nav_sat = false,  -- 是否使用GPS数据
  use_landmarks = false,  -- 是否使用路标点
  
  -- 传感器数据设置
  num_laser_scans = 1,  -- 订阅的单线激光雷达话题数量
  num_multi_echo_laser_scans = 0,  -- 订阅的多回波激光雷达话题数量
  num_subdivisions_per_laser_scan = 1,  -- 每帧激光数据分割的子帧数
  num_point_clouds = 0,  -- 订阅的点云话题数量
  
  -- 超时和发布频率设置
  lookup_transform_timeout_sec = 0.2,  -- TF变换查找超时时间（秒）
  submap_publish_period_sec = 0.3,  -- 子地图发布周期
  pose_publish_period_sec = 5e-3,  -- 位姿发布周期（高频）
  trajectory_publish_period_sec = 30e-3,  -- 轨迹发布周期
  
  -- 数据采样率设置（1.0表示使用所有数据）
  rangefinder_sampling_ratio = 1.,  -- 测距仪数据采样率
  odometry_sampling_ratio = 1.,  -- 里程计数据采样率
  fixed_frame_pose_sampling_ratio = 1.,  -- 固定坐标系位姿采样率
  imu_sampling_ratio = 1.,  -- IMU数据采样率
  landmarks_sampling_ratio = 1.,  -- 路标数据采样率
}

MAP_BUILDER.use_trajectory_builder_2d = true  -- 启用2D轨迹构建器，适用于平面移动机器人

-- 2D轨迹构建器参数
TRAJECTORY_BUILDER_2D.min_range = 0.3  -- 激光雷达最小有效测量距离
TRAJECTORY_BUILDER_2D.max_range = 5.0  -- 激光雷达最大有效测量距离
TRAJECTORY_BUILDER_2D.missing_data_ray_length = 10.  -- 缺失数据的射线长度
TRAJECTORY_BUILDER_2D.use_imu_data = false  -- 是否使用IMU数据
TRAJECTORY_BUILDER_2D.use_online_correlative_scan_matching = true  -- 是否使用在线相关扫描匹配



-- 运动滤波参数
TRAJECTORY_BUILDER_2D.motion_filter.max_angle_radians = math.rad(0.1)  -- 位姿更新最小角度阈值

-- Ceres扫描匹配器参数
TRAJECTORY_BUILDER_2D.ceres_scan_matcher.translation_weight = 2e2  -- 平移项的优化权重，值越大对平移误差越敏感
TRAJECTORY_BUILDER_2D.ceres_scan_matcher.ceres_solver_options.max_num_iterations = 20  -- 最大迭代次数，影响优化精度和耗时
TRAJECTORY_BUILDER_2D.ceres_scan_matcher.rotation_weight = 600  -- 显著提高，加强对先验旋转的约束###############

TRAJECTORY_BUILDER_2D.num_accumulated_range_data = 1  -- 累积多帧数据，改善高速移动时的数据质量
TRAJECTORY_BUILDER_2D.voxel_filter_size = 0.05  -- 较小的体素提供更精细的地图但计算量更大
TRAJECTORY_BUILDER_2D.submaps.num_range_data = 45  -- 每个子地图包含的雷达数据帧数，值小更新快，值大更稳定
MAP_BUILDER.num_background_threads = 4  -- 后台处理线程数，CPU核心数

-- 位姿图优化参数
POSE_GRAPH.constraint_builder.min_score = 0.65  -- 闭环检测的最小匹配分数，值高减少错误闭环，值低更容易检测到闭环
POSE_GRAPH.constraint_builder.global_localization_min_score = 0.7  -- 全局定位的最小匹配分数

-- 采样率参数
POSE_GRAPH.global_sampling_ratio = 0.001  -- 全局约束采样率
POSE_GRAPH.constraint_builder.sampling_ratio = 0.001  -- 约束构建采样率

-- 优化频率设置
POSE_GRAPH.optimize_every_n_nodes = 50  -- 每N个节点执行一次优化,越小地图更新越频繁

return options
```

#### Launch

`gedit ~/slam_ws/src/cartographer_navigation/launch/cartographer.launch.py`

```python
from launch import LaunchDescription
from launch.actions import DeclareLaunchArgument, IncludeLaunchDescription
from launch.conditions import IfCondition, UnlessCondition
from launch.substitutions import LaunchConfiguration
from launch_ros.actions import Node, SetRemap
from launch_ros.substitutions import FindPackageShare
from launch.launch_description_sources import PythonLaunchDescriptionSource
import os

def generate_launch_description():

    ## ***** Launch arguments *****
    # 定义是否使用仿真时间参数 (默认为False，实际机器人部署时通常设为False)
    use_sim_time_arg = DeclareLaunchArgument('use_sim_time', default_value = 'False')

    ## ***** File paths ******
    # 获取cartographer_ros包的共享路径
    pkg_share = FindPackageShare('cartographer_navigation').find('cartographer_navigation')

    # 配置文件的完整路径
    config_dir = os.path.join(pkg_share, 'config')
    config_file = os.path.join(config_dir, 'mylaser.lua')

    # Cartographer SLAM主节点
    cartographer_node = Node(
        package = 'cartographer_ros',
        executable = 'cartographer_node',
        arguments = [
            '-configuration_directory', config_dir,  # 使用自定义配置目录
            '-configuration_basename', 'mylaser.lua'],  # 使用自定义配置文件
        remappings = [
            ('scan', 'scan'),
            ('odom', '/odom_rf2o')],  # 添加话题重映射确保订阅正确的话题
        output = 'screen'
        )

    # Cartographer占用网格节点
    cartographer_occupancy_grid_node = Node(
        package = 'cartographer_ros',
        executable = 'cartographer_occupancy_grid_node',
        parameters = [
            {'use_sim_time': False},  # 硬编码为False (注意：应使用参数更灵活)
            {'resolution': 0.05}],    # 设置地图分辨率为5cm
        )
    
    # 构建启动描述
    return LaunchDescription([
        use_sim_time_arg,  # 时间参数
        cartographer_node,           # SLAM核心节点
        cartographer_occupancy_grid_node,  # 占用网格生成节点
    ])

```

#### package.xml

`gedit ~/slam_ws/src/cartographer_navigation/package.xml`

```bash
<?xml version="1.0"?>
<?xml-model href="http://download.ros.org/schema/package_format3.xsd" schematypelayout="1.0"?>
<package format="3">
  <name>cartographer_navigation</name>
  <version>0.0.0</version>
  <description>Cartographer navigation with custom configuration</description>
  <maintainer email="you@example.com">Your Name</maintainer>
  <license>Apache-2.0</license>

  <buildtool_depend>ament_cmake</buildtool_depend>

  <depend>rclcpp</depend>
  <depend>cartographer_ros</depend>
  <depend>launch</depend>
  <depend>launch_ros</depend>

  <export>
    <build_type>ament_cmake</build_type>
  </export>
</package>
```

#### CMakeLists.txt

`gedit ~/slam_ws/src/cartographer_navigation/CMakeLists.txt`

```bash
cmake_minimum_required(VERSION 3.8)
project(cartographer_navigation)

if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

find_package(ament_cmake REQUIRED)
find_package(rclcpp REQUIRED)
find_package(cartographer_ros REQUIRED)

# 安装launch文件
install(
  DIRECTORY launch
  DESTINATION share/${PROJECT_NAME}
)

# 安装配置文件
install(
  DIRECTORY config
  DESTINATION share/${PROJECT_NAME}
)

ament_package()
```

#### 编译运行

```bash
cd ~/slam_ws
colcon build --packages-select cartographer_navigation
```

```bash
ros2 launch lidar_filter lidar_filter_with_driver.launch.py
rviz2 -d ~/slam_ws/src/lslidar_driver/rviz/lslidar.rviz
ros2 launch rf2o_laser_odometry rf2o_laser_odometry.launch.py publish_tf:=false
ros2 launch cartographer_navigation cartographer.launch.py
```

---

## Gmapping建图

### humble下没有gmapping的apt，故下载ros2移植版，源码编译
```bash
cd ~/slam_ws
git clone https://github.com/Project-MANAS/slam_gmapping.git
mv -f slam_gmapping/openslam_gmapping src
mv -f slam_gmapping/slam_gmapping src
sudo rm -rf slam_gmapping

# 编译
cd ~/slam_ws
colcon build --packages-select openslam_gmapping
colcon build --packages-select slam_gmapping
```

### 创建一个功能包用于启动gmapping

```bash
cd ~/slam_ws/src
ros2 pkg create gmapping_launch --build-type ament_cmake --dependencies rclcpp launch_ros tf2_ros
mkdir -p ~/slam_ws/src/gmapping_launch/launch ~/slam_ws/src/gmapping_launch/config
```

`gedit ~/slam_ws/src/gmapping_launch/launch/gmapping_launch.py`

```bash
# launch/gmapping_launch.py
from launch import LaunchDescription
from launch_ros.actions import Node
from launch.actions import DeclareLaunchArgument
from launch.substitutions import PathJoinSubstitution
from launch_ros.substitutions import FindPackageShare

def generate_launch_description():
    
    # 参数文件路径 - 固定路径
    params_file = PathJoinSubstitution([
        FindPackageShare('gmapping_launch'),
        'config',
        'my_parameter.yaml'
    ])
    
    return LaunchDescription([
        # 启动slam_gmapping节点
        Node(
            package='slam_gmapping',
            executable='slam_gmapping',
            name='slam_gmapping',
            output='screen',
            parameters=[params_file],
            # 固定重映射到指定的里程计话题
            remappings=[
                ('scan', 'scan'),  # 激光雷达话题保持默认
                ('odom', '/odom_rf2o'),    # 重映射odom话题
            ]
        )
    ])
```

`gedit ~/slam_ws/src/gmapping_launch/config/my_parameter.yaml`

```bash
# config/my_parameter.yaml
/**:
  ros__parameters:
    # =============================================
    # 基础配置
    # =============================================
    map_frame: "map"
    odom_frame: "odom" 
    base_frame: "base_link"
    scan_topic: "scan"
    use_sim_time: false
    
    # =============================================
    # 里程计配置（使用/odom_rf2o发布的TF）
    # =============================================
    # 注意：gmapping通常通过TF获取里程计信息
    # 确保/odom_rf2o发布了odom->base_link的变换
    
    # =============================================
    # 核心建图参数
    # =============================================
    map_update_interval: 5.0
    maxUrange: 8.0
    maxRange: 10.0
    sigma: 0.05
    kernelSize: 1
    lstep: 0.05
    astep: 0.05
    iterations: 5
    lsigma: 0.075
    ogain: 3.0
    lskip: 0
    
    # =============================================
    # 粒子滤波参数
    # =============================================
    particles: 30
    minimumScore: 0.0
    resampleThreshold: 0.5
    
    # =============================================
    # 运动模型参数
    # =============================================
    srr: 0.1
    srt: 0.2  
    str: 0.1
    stt: 0.2
    
    # =============================================
    # 更新频率控制
    # =============================================
    linearUpdate: 1.0
    angularUpdate: 0.5
    temporalUpdate: -1.0
    
    # =============================================
    # 地图尺寸和分辨率
    # =============================================
    xmin: -50.0
    ymin: -50.0  
    xmax: 50.0
    ymax: 50.0
    delta: 0.05
    
    # =============================================
    # 源码编译gmapping可能支持的额外参数
    # =============================================
    # 以下参数根据你编译的gmapping版本决定是否支持
    # throttle_scans: 1
    # lsample: 0.05
```

`gedit ~/slam_ws/src/gmapping_launch/package.xml`

```bash
<?xml version="1.0"?>
<?xml-model href="http://download.ros.org/schema/package_format3.xsd" schematypelocation="http://www.ros.org/schema/package_format3.xsd"?>
<package format="3">
  <name>gmapping_launch</name>
  <version>0.0.0</version>
  <description>Gmapping启动功能包 - 固定配置版本</description>
  <maintainer email="you@example.com">Your Name</maintainer>
  <license>Apache-2.0</license>

  <buildtool_depend>ament_cmake</buildtool_depend>

  <depend>launch_ros</depend>

  <export>
    <build_type>ament_cmake</build_type>
  </export>
</package>
```

`gedit ~/slam_ws/src/gmapping_launch/CMakeLists.txt`

```bash
cmake_minimum_required(VERSION 3.8)
project(gmapping_launch)

# 查找依赖
find_package(ament_cmake REQUIRED)

# 安装launch和config文件
install(DIRECTORY
  launch
  config
  DESTINATION share/${PROJECT_NAME}
)

ament_package()
```

```bash
cd ~/slam_ws
colcon build --packages-select gmapping_launch
```

```bash
ros2 launch gmapping_launch gmapping_launch.py
```

---

## SLAM_TOOLBOX

[ROS官方教程](https://docs.nav2.org/tutorials/docs/navigation2_with_slam.html)

```bash
sudo apt install ros-$ROS_DISTRO-slam-toolbox
```

```bash
cd ~/slam_ws/src
ros2 pkg create --build-type ament_cmake karto_slam
mkdir -p karto_slam/launch karto_slam/config
```

`gedit ~/slam_ws/src/karto_slam/launch/online_launch.py`

```bash
import os
from ament_index_python.packages import get_package_share_directory
from launch import LaunchDescription
from launch.actions import DeclareLaunchArgument, SetEnvironmentVariable, OpaqueFunction
from launch.substitutions import LaunchConfiguration, PathJoinSubstitution
from launch_ros.actions import Node
import yaml

def launch_setup(context, *args, **kwargs):
    # 获取包路径
    karto_pkg_dir = get_package_share_directory('karto_slam')
    upper_pkg_dir = get_package_share_directory('upper')
    
    # 参数优先级：launch参数 > upper/config/params.yaml > karto_slam/config/my_parameter.yaml
    mode_launch_arg = LaunchConfiguration('mode').perform(context)
    sync_async_launch_arg = LaunchConfiguration('sync_async').perform(context)
    
    # 读取 upper/config/params.yaml 文件
    params_yaml_path = os.path.join(upper_pkg_dir, 'config', 'params.yaml')
    mode_from_params = None
    sync_async_from_params = None
    
    if os.path.exists(params_yaml_path):
        with open(params_yaml_path, 'r') as f:
            params_data = yaml.safe_load(f)
            mode_from_params = params_data.get('mode')
            sync_async_from_params = params_data.get('sync_async')
        print(f"[INFO] 从 {params_yaml_path} 读取: mode={mode_from_params}, sync_async={sync_async_from_params}")
    else:
        print(f"[WARN] 参数文件不存在: {params_yaml_path}")
    
    # 确定最终使用的mode和sync_async
    final_mode = mode_launch_arg if mode_launch_arg else mode_from_params
    final_sync_async = sync_async_launch_arg if sync_async_launch_arg else sync_async_from_params
    
    # 读取默认参数文件（karto_slam/config/my_parameter.yaml）
    default_params_file = LaunchConfiguration('params_file')
    default_params_path = default_params_file.perform(context)
    
    scan_topic = "scan"  # 默认值
    other_params = {}
    
    if os.path.exists(default_params_path):
        with open(default_params_path, 'r') as f:
            default_params_data = yaml.safe_load(f)
            # 如果launch参数和upper/config/params.yaml都没有设置，使用my_parameter.yaml中的默认值
            if final_mode is None:
                final_mode = default_params_data.get('mode', 'mapping')
            if final_sync_async is None:
                final_sync_async = default_params_data.get('sync_async', 'async')
            
            # 读取雷达话题
            scan_topic = default_params_data.get('scan_topic', 'scan')
            
            # 保存其他参数用于调试
            other_params = default_params_data
            
        print(f"[INFO] 从 {default_params_path} 读取参数文件")
    else:
        print(f"[WARN] 默认参数文件不存在: {default_params_path}")
    
    # 设置默认值
    if final_mode is None:
        final_mode = 'mapping'
    if final_sync_async is None:
        final_sync_async = 'async'
    
    # 打印关键参数信息
    print("\n" + "="*50)
    print("SLAM 配置参数汇总:")
    print("="*50)
    print(f"运行模式 (mode): {final_mode}")
    print(f"同步模式 (sync_async): {final_sync_async}")
    print(f"雷达话题 (scan_topic): {scan_topic}")
    print(f"里程计话题 (odom_topic): /odom_rf2o")
    print(f"参数来源:")
    if mode_launch_arg:
        print(f"  - mode: 来自launch参数")
    elif mode_from_params is not None:
        print(f"  - mode: 来自upper/config/params.yaml")
    else:
        print(f"  - mode: 来自my_parameter.yaml或默认值")
    
    if sync_async_launch_arg:
        print(f"  - sync_async: 来自launch参数")
    elif sync_async_from_params is not None:
        print(f"  - sync_async: 来自upper/config/params.yaml")
    else:
        print(f"  - sync_async: 来自my_parameter.yaml或默认值")
    print("="*50 + "\n")
    
    # 根据sync_async选择可执行文件
    if final_sync_async == 'async':
        executable_name = 'async_slam_toolbox_node'
        print(f"[INFO] 使用异步模式: {executable_name}")
    else:
        executable_name = 'sync_slam_toolbox_node'
        print(f"[INFO] 使用同步模式: {executable_name}")
    
    # 创建参数文件对象
    from launch_ros.parameter_descriptions import ParameterFile
    param_file = ParameterFile(default_params_file, allow_substs=True)
    
    # SLAM Toolbox节点
    slam_toolbox_node = Node(
        package='slam_toolbox',
        executable=executable_name,
        name='slam_toolbox',
        output='screen',
        parameters=[param_file, {'mode': final_mode}],
        remappings=[
            ('/odom', '/odom_rf2o'),
            ('/tf', 'tf'),
            ('/tf_static', 'tf_static')
        ]
    )
    
    return [slam_toolbox_node]

def generate_launch_description():
    karto_pkg_dir = get_package_share_directory('karto_slam')
    
    # 声明启动参数
    declare_params_file_cmd = DeclareLaunchArgument(
        'params_file',
        default_value=os.path.join(karto_pkg_dir, 'config', 'my_parameter.yaml'),
        description='Full path to the ROS2 parameters file to use for the slam_toolbox node'
    )
    
    declare_mode_cmd = DeclareLaunchArgument(
        'mode',
        default_value='',  # 空字符串表示未设置
        description='SLAM mode: mapping or localization (overrides params.yaml)'
    )
    
    declare_sync_async_cmd = DeclareLaunchArgument(
        'sync_async',
        default_value='',  # 空字符串表示未设置
        description='Sync/Async mode: sync or async (overrides params.yaml)'
    )
    
    # 设置ROS域名（可选）
    set_ros_domain_cmd = SetEnvironmentVariable(
        'ROS_DOMAIN_ID',
        '0'
    )
    
    # 创建启动描述
    ld = LaunchDescription()
    
    # 添加动作
    ld.add_action(set_ros_domain_cmd)
    ld.add_action(declare_params_file_cmd)
    ld.add_action(declare_mode_cmd)
    ld.add_action(declare_sync_async_cmd)
    ld.add_action(OpaqueFunction(function=launch_setup))
    
    return ld
```

`gedit ~/slam_ws/src/karto_slam/config/my_parameter.yaml`

```bash
slam_toolbox:
  ros__parameters:
    # 模式配置
    mode: "mapping"
    debug_mode: false
    
    # 话题配置
    odom_frame: "odom"
    base_frame: "base_link"
    map_frame: "map"
    scan_topic: "/scan"
    
    # 坐标变换设置
    publish_tf: true
    publish_map_tf: true

    # 地图起始位姿
    map_start_pose:
      x: 0.0
      y: 0.0
      yaw: 0.0


    # 地图参数
    map_file_name: "karto_slam_map"
    map_update_interval: 5.0
    resolution: 0.05
    
    
    # 扫描匹配参数
    use_scan_matching: true
    use_scan_barycenter: true
    minimum_travel_distance: 0.5
    minimum_travel_heading: 0.5
    scan_buffer_size: 10
    
    # 扫描匹配器参数
    link_match_minimum_response_fine: 0.1
    link_scan_maximum_distance: 10.0
    loop_search_maximum_distance: 5.0
    
    # 协方差参数
    odom_covariance: [0.1, 0.0, 0.0, 0.0, 0.0, 0.0,
                      0.0, 0.1, 0.0, 0.0, 0.0, 0.0,
                      0.0, 0.0, 0.1, 0.0, 0.0, 0.0,
                      0.0, 0.0, 0.0, 0.1, 0.0, 0.0,
                      0.0, 0.0, 0.0, 0.0, 0.1, 0.0,
                      0.0, 0.0, 0.0, 0.0, 0.0, 0.1]
    
    # 优化参数
    do_map_publishing: true
    enable_interactive_mode: true
    
    # 雷达范围
    min_range: 0.2
    max_range: 20.0
    
    # 里程计参数
    use_odom: true
    use_imu: false
    
    # 地图保存参数
    save_pose_rate: 0.5
    save_scans: true
    
    # 性能参数
    throttle_scans: 1
    transform_timeout: 0.2
    laser_scan_topic_queue_size: 50

    
    # 闭环检测参数
    loop_closure_rate: 1.0
    loop_match_minimum_chain_size: 10
    loop_match_maximum_variance_coarse: 3.0
    loop_match_minimum_response_coarse: 0.35
    loop_match_minimum_response_fine: 0.45

# 坐标变换配置
transform_manager:
  ros__parameters:
    cache_time: 10.0
```

`gedit ~/slam_ws/src/karto_slam/package.xml`

```bash
<?xml version="1.0"?>
<?xml-model href="http://download.ros.org/schema/package_format3.xsd" schematypelocation="http://www.ros.org/repos/cfg/list?rosdistro=$ROS_DISTRO&path=package-3.xsd"?>
<package format="3">
  <name>karto_slam</name>
  <version>0.0.0</version>
  <description>Karto SLAM implementation using slam_toolbox</description>
  <maintainer email="user@todo.todo">user</maintainer>
  <license>Apache-2.0</license>

  <buildtool_depend>ament_cmake</buildtool_depend>

  <depend>slam_toolbox</depend>
  <depend>launch</depend>
  <depend>launch_ros</depend>

  <test_depend>ament_lint_auto</test_depend>
  <test_depend>ament_lint_common</test_depend>

  <export>
    <build_type>ament_cmake</build_type>
  </export>
</package>
```

`gedit ~/slam_ws/src/karto_slam/CMakeLists.txt`

```bash
cmake_minimum_required(VERSION 3.8)
project(karto_slam)

if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

# find dependencies
find_package(ament_cmake REQUIRED)

# install launch files
install(DIRECTORY
  launch
  config
  DESTINATION share/${PROJECT_NAME}/
)

ament_package()
```

### 编译运行
```bash
cd ~/slam_ws
colcon build --packages-select karto_slam
```

```bash
ros2 launch lidar_filter lidar_filter_with_driver.launch.py
ros2 launch rf2o_laser_odometry rf2o_laser_odometry.launch.py publish_tf:=true
# 异步建图
ros2 launch karto_slam online_launch.py mode:=mapping sync_async:=async

# 异步定位
ros2 launch karto_slam online_launch.py mode:=localization sync_async:=async

# 同步建图
ros2 launch karto_slam online_launch.py mode:=mapping sync_async:=sync

# 同步定位
ros2 launch karto_slam online_launch.py mode:=localization sync_async:=sync

# 分布式通信时本机启动rviz
rviz2 -d ~/lidar_mode.rviz
```
