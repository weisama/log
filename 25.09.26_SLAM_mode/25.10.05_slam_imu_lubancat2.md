# 基于鲁班猫2-Humble，镭神 N10 SLAM添加pixhawk飞控的imu数据
**px4版本为1.13.3，其余版本没有验证

---

## 机载电脑下载MAVROS

修改QGC中参数
```
# mavlink通道0设置为TELLEM1
- MAV_0_CONFIG     TELLEM1
# 设置为onborad模式才会发送线加速度
- MAV_0_MODE       Onboard
# 设置TELLEM1通信波特率
- SER_TEL1_BAUD    921600 8N1
# 设置TELLEM1的速度b/s，0则飞控自适应
- MAV_0_RATE       0
```

```
# QGC的MavLink工作台输入
mavlink status streams
# 可见imu输出频率2.5
instance #0:
HIGHRES_IMU                    50.00 (2.500)
# 设置输出频率50hz
mavlink stream -r 50 -s HIGHRES_IMU
mavlink status streams
# 可见
instance #0:
HIGHRES_IMU                    50.00 (2.500)
```

鲁班猫通过串口连接TELLEM2  
TELLEM1  5V TX RX CTS RTS GND  
鲁班猫2   5V 5V GND TX RX

安装MAVROS

参考：https://blog.csdn.net/weixin_42037083/article/details/137102858

```bash
sudo apt-get install ros-humble-mavros ros-humble-mavros-extras
```

安装geographiclib

```bash
cd ~
git clone https://github.com/weisama/GeographicLib.git
sudo cp -r ~/GeographicLib /usr/share
```

设置鲁班猫2串口

```bash
sudo nano /boot/uEnv/uEnv.txt
# 取消串口3m0的注释
dtoverlay=/dtb/overlay/rk356x-lubancat-uart3-m1-overlay.dtbo
```

查看串口消息

```bash
sudo dmesg | tail
ls /dev/ttyS*
sudo usermod -aG dialout $USER
sudo chmod 777 /dev/ttyS3
```

修改mavros串口设备和波特率

```bash
sudo nano /opt/ros/humble/share/mavros/launch/px4.launch
```

```xml
<arg name="fcu_url" default="/dev/ttyS3:921600" />
```

```bash
ros2 launch mavros px4.launch
ros2 launch mavros px4.launch fcu_url:=/dev/ttyS3:921600
ros2 topic list
```

### 检查MAVROS状态

```bash
# 飞控状态
ros2 topic echo /mavros/state
# imu数据
ros2 topic echo /mavros/imu/data
# 可见imu数据坐标系为base_link，则不需要修改tf变换
```

## cartographer添加imu

### 新建配置和launch

```bash
cd ~/slam_ws/src/cartographer_navigation
cp config/mylaser.lua config/mylaser_imu.lua
gedit ~/slam_ws/src/cartographer_navigation/config/mylaser_imu.lua
```

```bash
# 修改部分
TRAJECTORY_BUILDER_2D.use_imu_data = true  -- 是否使用IMU数据#############
-- IMU相关参数（新增）
TRAJECTORY_BUILDER_2D.imu_gravity_time_constant = 10.  -- IMU重力时间常数#############
TRAJECTORY_BUILDER_2D.pose_extrapolator.use_imu_based = false  -- 对于2D SLAM，通常设置为false#############
```

```bash
cd ~/slam_ws/src/cartographer_navigation
cp launch/cartographer.launch.py launch/cartographer_imu.launch.py
gedit ~/slam_ws/src/cartographer_navigation/launch/cartographer_imu.launch.py
```

```bash
# 修改部分
    # 配置文件的完整路径
    config_dir = os.path.join(pkg_share, 'config')
    config_file = os.path.join(config_dir, 'mylaser_imu.lua')

    # Cartographer SLAM主节点
    cartographer_node = Node(
        package = 'cartographer_ros',
        executable = 'cartographer_node',
        arguments = [
            '-configuration_directory', config_dir,  # 使用自定义配置目录
            '-configuration_basename', 'mylaser_imu.lua'],  # 使用自定义配置文件
        remappings = [
            ('scan', 'scan'),  # 添加话题重映射确保订阅正确的激光话题
            ('imu', '/mavros/imu/data')],  # 添加IMU话题重映射（重要修改）
        output = 'screen'
        )
```

### 编译运行

```bash
cd ~/slam_ws
colcon build --packages-select cartographer_navigation
```

```bash
# 运行
ros2 launch mavros px4.launch
ros2 launch tf tf_broadcaster.launch.py
ros2 launch lslidar_driver lslidar_launch.py
ros2 launch cartographer_navigation cartographer_imu.launch.py
# 可视化
rviz2 -d ~/slam_ws/src/lslidar_driver/rviz/lslidar.rviz
ros2 run rqt_tf_tree rqt_tf_tree
```





















