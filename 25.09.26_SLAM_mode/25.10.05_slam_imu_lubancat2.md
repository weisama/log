# 基于鲁班猫2-Humble，镭神 N10 SLAM添加pixhawk飞控的imu数据和rf2o_laser_odometry里程计
**px4版本为1.13.3，其余版本没有验证**

---

## 机载电脑下载MAVROS

修改QGC中参数
```
# mavlink通道0设置为TELLEM1
- MAV_0_CONFIG     TELLEM1

# 设置为onborad模式才会发送线加速度
- MAV_0_MODE       Onboard

# 设置TELLEM1通信波特率
- SER_TEL1_BAUD    921600 8N1

# 设置TELLEM1的速度b/s，0则飞控自适应
- MAV_0_RATE       0
```

```
# QGC的MavLink工作台输入
mavlink status streams
# 可见imu输出频率2.5
instance #0:
HIGHRES_IMU                    50.00 (2.500)
# 设置输出频率50hz
mavlink stream -r 50 -s HIGHRES_IMU
mavlink status streams
# 可见
instance #0:
HIGHRES_IMU                    50.00 (2.500)
```

鲁班猫通过串口连接TELLEM2  
TELLEM1  5V TX RX CTS RTS GND  
鲁班猫2   5V 5V GND TX RX

安装MAVROS

参考：https://blog.csdn.net/weixin_42037083/article/details/137102858

```bash
sudo apt-get install ros-humble-mavros ros-humble-mavros-extras
```

安装geographiclib

```bash
cd ~
git clone https://github.com/weisama/GeographicLib.git
sudo cp -r ~/GeographicLib /usr/share
```

设置鲁班猫2串口

```bash
sudo nano /boot/uEnv/uEnv.txt
# 取消串口3m0的注释
dtoverlay=/dtb/overlay/rk356x-lubancat-uart3-m1-overlay.dtbo
```

查看串口消息

```bash
sudo dmesg | tail
ls /dev/ttyS*
sudo usermod -aG dialout $USER
sudo chmod 777 /dev/ttyS3
```

修改mavros串口设备和波特率

```bash
sudo nano /opt/ros/humble/share/mavros/launch/px4.launch
```

```xml
<arg name="fcu_url" default="/dev/ttyS3:921600" />
```

```bash
ros2 launch mavros px4.launch
ros2 launch mavros px4.launch fcu_url:=/dev/ttyS3:921600
ros2 topic list
```

### 检查MAVROS状态

```bash
# 飞控状态
ros2 topic echo /mavros/state

# EKF2的imu数据,坐标系为base_link则不修改tf变换
ros2 topic echo /mavros/imu/data

# 频率50hz满足要求
ros2 topic hz /mavros/imu/data

# 原始imu数据，不建议使用
ros2 topic echo /mavros/imu/data_raw
```

## cartographer添加imu和rf2o_laser_odometry

### 新建配置和launch

```bash
cd ~/slam_ws/src/cartographer_navigation
cp config/mylaser.lua config/mylaser_imu.lua
gedit ~/slam_ws/src/cartographer_navigation/config/mylaser_imu.lua
```

```bash
# 修改部分
TRAJECTORY_BUILDER_2D.use_imu_data = true  -- 是否使用IMU数据#############
-- IMU相关参数（新增）
TRAJECTORY_BUILDER_2D.imu_gravity_time_constant = 10.  -- IMU重力时间常数#############
TRAJECTORY_BUILDER_2D.pose_extrapolator.use_imu_based = false  -- 对于2D SLAM，通常设置为false#############
```

```bash
cd ~/slam_ws/src/cartographer_navigation
cp launch/cartographer.launch.py launch/cartographer_imu.launch.py
gedit ~/slam_ws/src/cartographer_navigation/launch/cartographer_imu.launch.py
```

```bash
# 修改部分
# 配置文件的完整路径
    config_dir = os.path.join(pkg_share, 'config')
    config_file = os.path.join(config_dir, 'mylaser_imu.lua')

    # Cartographer SLAM主节点
    cartographer_node = Node(
        package = 'cartographer_ros',
        executable = 'cartographer_node',
        arguments = [
            '-configuration_directory', config_dir,  # 使用自定义配置目录
            '-configuration_basename', 'mylaser_imu.lua'],  # 使用自定义配置文件
        remappings = [
            ('scan', 'scan'),  # 添加话题重映射确保订阅正确的激光话题
            ('imu', '/mavros/imu/data'), # 添加IMU话题重映射（重要修改）
            ('odom', '/odom_rf2o')], 
        output = 'screen'
        )
```

### 编译运行

```bash
cd ~/slam_ws
colcon build --packages-select cartographer_navigation
```

```bash
# 运行
ros2 launch mavros px4.launch
ros2 launch tf tf_broadcaster.launch.py
ros2 launch lslidar_driver lslidar_launch.py
ros2 launch rf2o_laser_odometry rf2o_laser_odometry.launch.py
ros2 launch cartographer_navigation cartographer_imu.launch.py
# 可视化
rviz2 -d ~/slam_ws/src/lslidar_driver/rviz/lslidar.rviz
ros2 run rqt_tf_tree rqt_tf_tree
```

## 创建一键运行的脚本

`gedit ~/run_slam.sh`

**举例**
```bash
#!/bin/bash

echo "启动 SLAM 系统..."

# 存储后台进程的PID
PIDS=()

# 定义清理函数
cleanup() {
    echo "关闭所有 ROS2 进程..."
    for pid in "${PIDS[@]}"; do
        kill $pid 2>/dev/null
    done
    killall ros2 2>/dev/null
    exit 0
}

# 设置信号捕获
trap cleanup SIGINT SIGTERM EXIT

# 启动所有进程
ros2 launch mavros px4.launch &
PIDS+=($!)

sleep 0

ros2 launch tf tf_broadcaster.launch.py &
PIDS+=($!)

sleep 0

ros2 launch lslidar_driver lslidar_launch.py &
PIDS+=($!)

sleep 0

echo "启动 RViz2 可视化..."
rviz2 -d ~/slam_ws/src/lslidar_driver/rviz/lslidar.rviz

# RViz2 退出后会自动执行 cleanup
```

```bash
chmod +x run_slam.sh
~/run_slam.sh
```

## SLAM_TOOLBOX

```bash
sudo apt install ros-$ROS_DISTRO-slam-toolbox
```

```bash
cd ~/slam_ws/src
ros2 pkg create karto_slam --build-type ament_cmake --dependencies rclcpp slam_toolbox nav2_map_server tf2_ros
mkdir -p karto_slam/launch karto_slam/config
```

`gedit ~/slam_ws/src/karto_slam/launch/karto_slam.launch.py`

```bash
from launch import LaunchDescription
from launch_ros.actions import Node
from launch.actions import DeclareLaunchArgument
from launch.substitutions import LaunchConfiguration, PathJoinSubstitution
from launch_ros.substitutions import FindPackageShare

def generate_launch_description():
    # 获取功能包路径
    pkg_share = FindPackageShare('karto_slam')
    
    return LaunchDescription([
        DeclareLaunchArgument(
            'use_sim_time',
            default_value='false',
            description='Use simulation clock if true'
        ),
        
        DeclareLaunchArgument(
            'params_file',
            default_value=PathJoinSubstitution([pkg_share, 'config', 'karto_slam_params.yaml']),
            description='Full path to the parameter file'
        ),
        
        Node(
            package='slam_toolbox',
            executable='async_slam_toolbox_node',
            name='slam_toolbox',
            output='screen',
            parameters=[LaunchConfiguration('params_file')],
            remappings=[
                ('scan', '/scan'),  # 确保订阅正确的激光雷达话题
                ('/tf', 'tf'),
                ('/tf_static', 'tf_static')
            ]
        )
    ])
```

`gedit ~/slam_ws/src/karto_slam/config/karto_slam_params.yaml`

```bash
slam_toolbox:
  ros__parameters:
    # 基本参数
    use_sim_time: False
    map_frame: "map"
    odom_frame: "odom" 
    base_frame: "base_link"
    scan_topic: /scan             # 扫描话题名称
    use_odometry: false           # 禁用里程计输入
    use_imu: false                # 禁用IMU输入
    publish_odom: true            # SLAM节点自己发布里程计
    
    # Karto SLAM核心参数
    max_range: 10.0               # 激光雷达最大有效距离
    minimum_travel_distance: 0.1  # 更小的移动阈值（无里程计时需要更敏感）
    minimum_travel_heading: 0.1   # 更小的旋转阈值
    scan_buffer_size: 10          # 扫描缓冲区大小
    use_scan_matching: true       # 启用扫描匹配（关键）
    resolution: 0.05              # 地图分辨率
    
    # 扫描匹配参数（无里程计时需要更强的匹配能力）
    correlation_search_space: 3.0     # 搜索空间大小
    correlation_search_space_dim: 0.3 # 搜索空间维度
    correlation_search_space_resolution: 0.01 # 搜索分辨率
    
    # 优化参数
    enable_loop_closing: true     # 启用回环检测（对无里程计很重要）
    loop_search_maximum_distance: 5.0  # 回环搜索最大距离
    
    # 无里程计时的特殊设置
    mode: "mapping"               # 建图模式
    transform_publish_period: 0.05 # 变换发布周期
    map_update_interval: 5.0      # 地图更新间隔
```

`gedit ~/slam_ws/src/karto_slam/CMakeLists.txt`

```bash
install(DIRECTORY launch config
  DESTINATION share/${PROJECT_NAME}
)
```

`gedit ~/slam_ws/src/karto_slam/package.xml`

```bash
<depend>rclcpp</depend>
<depend>slam_toolbox</depend>
<depend>nav2_map_server</depend>
<depend>tf2_ros</depend>
```

### 编译运行

```bash
cd ~/slam_ws
colcon build --packages-select karto_slam
```

```bash
~/run_slam.sh
ros2 launch karto_slam karto_slam.launch.py
```









