# 模块搭载ubuntu22实现slam

---

## 下载功能包编译

#### 初始化工作空间

```bash
mkdir -p ~/slam_ws/src
cd ~/slam_ws
rosdepc update
rosdepc install --from-paths src --ignore-src -y
colcon build
```

#### 拉取功能包编译

```bash
cd ~
git clone -b main https://github.com/weisama/slam_lubancat2.git
sudo cp -r ~/slam_lubancat2/* ~/slam_ws/src
sudo rm -rf ~/slam_lubancat2

cd ~/slam_ws
rosdepc install --from-paths src --ignore-src -y
```

#### 安装功能包所需软件
```bash
sudo apt install -y --allow-downgrades udev ros-humble-diagnostic-updater libpcap-dev libicu70=70.1-2 libpcl-dev ros-$ROS_DISTRO-pcl-conversions ros-$ROS_DISTRO-pcl-ros
sudo apt install -y ros-$ROS_DISTRO-tf2-tools ros-$ROS_DISTRO-rqt-tf-tree libboost-all-dev
sudo apt install -y ros-humble-cartographer ros-humble-cartographer-ros
sudo apt install -y ros-$ROS_DISTRO-slam-toolbox
```

#### 编译
```bahs
cd ~/slam_ws
colcon build --packages-select lslidar_msgs
colcon build --packages-select lslidar_driver
colcon build --packages-select lidar_filter
colcon build --packages-select tf
colcon build --packages-select serial_odom_sender
colcon build --packages-select rf2o_laser_odometry
colcon build --packages-select cartographer_navigation
colcon build --packages-select karto_slam
colcon build --packages-select upper
```

### 环境变量

```bash
mousepad ~/.bashrc
source ~/slam_ws/install/setup.bash
```


---

## 基础配置

### 固定雷达串口
```bash
ls /dev/tty*
sudo nano /etc/udev/rules.d/99-usb-serial.rules
```

```udev
SUBSYSTEM=="tty", ATTRS{idVendor}=="1a86", ATTRS{idProduct}=="55d4", SYMLINK+="usb_robot", MODE="0666"
```

```bash
sudo udevadm control --reload-rules
sudo udevadm trigger
ls -l /dev/usb_robot
```

### 测试上位机和机器人端串口

<img width="6251" height="3858" alt="image" src="https://github.com/user-attachments/assets/e375fba3-fe40-4d68-b4a1-01e488595c8d" />

模块端
```bash
ls /dev/ttyS*
/dev/ttyS3  /dev/ttyS4

# 先测试TX/RX短接回显
sudo apt install minicom -y
sudo minicom -D /dev/ttyS3 -b 921600
sudo minicom -D /dev/ttyS4 -b 115200

# 赋予权限后重启，测试功能包发送
sudo usermod -a -G dialout $USER
ros2 launch upper upper_launch.py serial_port:=/dev/ttyS3
```

本机
```bash
ls /dev/ttyUSB*
/dev/ttyUSB0

# 先测试TX/RX短接回显
sudo apt install minicom -y
sudo minicom -D /dev/ttyUSB0 -b 921600
```

---

## 功能包测试

```bash
# 本机ros分布式rviz可视化
rviz2 -d ~/lslidar.rviz

# 脚本启动
~/run_slam.sh


# tf变换
ros2 launch tf tf_broadcaster.launch.py
ros2 run rqt_tf_tree rqt_tf_tree

# 启动雷达
ros2 launch lslidar_driver lslidar_launch.py
ros2 topic list

# 启动雷达并固定点云数量，发布tf
ros2 launch lidar_filter lidar_filter_with_driver.launch.py
ros2 topic echo /scan --no-arr | grep "length:"

# rf2o_laser_odometry里程计
ros2 launch lidar_filter lidar_filter_with_driver.launch.py
ros2 launch rf2o_laser_odometry rf2o_laser_odometry.launch.py publish_tf:=true

# cartographer建图
ros2 launch lidar_filter lidar_filter_with_driver.launch.py
ros2 launch rf2o_laser_odometry rf2o_laser_odometry.launch.py publish_tf:=false
ros2 launch cartographer_navigation cartographer.launch.py

# SLAM_TOOLBOX建图
ros2 launch lidar_filter lidar_filter_with_driver.launch.py
ros2 launch rf2o_laser_odometry rf2o_laser_odometry.launch.py publish_tf:=true
# 异步建图快，同步占用少，建图会更新map，定位不更新map
# 异步建图
ros2 launch karto_slam online_launch.py mode:=mapping sync_async:=async
# 同步建图
ros2 launch karto_slam online_launch.py mode:=mapping sync_async:=sync
# 异步定位
ros2 launch karto_slam online_launch.py mode:=localization sync_async:=async
# 同步定位
ros2 launch karto_slam online_launch.py mode:=localization sync_async:=sync

# Gmapping
ros2 launch lidar_filter lidar_filter_with_driver.launch.py
ros2 launch rf2o_laser_odometry rf2o_laser_odometry.launch.py publish_tf:=true
ros2 launch gmapping_launch gmapping_launch.py
```

## 录制话题

```bash
# 录制所有话题
ros2 bag record -o ~/slam_ws/src/upper/bag -a
ls ~/slam_ws/src/upper/bag

# 播放话题
ros2 bag play ~/slam_ws/src/upper/bag/*.db3

# 删除后才能重新录制
sudo rm  -rf ~/slam_ws/src/upper/bag
```







