# usb摄像头识别tag码方位和姿态6原数(Apriltag)

---
- https://blog.csdn.net/weixin_51200029/article/details/142338545
- https://blog.csdn.net/2301_76165902/article/details/142000488
- https://blog.csdn.net/Bing_Lee/article/details/141833307

```bash
ssh -Y chen@192.168.110.234  (不带散热)
ssh -Y chen@192.168.110.153　（带散热）
passcode:123
```

### 测试摄像头正常工作

```bash
ls /dev/video*
sudo apt install ffmpeg
ffplay /dev/video0
sudo apt install libv4l-0 libv4l-dev
sudo apt install v4l-utils
v4l2-ctl -d /dev/video0 --info
```

### ROS1创建工作空间

```bash
rm -rf ~/catkin_ws/
mkdir -p ~/catkin_ws/src
cd ~/catkin_ws/src
catkin_init_workspace
cd ~/catkin_ws/
catkin_make
```

### ROS2创建工作空间

```bash
rm -rf ~/catkin_ws/
mkdir -p ~/catkin_ws/src
cd ~/catkin_ws
sudo rosdep init
rosdep install --from-paths src --ignore-src -y
colcon build
```

---

### 安装usb_cam功能包

#### 选项一

软件包方式安装usb_cam功能包（将视频流发布为ros2话题，便于其他节点（OpenCV、AprilTag等）订阅、处理）

```bash
sudo apt-get install ros-melodic-usb-cam
source /opt/ros/melodic/setup.bash
roslaunch usb_cam usb_cam-test.launch
```

修改相应配置

```bash
gedit ~/catkin_ws/src/usb_cam/config/params_1.yaml
```

例如video_device: "/dev/video0"

#### 选项二（推荐）

```bash
cd ~/catkin_ws/src
git clone https://github.com/ros-drivers/usb_cam.git 
sudo apt install ros-humble-camera-info-manager
sudo apt install python3-pydantic
```

修改相应配置

```bash
gedit ~/catkin_ws/src/usb_cam/config/params_1.yaml
```

例如video_device: "/dev/video0"

编译

```bash
cd ~/catkin_ws
rosdep install --from-paths src --ignore-src -y
colcon build
source ~/catkin_ws/install/setup.bash
ros2 launch usb_cam camera.launch.py　　（报错就重启）
rviz2
```

---

### 安装apriltag-ros和安装Apriltag库

https://blog.csdn.net/wangmj_hdu/article/details/112668252

#### 安装Apriltag库

```bash
git clone https://github.com/AprilRobotics/apriltag.git 
cd apriltag
mkdir build
cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
make
sudo make install
```

#### 安装apriltag_ros功能包***

```bash
mkdir -p ~/catkin_ws/src && cd ~/catkin_ws/src
git clone https://github.com/christianrauch/apriltag_ros.git  （适配humble版本）
sudo apt install ros-humble-image-proc
```

修改配置文件

```bash
gedit ~/catkin_ws/src/apriltag_ros/cfg/tags_36h11.yaml
```

```yaml
size: 0.1
ids: [1, 2]
frames: [tag1, tag2]
sizes: [0.1, 0.1] 
```

```bash
gedit ~/catkin_ws/src/apriltag_ros/launch/camera_36h11.launch.yml
```

```bash
cd ~/catkin_ws
rosdep install --from-paths src --ignore-src -r -y  （配置依赖项）
colcon build --symlink-install  （编译并创建符号连接）
```

运行AprilTag检测，标定后可用

```bash
ros2 run apriltag_ros apriltag_node --ros-args \
  -r image_rect:=/camera1/image_raw \　　　# 话题名称为camera1/image_raw
  -r camera_info:=/camera1/camera_info \   # 话题名称为camera1/camera_info
  --params-file `ros2 pkg prefix apriltag_ros`/share/apriltag_ros/cfg/tags_36h11.yaml
```

#### 安装通信消息功能包

```bash
cd ~/catkin_ws/src
git clone https://github.com/christianrauch/apriltag_msgs.git 
cd ~/catkin_ws
colcon build --packages-select apriltag_msgs
source install/setup.bash
```

---

### 相机标定，有畸变参数才能计算位置和旋转角

```bash
sudo apt-get install ros-humble-camera-calibration
sudo apt update
sudo apt install libswscale-dev libavcodec-dev   (安装色彩转化库)**
ros2 launch usb_cam camera.launch.py  （启动摄像头驱动节点（标定前启动））（报错就重启）
```

注意修改网格数量和大小

```bash
ros2 run camera_calibration cameracalibrator \
  --size 6x9 \
  --square 0.025 \
  image:=/camera1/image_raw \
  camera:=/camera1 
```

（推荐）

```bash
ros2 run camera_calibration cameracalibrator --size 6x9 --square 0.025 --ros-args -r image:=/camera1/image_raw -p camera:=camera:=/camera1
```

标定数据不必过多（80 samples以内），calibrate按钮激活后点击，等待数据计算（时间较长），完成后点击save即可保存为一个压缩包，保存在/tmp

标定数据保存后

```bash
mkdir ~/catkin_ws/src/usb_cam/calibration
tar -xzvf /tmp/calibrationdata.tar.gz -C ~/catkin_ws/src/usb_cam/calibration　（也可以手动解压保存到文件夹）
gedit ~/catkin_ws/src/usb_cam/launch/usb_cam-test.launch   （如果手动替换数据则不必需这一行）
```

添加

```xml
<param name="camera_info_url" type="string" value="file://$(find usb_cam)/calibration/ost.yaml" />
```

（也可以直接使用ost.yaml的内容替换~/config/camera_info.yaml内容）

---

### 生成二维码

#### 只能识别6*6

https://chaitanyantr.github.io/apriltag.html

```bash
source /opt/ros/humble/setup.bash
source ~/catkin_ws/devel/setup.bash（在ros1） 或者　source ~/catkin_ws/install/setup.bash （在ros2）（每次启动或找不到功能包都需要重新加载环境变量）
```

打开相机

```bash
ros2 launch usb_cam camera.launch.py  （报错就重启）
```

查看话题列表

```bash
ros2 topic
```

开启识别（注意与话题名称对应,注意是camera1/..　还是camera/..）（注意tag家族，本日志使用36h11，若使用其他家族，需要在~/catkin_ws/src/apriltag_ros/cfg/tags_36h11.yaml和对应源码修改，详问AI）

```bash
ros2 run apriltag_ros apriltag_node --ros-args \
  -r image_rect:=/camera1/image_raw \　　　# 话题名称为camera1/image_raw
  -r camera_info:=/camera1/camera_info \   # 话题名称为camera1/camera_info
  --params-file `ros2 pkg prefix apriltag_ros`/share/apriltag_ros/cfg/tags_36h11.yaml
```

（可能报错：2025-07-16 16:16:54.170 [RTPS_TRANSPORT_SHM Error] Failed init_port fastrtps_port7415: open_and_lock_file failed -> Function open_port_internal）不影响使用

查看摄像头画面，使用rviz2

查看话题列表

```bash
ros2 topic list
```

获取识别的tag数据

```bash
ros2 topic echo /apriltag_detections
```
