# 无人机机载电脑树莓派ubuntu22连接Nokov动捕系统，实现定点飞行
https://blog.csdn.net/weixin_45031928/article/details/142050814

---

## Nokov动捕软件设置

实验室电脑打开动捕软件  
接上交换机网线，设置以太网1的tcp4协议ip代理，10.1.1.198，255.255.255.0  
动捕软件连接，播放，启用VRPN

---

## ssh远程连接机载电脑，以下操作在机载电脑树莓派4b上

```bash
ssh -Y chen@10.1.1.115
```

---

## 机载电脑安装vrpn获取坐标

### 安装vrpn库，用于从wifi中获取动捕数据

```bash
git clone https://github.com/vrpn/vrpn.git
mkdir -p vrpn/build
cd vrpn/build
cmake ..
make -j8
sudo make install
```

### 安装vrpn_listener功能包，用于从wifi中获取动捕数据

树莓派连接，动捕软件VPRN流同一个Wifi

```bash
cd ~
git clone https://github.com/efc-robot/vrpn_client_ros2
mkdir -p ~/catkin_ws/src
cp -r ~/vrpn_client_ros2/src/vrpn_listener ~/catkin_ws/src
```

连接设置

```bash
gedit ~/catkin_ws/src/vrpn_listener/config/params.yaml
```

填入：

```yaml
server: 10.1.1.198  # 动捕软件网卡地址
port: 3883
frame_id: "world"
```

编译

```bash
cd ~/catkin_ws
colcon build --packages-select vrpn_listener
```

添加环境变量

```bash
gedit ~/.bashrc
```

追加：

```bash
source ~/catkin_ws/install/setup.bash
```

---

## 坐标系说明

https://docs.px4.io/v1.13/en/ros/external_position_estimation.html  
px4坐标数据大多遵循NED，房间朝向为东北  
为使得坐标数据可视性强，假定房间朝向为东  
设定参数EKF2_MAG_TYPE=none，不安装GPS，使得无人机找不着北，上电默认机头朝向为北  
动捕标定（map-ENU）x指向假定东（即房间朝向，后续东都默认为假定东）

### px4飞控内部坐标系：

本地坐标系 (Local Frame)，NED (North-East-Down)  
X轴指向北，Y轴指向东，Z轴指向下  
QGC的mavlink检测中VISON_POSITION_ESTIMATE(frame_id=map)、ODOMETRY(frame_id=1)、LOCAL_POSITION_NED的坐标都遵循此坐标系

机体坐标系 (Body Frame)  
FRD (Front-Right-Down)  
X轴指向机头，Y轴指向无人机右侧，Z轴指向无人机底部  
无人机大部分姿态、速度遵循此坐标系

### ROS（MAVLink 协议）中常用坐标系

map 坐标系 (全局地图坐标系)，ENU (East-North-Up)  
X轴指向东，Y轴指向北，Z轴指向上  
动捕标定采用此坐标系  
刚体创建采用此坐标系

odom 坐标系 (里程计坐标系)  
FLU(Front-Left-Up)  
无人机初始化时建立，不以无人机旋转而改变  
X轴指向前方，Y轴指向左侧，Z轴指向上

### 动捕校准

L校准和T校准（ENU坐标系）  
房间朝向为x，左侧为y，上为z

### 创建刚体

反光球粘贴建议：无人机顶部能被全部摄像头捕捉，以金字塔五个定点的形式，需注意非对称  
map 坐标系 (全局地图坐标系)，ENU (East-North-Up)  
无人机放置参考：机头朝向=房间朝向=东  
冻结帧，选中反光球建立刚体，命名为t1、t2  
（机头朝前）shift选中全部反光球建立刚体  
骨骼朝向y，指向水平面  
创建后校验：刚体xyz等同于动捕坐标系xyz，机头为刚体x，左侧为刚体y，上为 刚体z

### 无人机上电时遵循以下摆放

机头朝向=房间朝向=假定东  
后续功能包消除无人机摆放位置非动捕原点  
后续参数设置后，上电后获取到动捕坐标可在qgc见到机头朝向东（上电默认北）

---

## px4参数设置

### 重要参数，关乎动捕定点飞行精度

- EKF2_EVP_NOISE = 1.0  
  为动捕位置数据的方差，影响动捕位置数据的置信度  
  过大会导致移动过程动捕位置置信度较低，来回震荡  
  过小会导致LOCAL_POSITION_NED发散，EKF2估计坐标偏离动捕位置  
  实测0.1过小

- EKF2_EVA_NOISE = 10  
  为动捕姿态数据的方差，影响动捕姿态数据的置信度

- EKF2_EV_DELAY = 125  
  动捕数据延迟，从PX4_log.txt中日志查看动捕数据四元素和imu四元素的延迟

- EKF2_NOAID_NOISE  
  为IMU数据的方差，影响IMU数据的置信度  
  默认10，设置越大使得IMU数据对位置推算影响变小，不建议改变

### 重要参数，禁用其他传感器，使用动捕作为位姿数据来源

- EKF2_AID_MASK = 24  
  勾选外部视觉（动捕）位置和yaw，用于EKF2（扩展卡尔曼），使用动捕作为位姿数据来源  
  vision velocity fusion (位8: 融合速度，若动捕提供速度数据)，还未开发，需动捕数据发送到/mavros/odometry/out

- EKF2_HGT_MODE = vison  
  高度使用外部视觉数据

- EKF2_MAG_TYPE = one  
  去除磁力计，将会找不着北，上电机头朝向=房间朝向=假定北

- EKF2_EV_POS_X/Y/Z = 0  
  无人机位于动捕原点偏移

- SYS_MC_EST_GROUP = ekf2  
  无人机算法使用EKF2（扩展卡尔曼）

### 其他参数

- MIS_TAKEOFF_ALT = 1  
  无人机降落最小高度

- CBRK_SUPPLY_CHK = 894281  
  无备用电池允许遥控解锁

- EKF2_BARO_GATE  
  设置为一个很大的值 (例如 1000)会大幅降低或禁用气压计对高度的影响

- SDLOG_PROFILE = 129  
  日志记录内容默认+机器视觉

- SDLOG_MODE = from boot until shutdown  
  日志记录从上电到掉电

- SYS_CTRL_ALLOC = Enable  
  允许控制分配功能

- MAV_1_CONFIG = TELLEM2  
  设置TELLEM2用于MAVLink通信通道

- MAV_1_MODE = Onboard  
  配置MAVLink数据流模式

- SER_TEL1_BAUD = 961200 8N1  
  设置波特率和数据格式

- COM_RC_OVERRIDE = 3  
  允许遥控器打杆时强制退出Offboard模式，并切换至Position模式

- COM_RC_STICK_OV = 20  
  定义打杆幅度阈值（例如摇杆偏移超过20%触发）

---

## 校验机载电脑可以获取坐标

以上步骤完成后，可以开始校验坐标是否正确获取

```bash
sudo apt install ros-${ROS_DISTRO}-topic-tools
```

启用vrpn获取数据

```bash
ros2 launch vrpn_listener sync_entity_state.launch
```

查看话题内容

```bash
ros2 topic list
ros2 topic echo /vrpn/t1/pose
ros2 topic echo /vrpn/t1/twist
```

启动mavlink

```bash
ros2 launch mavros px4.launch
```

转发话题给PX4

```bash
ros2 run topic_tools relay /vrpn/t1/pose /mavros/vision_pose/pose
ros2 run topic_tools relay /vrpn/dt1/twist /mavros/vision_speed/speed_twist
ros2 topic echo /mavros/vision_pose/pose
ros2 topic echo /mavros/vision_speed/speed_twist
```

检查MAVROS状态

```bash
ros2 topic echo /mavros/state
```

### QGC的mavlink检测中查看数据

- 动捕数据预测后(frame_id=map)  
  VISON_POSITION_ESTIMATE

- 动捕原始数据(frame_id=1，NED)  
  ODOMETRY

- EKF2融合后无人机各数据  
  LOCAL_POSITION_NED

---

## 创建转发话题功能包

创建转发话题功能包，并记录初始位置，后续数据都转发相对初始位置的坐标  
保证无人机上电后收到的动捕数据为（0，0，0），无人机可以非动捕原点，任意摆放

```bash
cd ~/catkin_ws/src
ros2 pkg create vrpn_relative_pose --build-type ament_cmake --dependencies rclcpp geometry_msgs tf2 tf2_geometry_msgs
cd ~/catkin_ws/src/vrpn_relative_pose
gedit ~/catkin_ws/src/vrpn_relative_pose/src/vrpn_relative_pose_node.cpp
gedit CMakeLists.txt
gedit package.xml
mkdir launch
gedit launch/vrpn_relative.launch.py
cd ~/catkin_ws/
colcon build --packages-select vrpn_relative_pose
```

### 运行测试

```bash
ros2 launch vrpn_listener sync_entity_state.launch
source ~/catkin_ws/install/setup.bash
ros2 launch vrpn_relative_pose vrpn_relative.launch.py
ros2 topic echo /mavros/vision_pose/pose
```

修改配置文件中t1、t2，决定转发/vrpn/t1/pose到/mavros/vision_pose/pose  
其他转发到/vrpn/other/pose

```bash
gedit ~/catkin_ws/src/vrpn_relative_pose/launch/vrpn_relative.launch.py
```

---

## 设置脚本开机自启动

```bash
gedit ~/offboard_autostart.sh
```

写入：

```bash
#!/bin/bash
# 加载环境
source /opt/ros/humble/setup.bash
source /home/chen/catkin_ws/install/setup.bash
sleep 3
# 启动命令
ros2 launch vrpn_listener sync_entity_state.launch &
sleep 3
ros2 launch mavros px4.launch &
sleep 3
ros2 launch vrpn_relative_pose vrpn_relative.launch.py &
# 防止脚本退出
while true; do sleep 1000; done
```

```bash
chmod +x ~/offboard_autostart.sh
```

```bash
sudo nano /etc/systemd/system/offboard_autostart.service
```

写入：

```
[Unit]
Description=ROS 2 Autostart Service
After=network.target
[Service]
Type=simple
User=chen
ExecStart=/home/chen/offboard_autostart.sh
Restart=on-failure
RestartSec=5s
[Install]
WantedBy=multi-user.target
```

```bash
sudo systemctl daemon-reload
sudo systemctl enable offboard_autostart.service
sudo systemctl start offboard_autostart.service
```

停止服务

```bash
sudo systemctl stop offboard_autostart.service
```

禁用开机自启动

```bash
sudo systemctl disable offboard_autostart.service
```

---

## 遇到问题排查

1. Nokov动捕软件能否识别出正确的刚体，见“坐标系说明”部分验证动捕坐标系和刚体坐标系正确  
2. 无法切换为定点模式，检查px4基础参数是否正确配置，见“px4参数设置”部分  
3. 飞行10s~60s后开始漂移，qgc查看到LOCAL_POSITION_NED坐标数据明显失真  
   说明坐标噪声已经超过设置的噪声容忍参数，飞控不采用动捕坐标，调参一步步增大EKF2_EVP_NOISE  
4. 定点飞行来回摆动，在不触发③的情况下，减小EKF2_EVP_NOISE，飞控更信任动捕坐标，增强坐标对无人机的约束力  
5. 正确的延迟补偿参数EKF2_EV_DELAY，可以减小坐标噪声方差从而减小EKF2_EVP_NOISE  
   见25.06.28_PX4_log，日志查看动捕四元素和imu四元数的延迟，以正确设置EKF2_EV_DELAY  
6. 完整搭建一台动捕坐标定位的定点飞行无人机，见其他日志