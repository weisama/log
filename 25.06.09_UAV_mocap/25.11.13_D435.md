# D435双目相机获取位置信息

---

## D435驱动安装

安装教程[https://blog.csdn.net/qq_45445740/article/details/143613024]

### 安装驱动和上位机

```
sudo mkdir -p /etc/apt/keyrings
curl -sSf https://librealsense.intel.com/Debian/librealsense.pgp | sudo tee /etc/apt/keyrings/librealsense.pgp > /dev/null
sudo apt-get install apt-transport-https
echo "deb [signed-by=/etc/apt/keyrings/librealsense.pgp] https://librealsense.intel.com/Debian/apt-repo $(lsb_release -cs) main" |   sudo tee /etc/apt/sources.list.d/librealsense.list
sudo apt-get update
sudo apt-get install librealsense2-dkms
sudo apt-get install librealsense2-utils 
sudo apt-get install librealsense2-dev
sudo apt-get install librealsense2-dbg
```

**驱动安装过程如需设置BOOT密码，别设置**

**若设置，则重启进入BIOS界面关闭Secure Boot**

```
# 确保可以检测到双目
ls /dev/video*

# 启动上位机
realsense-viewer
```

### 安装驱动功能包

```
cd ~/ws_livox/src
git clone https://github.com/IntelRealSense/realsense-ros.git -b ros2-master

cd ~/ws_livox
colcon build --packages-select realsense2_camera realsense2_camera_msgs realsense2_description

# 发布点云话题
ros2 launch realsense2_camera rs_d405_pointcloud_launch.py

# 发布深度图，rviz查看这个话题类型为image
ros2 launch realsense2_camera rs_align_depth_launch.py
ros2 topic echo /camera/camera/aligned_depth_to_color/image_raw
```

## 使用ORB_SLAM3建图

#### 安装环境
```
sudo apt install git cmake gcc g++ mlocate
sudo apt install ros-$ROS_DISTRO-vision-opencv && sudo apt install ros-$ROS_DISTRO-message-filters
sudo apt install python3-ament-package
```

#### 安装 Eigent3

```
cd ~
git clone -b 3.3.4 https://github.com/eigenteam/eigen-git-mirror.git
cd eigen-git-mirror
mkdir build
cd build
cmake ..
sudo make install
sudo cp -r /usr/local/include/eigen3/Eigen /usr/local/include
rm -rf ~/eigen-git-mirror
```

#### 安装 Pangolin0.6

```
# 安装Pangolin0
cd ~
git clone -b v0.6 https://github.com/stevenlovegrove/Pangolin.git
sudo apt install libgl1-mesa-dev
sudo apt install libglew-dev
sudo apt install cmake
sudo apt install libpython2.7-dev
sudo apt install pkg-config
sudo apt install libegl1-mesa-dev libwayland-dev libxkbcommon-dev wayland-protocols

# 修正报错,文件添加#include <limits>
gedit ~/Pangolin/include/pangolin/gl/colour.h
cd ~/Pangolin
mkdir build
cd build
cmake .. -DBUILD_EXAMPLES=ON
make -j4
sudo make install
# 测试Pangolin
cd ~/Pangolin/build/examples/HelloPangolin
./HelloPangolin

# 删除源代码
rm -rf ~/Pangolin
```

#### 检查opencv版本至少为4.4.0

`pkg-config --modversion opencv4`

#### 安装编译ORBSLAM3核心库

```
cd ~
git clone https://github.com/zang09/ORB-SLAM3-STEREO-FIXED.git ORB_SLAM3
cd ~/ORB_SLAM3
chmod +x build.sh
./build.sh
ls ~/ORB_SLAM3/lib/libORB_SLAM3.so
# 复制库到系统
sudo mkdir -p /usr/local/include/ORB_SLAM3
sudo cp -r ~/ORB_SLAM3/include/* /usr/local/include/ORB_SLAM3/
sudo cp ~/ORB_SLAM3/lib/libORB_SLAM3.so /usr/local/lib/
sudo ldconfig

# 安装DBoW2
cd ~/ORB_SLAM3/Thirdparty/DBoW2
rm -rf build
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j$(nproc)
# 手动安装
sudo mkdir -p /usr/local/include/DBoW2
sudo cp -r ~/ORB_SLAM3/Thirdparty/DBoW2/DBoW2/* /usr/local/include/DBoW2/
sudo cp -r ~/ORB_SLAM3/Thirdparty/DBoW2/DUtils/* /usr/local/include/DBoW2/
sudo mkdir -p /usr/local/lib
sudo cp ~/ORB_SLAM3/Thirdparty/DBoW2/lib/libDBoW2.so /usr/local/lib/
sudo ldconfig
# 验证
ls /usr/local/include/DBoW2
ls /usr/local/lib | grep DBoW2

# 安装g2o
cd ~/ORB_SLAM3/Thirdparty/g2o
rm -rf build
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON
make -j$(nproc)
# 手动安装
sudo mkdir -p /usr/local/include/g2o
sudo cp -r ~/ORB_SLAM3/Thirdparty/g2o/g2o/* /usr/local/include/g2o/
sudo mkdir -p /usr/local/lib
sudo cp ~/ORB_SLAM3/Thirdparty/g2o/lib/*.so /usr/local/lib/
sudo ldconfig
# 验证
ls /usr/local/include/g2o
ls /usr/local/lib | grep g2o

# 安装Sophus
cd ~/ORB_SLAM3/Thirdparty/Sophus
rm -rf build
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j$(nproc)
# 手动安装
sudo cp -r ~/ORB_SLAM3/Thirdparty/Sophus/sophus /usr/local/include/
# 验证头文件是否正确安装
ls /usr/local/include/Sophus
```


#### 下载编译ORBSLAM3的ROS2功能包

```
cd ~/ws_livox/src
git clone https://github.com/zang09/ORB_SLAM3_ROS2.git

# x修改核心库路径
gedit ~/ws_livox/src/ORB_SLAM3_ROS2/FindORB_SLAM3.cmake
set(ORB_SLAM3_ROOT_DIR "/home/chen/ORB_SLAM3")
```

`gedit ~/ws_livox/src/ORB_SLAM3_ROS2/CMakeLists.txt`

```
cmake_minimum_required(VERSION 3.5)
project(orbslam3)

# You should set the PYTHONPATH to your own python site-packages path
set(ENV{PYTHONPATH} "/opt/ros/foxy/lib/python3.8/site-packages/")

set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} ${CMAKE_CURRENT_SOURCE_DIR}/CMakeModules)

# Default to C++14
if(NOT CMAKE_CXX_STANDARD)
  set(CMAKE_CXX_STANDARD 14)
endif()

if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

find_package(ament_cmake REQUIRED)
find_package(rclcpp REQUIRED)
find_package(sensor_msgs REQUIRED)
find_package(cv_bridge REQUIRED)
find_package(message_filters REQUIRED)
find_package(Sophus REQUIRED)
find_package(Pangolin REQUIRED)
find_package(ORB_SLAM3 REQUIRED)
find_package(OpenCV 4.5 REQUIRED COMPONENTS core imgproc highgui features2d calib3d)

include_directories(
  include
  ${ORB_SLAM3_ROOT_DIR}/include
  ${ORB_SLAM3_ROOT_DIR}/include/CameraModels
  ${OpenCV_INCLUDE_DIRS}
)

link_directories(
  include
)

# Monocular
add_executable(mono
  src/monocular/mono.cpp
  src/monocular/monocular-slam-node.cpp
)
ament_target_dependencies(mono rclcpp sensor_msgs cv_bridge ORB_SLAM3 Pangolin)
target_link_libraries(mono ${OpenCV_LIBS})

# RGB-D
add_executable(rgbd
  src/rgbd/rgbd.cpp
  src/rgbd/rgbd-slam-node.cpp
)
ament_target_dependencies(rgbd rclcpp sensor_msgs cv_bridge message_filters ORB_SLAM3 Pangolin)
target_link_libraries(rgbd ${OpenCV_LIBS})

# Stereo
add_executable(stereo
  src/stereo/stereo.cpp
  src/stereo/stereo-slam-node.cpp
)
ament_target_dependencies(stereo rclcpp sensor_msgs cv_bridge message_filters ORB_SLAM3 Pangolin)
target_link_libraries(stereo ${OpenCV_LIBS})

# Stereo-Inertial
add_executable(stereo-inertial
  src/stereo-inertial/stereo-inertial.cpp
  src/stereo-inertial/stereo-inertial-node.cpp
)
ament_target_dependencies(stereo-inertial rclcpp sensor_msgs cv_bridge ORB_SLAM3 Pangolin)
target_link_libraries(stereo-inertial ${OpenCV_LIBS})

install(TARGETS mono rgbd stereo stereo-inertial
  DESTINATION lib/${PROJECT_NAME})

ament_package()
```

```
cd ~/ws_livox
colcon build --symlink-install --packages-select orbslam3
```

