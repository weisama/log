# D435双目相机获取位置信息

**D435四个相机从左到右分别为：灰度2,红外发射，灰度1,RGB相机**

---

## D435驱动安装

[安装教程](https://blog.csdn.net/qq_45445740/article/details/143613024)

### 安装驱动和上位机

```
sudo mkdir -p /etc/apt/keyrings
curl -sSf https://librealsense.intel.com/Debian/librealsense.pgp | sudo tee /etc/apt/keyrings/librealsense.pgp > /dev/null
sudo apt-get install apt-transport-https
echo "deb [signed-by=/etc/apt/keyrings/librealsense.pgp] https://librealsense.intel.com/Debian/apt-repo $(lsb_release -cs) main" |   sudo tee /etc/apt/sources.list.d/librealsense.list
sudo apt-get update
sudo apt-get install librealsense2-dkms
sudo apt-get install librealsense2-utils 
sudo apt-get install librealsense2-dev
sudo apt-get install librealsense2-dbg
```

**驱动安装过程如需设置BOOT密码，别设置**

**若设置，则重启进入BIOS界面关闭Secure Boot**

```
# 确保可以检测到双目
ls /dev/video*

# 启动上位机
realsense-viewer
```

### 安装驱动功能包

```
cd ~/ws_livox/src
git clone https://github.com/IntelRealSense/realsense-ros.git -b ros2-master

cd ~/ws_livox
colcon build --packages-select realsense2_camera realsense2_camera_msgs realsense2_description
```

```
# 发布RGB和深度
ros2 launch realsense2_camera rs_launch.py

/camera/camera/color/image_raw          # RGB 图像
/camera/camera/depth/image_rect_raw     # 深度图像
/tf_static                              # 固定 TF

# 发布点云话题
ros2 launch realsense2_camera rs_d405_pointcloud_launch.py

/camera/camera/depth/color/points        # 点云（PointCloud2）
/camera/camera/color/image_raw           # RGB 图像
/camera/camera/depth/image_rect_raw      # 深度图像

# 发布发布对齐深度，rviz查看这个话题类型为image
ros2 launch realsense2_camera rs_align_depth_launch.py
ros2 topic echo /camera/camera/aligned_depth_to_color/image_raw

/camera/camera/aligned_depth_to_color/image_raw    # 已对齐到 RGB 的深度图
/camera/camera/color/image_raw                     # RGB 图像
/camera/camera/depth/image_rect_raw                # 深度图像

# 发布俩个双目灰度图像
ros2 launch realsense2_camera rs_launch.py enable_infra1:=true enable_infra2:=true

/camera/camera/color/image_raw          # RGB 图像
/camera/camera/depth/image_rect_raw     # 深度图像
/camera/camera/infra1/image_rect_raw    # 红外 1 原始图像
/camera/camera/infra2/image_rect_raw    # 红外 2 原始图像
```

---

## 使用ORB_SLAM3建图

https://blog.csdn.net/agoodtimeo/article/details/143844969

#### 安装环境
```
sudo apt install git cmake gcc g++ mlocate
sudo apt install ros-$ROS_DISTRO-vision-opencv && sudo apt install ros-$ROS_DISTRO-message-filters
sudo apt install python3-ament-package
```

#### 安装 Eigent3

```
cd ~
git clone -b 3.3.4 https://github.com/eigenteam/eigen-git-mirror.git
cd eigen-git-mirror
mkdir build
cd build
cmake ..
sudo make install
sudo cp -r /usr/local/include/eigen3/Eigen /usr/local/include
rm -rf ~/eigen-git-mirror
```

#### 安装 Pangolin0.6

```
# 安装Pangolin0
cd ~
git clone -b v0.6 https://github.com/stevenlovegrove/Pangolin.git
sudo apt install libgl1-mesa-dev
sudo apt install libglew-dev
sudo apt install cmake
sudo apt install libpython2.7-dev
sudo apt install pkg-config
sudo apt install libegl1-mesa-dev libwayland-dev libxkbcommon-dev wayland-protocols

# 修正报错,文件添加#include <limits>
gedit ~/Pangolin/include/pangolin/gl/colour.h
cd ~/Pangolin
mkdir build
cd build
cmake .. -DBUILD_EXAMPLES=ON
make -j4
sudo make install
# 测试Pangolin
cd ~/Pangolin/build/examples/HelloPangolin
./HelloPangolin

# 删除源代码
rm -rf ~/Pangolin
```

#### 检查opencv版本至少为4.4.0

`pkg-config --modversion opencv4`

#### 安装编译ORBSLAM3核心库

```
cd ~
git clone https://github.com/zang09/ORB-SLAM3-STEREO-FIXED.git ORB_SLAM3
cd ~/ORB_SLAM3
chmod +x build.sh
./build.sh
ls ~/ORB_SLAM3/lib/libORB_SLAM3.so
# 复制库到系统
sudo mkdir -p /usr/local/include/ORB_SLAM3
sudo cp -r ~/ORB_SLAM3/include/* /usr/local/include/ORB_SLAM3/
sudo cp ~/ORB_SLAM3/lib/libORB_SLAM3.so /usr/local/lib/
sudo ldconfig

# 安装DBoW2
cd ~/ORB_SLAM3/Thirdparty/DBoW2
rm -rf build
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j$(nproc)
# 手动安装
sudo mkdir -p /usr/local/include/DBoW2
sudo cp -r ~/ORB_SLAM3/Thirdparty/DBoW2/DBoW2/* /usr/local/include/DBoW2/
sudo cp -r ~/ORB_SLAM3/Thirdparty/DBoW2/DUtils/* /usr/local/include/DBoW2/
sudo mkdir -p /usr/local/lib
sudo cp ~/ORB_SLAM3/Thirdparty/DBoW2/lib/libDBoW2.so /usr/local/lib/
sudo ldconfig
# 验证
ls /usr/local/include/DBoW2
ls /usr/local/lib | grep DBoW2

# 安装g2o
cd ~/ORB_SLAM3/Thirdparty/g2o
rm -rf build
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON
make -j$(nproc)
# 手动安装
sudo mkdir -p /usr/local/include/g2o
sudo cp -r ~/ORB_SLAM3/Thirdparty/g2o/g2o/* /usr/local/include/g2o/
sudo mkdir -p /usr/local/lib
sudo cp ~/ORB_SLAM3/Thirdparty/g2o/lib/*.so /usr/local/lib/
sudo ldconfig
# 验证
ls /usr/local/include/g2o
ls /usr/local/lib | grep g2o

# 安装Sophus
cd ~/ORB_SLAM3/Thirdparty/Sophus
rm -rf build
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j$(nproc)
# 手动安装
sudo cp -r ~/ORB_SLAM3/Thirdparty/Sophus/sophus /usr/local/include/
# 验证头文件是否正确安装
ls /usr/local/include/Sophus
```


#### 下载编译ORBSLAM3的ROS2功能包

```
cd ~/ws_livox/src
git clone https://github.com/zang09/ORB_SLAM3_ROS2.git

# x修改核心库路径
gedit ~/ws_livox/src/ORB_SLAM3_ROS2/FindORB_SLAM3.cmake
set(ORB_SLAM3_ROOT_DIR "/home/chen/ORB_SLAM3")
```

`gedit ~/ws_livox/src/ORB_SLAM3_ROS2/CMakeLists.txt`

```
cmake_minimum_required(VERSION 3.5)
project(orbslam3)

# You should set the PYTHONPATH to your own python site-packages path
set(ENV{PYTHONPATH} "/opt/ros/foxy/lib/python3.8/site-packages/")

set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} ${CMAKE_CURRENT_SOURCE_DIR}/CMakeModules)

# Default to C++14
if(NOT CMAKE_CXX_STANDARD)
  set(CMAKE_CXX_STANDARD 14)
endif()

if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

find_package(ament_cmake REQUIRED)
find_package(rclcpp REQUIRED)
find_package(sensor_msgs REQUIRED)
find_package(cv_bridge REQUIRED)
find_package(message_filters REQUIRED)
find_package(Sophus REQUIRED)
find_package(Pangolin REQUIRED)
find_package(ORB_SLAM3 REQUIRED)
find_package(OpenCV 4.5 REQUIRED COMPONENTS core imgproc highgui features2d calib3d)

include_directories(
  include
  ${ORB_SLAM3_ROOT_DIR}/include
  ${ORB_SLAM3_ROOT_DIR}/include/CameraModels
  ${OpenCV_INCLUDE_DIRS}
)

link_directories(
  include
)

# Monocular
add_executable(mono
  src/monocular/mono.cpp
  src/monocular/monocular-slam-node.cpp
)
ament_target_dependencies(mono rclcpp sensor_msgs cv_bridge ORB_SLAM3 Pangolin)
target_link_libraries(mono ${OpenCV_LIBS})

# RGB-D
add_executable(rgbd
  src/rgbd/rgbd.cpp
  src/rgbd/rgbd-slam-node.cpp
)
ament_target_dependencies(rgbd rclcpp sensor_msgs cv_bridge message_filters ORB_SLAM3 Pangolin)
target_link_libraries(rgbd ${OpenCV_LIBS})

# Stereo
add_executable(stereo
  src/stereo/stereo.cpp
  src/stereo/stereo-slam-node.cpp
)
ament_target_dependencies(stereo rclcpp sensor_msgs cv_bridge message_filters ORB_SLAM3 Pangolin)
target_link_libraries(stereo ${OpenCV_LIBS})

# Stereo-Inertial
add_executable(stereo-inertial
  src/stereo-inertial/stereo-inertial.cpp
  src/stereo-inertial/stereo-inertial-node.cpp
)
ament_target_dependencies(stereo-inertial rclcpp sensor_msgs cv_bridge ORB_SLAM3 Pangolin)
target_link_libraries(stereo-inertial ${OpenCV_LIBS})

install(TARGETS mono rgbd stereo stereo-inertial
  DESTINATION lib/${PROJECT_NAME})

ament_package()
```



```
# 解压配置文件
cd ~/ws_livox/src/ORB_SLAM3_ROS2/vocabulary
tar -xvzf ORBvoc.txt.tar.gz

# 创建我的配置配置
gedit ~/ws_livox/src/ORB_SLAM3_ROS2/config/rgb-d/my_RealSense_D435.yaml
################################################
%YAML:1.0

#--------------------------------------------------------------------------------------------
# Camera Parameters. Adjust them!
#--------------------------------------------------------------------------------------------
Camera.type: "PinHole"

# Camera calibration and distortion parameters (OpenCV)
Camera.fx: 617.201
Camera.fy: 617.362
Camera.cx: 324.637
Camera.cy: 242.462

# distortion parameters
Camera.k1: 0.0
Camera.k2: 0.0
Camera.p1: 0.0
Camera.p2: 0.0

# Camera resolution
Camera.width: 640
Camera.height: 480

# Camera frames per second 
Camera.fps: 30.0

# Color order of the images (0: BGR, 1: RGB. It is ignored if images are grayscale)
Camera.RGB: 1

# Image scale, it changes the image size to be processed (<1.0: reduce, >1.0: increase)
Camera.imageScale: 0.5

# Close/Far threshold. Baseline times.
ThDepth: 40.0

# stereo baseline times fx
Camera.bf: 46.01

# Deptmap values factor
DepthMapFactor: 1000.0

# Transformation from body-frame to camera
Tbc: !!opencv-matrix
   rows: 4
   cols: 4
   dt: f
   data: [1,0,0,0,
         0,1,0,0,
         0,0,1,0,
         0,0,0,1]

# Do not insert KFs when lost
InsertKFsWhenLost: false

#--------------------------------------------------------------------------------------------
# ORB Parameters
#--------------------------------------------------------------------------------------------
ORBextractor.nFeatures: 800
ORBextractor.scaleFactor: 1.2
ORBextractor.nLevels: 6
ORBextractor.iniThFAST: 20
ORBextractor.minThFAST: 7

#--------------------------------------------------------------------------------------------
# Viewer Parameters
#--------------------------------------------------------------------------------------------
Viewer.KeyFrameSize: 0.05
Viewer.KeyFrameLineWidth: 1
Viewer.GraphLineWidth: 0.9
Viewer.PointSize: 2
Viewer.CameraSize: 0.08
Viewer.CameraLineWidth: 3
Viewer.ViewpointX: 0
Viewer.ViewpointY: -0.7
Viewer.ViewpointZ: -3.5
Viewer.ViewpointF: 500
################################################

# 创建我的配置配置
gedit /home/chen/ws_livox/src/realsense-ros/config/my_orb_slam3_config.yaml
#############################
camera_name: "camera"
camera_namespace: "camera"

enable_color: true
rgb_camera.color_profile: 640,480,30
rgb_camera.color_format: "RGB8"
rgb_camera.enable_auto_exposure: true

enable_depth: true
depth_module.depth_profile: 640,480,30
depth_module.depth_format: "Z16"
depth_module.enable_auto_exposure: true

# 不使用红外
enable_infra: false
enable_infra1: false
enable_infra2: false

# RGB-D SLAM 核心
align_depth.enable: true
enable_sync: true

# 建议关闭所有滤波——SLAM 效果更稳定
decimation_filter.enable: false
spatial_filter.enable: false
temporal_filter.enable: false
disparity_filter.enable: false
hole_filling_filter.enable: false

# IMU（RGBD 不需要）
enable_gyro: false
enable_accel: false
enable_motion: false

# 点云（不需要）
pointcloud.enable: false

# TF
publish_tf: true
base_frame_id: "camera_link"

# 其他
clip_distance: -1.0
log_level: "info"
#############################
```


#### claund帮我改完了，以下是其日志
```
● 修改的文件和内容

  1. /home/chen/ws_livox/src/ORB_SLAM3_ROS2/src/rgbd/rgbd-slam-node.hpp

  添加了 init() 方法声明：
  public:
      RgbdSlamNode(ORB_SLAM3::System* pSLAM);
      ~RgbdSlamNode();
      void init();  // 新增

  2. /home/chen/ws_livox/src/ORB_SLAM3_ROS2/src/rgbd/rgbd-slam-node.cpp

  修改前：
  RgbdSlamNode::RgbdSlamNode(ORB_SLAM3::System* pSLAM)
  :   Node("ORB_SLAM3_ROS2"),
      m_SLAM(pSLAM)
  {
      rgb_sub = std::make_shared<message_filters::Subscriber<ImageMsg> >(shared_ptr<rclcpp::Node>(this),
  "camera/camera/color/image_raw");
      depth_sub = std::make_shared<message_filters::Subscriber<ImageMsg> >(shared_ptr<rclcpp::Node>(this),
  "camera/camera/depth/image_rect_raw");

      syncApproximate = std::make_shared<message_filters::Synchronizer<approximate_sync_policy> >(approximate_sync_policy(10),
  *rgb_sub, *depth_sub);
      syncApproximate->registerCallback(&RgbdSlamNode::GrabRGBD, this);
  }

  修改后：
  RgbdSlamNode::RgbdSlamNode(ORB_SLAM3::System* pSLAM)
  :   Node("ORB_SLAM3_ROS2"),
      m_SLAM(pSLAM)
  {
  }

  void RgbdSlamNode::init()
  {
      auto node_ptr = rclcpp::Node::shared_from_this();
      rgb_sub = std::make_shared<message_filters::Subscriber<ImageMsg> >(node_ptr, "camera/camera/color/image_raw");
      depth_sub = std::make_shared<message_filters::Subscriber<ImageMsg> >(node_ptr, "camera/camera/depth/image_rect_raw");

      syncApproximate = std::make_shared<message_filters::Synchronizer<approximate_sync_policy> >(approximate_sync_policy(10),
  *rgb_sub, *depth_sub);
      syncApproximate->registerCallback(&RgbdSlamNode::GrabRGBD, this);
  }

  3. /home/chen/ws_livox/src/ORB_SLAM3_ROS2/src/rgbd/rgbd.cpp

  修改前：
  auto node = std::make_shared<RgbdSlamNode>(&SLAM);
  std::cout << "============================ " << std::endl;

  rclcpp::spin(node);

  修改后：
  auto node = std::make_shared<RgbdSlamNode>(&SLAM);
  node->init();  // 新增
  std::cout << "============================ " << std::endl;

  rclcpp::spin(node);

  关键变化

  将 shared_ptr<rclcpp::Node>(this) 改为 rclcpp::Node::shared_from_this()，避免了 double free 错误。
```

#### 修改cpp中话题名称

`gedit ~/ws_livox/src/ORB_SLAM3_ROS2/src/rgbd/rgbd-slam-node.cpp`

```
    rgb_sub = std::make_shared<message_filters::Subscriber<ImageMsg> >(node_ptr, "camera/camera/color/image_raw");
    depth_sub = std::make_shared<message_filters::Subscriber<ImageMsg> >(node_ptr, "camera/camera/aligned_depth_to_color/image_raw");
```

#### 编译

```
cd ~/ws_livox
colcon build --symlink-install --packages-select orbslam3
```

#### 运行
```
# 启动双目，使用我的配置
ros2 launch realsense2_camera rs_align_depth_launch.py config_file:=/home/chen/ws_livox/src/realsense-ros/config/my_orb_slam3_config.yaml

# 启动orbslam3，深度+RGB模式
  ros2 run orbslam3 rgbd \
    ~/ws_livox/src/ORB_SLAM3_ROS2/vocabulary/ORBvoc.txt \
    ~/ws_livox/src/ORB_SLAM3_ROS2/config/rgb-d/my_RealSense_D435.yaml \
    true

ros2 topic hz /camera/camera/color/image_raw
ros2 topic hz /camera/camera/aligned_depth_to_color/image_raw
```

---

## 安装VINS-Fusion-ROS2

https://blog.csdn.net/weixin_55944949/article/details/153690080

`gedit /home/chen/ws_livox/src/vins_fusion_ros2/vins/include/vins/estimator/estimator.h`

```
#include <atomic>
```

```
cd ~/ws_livox
colcon build --packages-select vins_fusion_ros2

rviz2 -d ~/vins_ws/src/vins_fusion_ros2/config/vins_rviz_config.rviz
ros2 launch vins_fusion_ros2 vins_fusion_ros2.launch.py
```

####   vins要求imu频率200hz

**BV1WZ4y167me高飞视频的方法失败**

```
# QGC中mavlink控制台查看当前飞控连接的设备
# /dev/ttyACM0为tpye-c，/dev/ttyS3为telem2
mavlink status

# 飞控sd卡内写入指令
mkdir etc
gedit etc/extras.txt

mavlink stream -d /dev/ttyACM0 -s ATTITUDE_QUATERNION -r 200
mavlink stream -d /dev/ttyACM0 -s HIGHERS_IMU -r 200
mavlink stream -d /dev/ttyS3 -s ATTITUDE_QUATERNION -r 200
mavlink stream -d /dev/ttyS3 -s HIGHRES_IMU -r 200

mavlink status streams
```

#### 通过终端输入指令设置，成功但每次上电都需设置

```
ros2 launch mavros px4.launch

# 设置 HIGHRES_IMU 200Hz
ros2 service call /mavros/cmd/command \
  mavros_msgs/srv/CommandLong "{ 
    command: 511,          # MAV_CMD_SET_MESSAGE_INTERVAL
    param1: 27.0,          # MAVLink 消息ID HIGHRES_IMU
    param2: 0.005,         # 间隔秒数 = 1/200 Hz
    param3: 0.0,
    param4: 0.0,
    param5: 0.0,
    param6: 0.0,
    param7: 0.0,
    broadcast: true
}"

# 对应 HIGHRES_IMU
ros2 topic hz /mavros/imu/data
```

#### 设置

`gedit ~/ws_livox/src/vins_fusion_ros2/config/realsense_d435i/realsense_stereo_imu_config.yaml`

```
imu: 1     # 使用imu
num_of_cam: 2  # 使用双目

imu_topic: "/mavros/imu/data"
image0_topic: "/camera/camera/infra1/image_rect_raw"
image1_topic: "/camera/camera/infra2/image_rect_raw"
```

```
cd ~/ws_livox
colcon build --packages-select vins_fusion_ros2
```

```
# 连接飞控获取imu
ros2 launch mavros px4.launch

# 设置 HIGHRES_IMU 200Hz
ros2 service call /mavros/cmd/command \
  mavros_msgs/srv/CommandLong "{ 
    command: 511,          # MAV_CMD_SET_MESSAGE_INTERVAL
    param1: 27.0,          # MAVLink 消息ID HIGHRES_IMU
    param2: 0.005,         # 间隔秒数 = 1/200 Hz
    param3: 0.0,
    param4: 0.0,
    param5: 0.0,
    param6: 0.0,
    param7: 0.0,
    broadcast: true
}"

# 发布俩个双目灰度图像
ros2 launch realsense2_camera rs_launch.py enable_infra1:=true enable_infra2:=true

# 启动vins
ros2 launch vins_fusion_ros2 vins_fusion_ros2.launch.py

# 可视化
rviz2 -d ~/vins_ws/src/vins_fusion_ros2/config/vins_rviz_config.rviz
```
