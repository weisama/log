# 动捕作为定点模式的位置输入，offboard模式控制无人机飞行

---

### offboard模式下飞行的功能包

```bash
mkdir -p ~/catkin_ws/src/offboard_test/src
cd ~/catkin_ws/src/offboard_test

gedit ~/catkin_ws/src/offboard_test/src/offboard_test.cpp
gedit ~/catkin_ws/src/offboard_test/package.xml
gedit ~/catkin_ws/src/offboard_test/CMakeLists.txt
```

#### 编译

```bash
cd ~/catkin_ws
rm -rf build/offboard_test install/offboard_test
colcon build --packages-select offboard_test
```

#### 运行前通道6拨到非急停，否则后续急停可能会失效

#### 运行

```bash
source ~/catkin_ws/install/setup.bash
ros2 run offboard_test offboard_test_node
```

---

### QGC参数设置

```
COM_OBL_RC_ACT = land mode  
offboard控制丢失后切换到降落模式

COM_RC_OVERRIDE = 3  
允许遥控器打杆时强制退出Offboard模式，并切换至Position模式

COM_RC_STICK_OV = 20  
定义打杆幅度阈值（例如摇杆偏移超过20%触发）

QGC→飞行模式→设定emergency kill switch channel→channel 6  
设置右拨杆（通道6）紧急停止电机转动

MPC_Z_VEL_MAX_UP = 3.0  
MPC_XY_VEL_MAX = 12.0  
限制最大飞行速度
```

[参考文档](https://cwkj-tech.yuque.com/bsge84/fdgmgu/th7s855up9rprktf)

---

### 可能的问题

25.08.20_offboard中发现offboard_test功能包运行，警告订阅者和 MAVROS 发布者 QoS 不兼容  
导致功能包无法获取正确的坐标，无人机无法检测是否到达目标地

可修改为以下，成功解决：

```cpp
#include "rclcpp/qos.hpp"

// 创建 QoS
rclcpp::QoS qos(rclcpp::KeepLast(10));
qos.best_effort();  // 这里一定要与 MAVROS 发布者兼容

// 创建订阅
local_pose_sub_ = this->create_subscription<geometry_msgs::msg::PoseStamped>(
    "/mavros/local_position/pose",
    qos,
    std::bind(&OffboardTestNode::localPoseCallback, this, _1));
```
