# 购买配件搭建超维空间同款S2-F290，基础配置，待更新
**飞控默认固件是PX4v1.13.3，机载电脑是迷你主机**

---

## QGC配置

```bash
EKF2_AID_MASK = 0
```
禁用GPS

```bash
CBRK_SUPPLY_CHK = 894281
```
无备用电池允许遥控解锁

```bash
SYS_CTRL_ALLOC = Enable
```
允许控制分配功能

加载超维空间科技s2-f290固件参数  
更新其中PID（MPC_xxx）参数

---

## 机载电脑下载MAVROS

修改QGC中参数

```bash
MAV_1_CONFIG：TELLEM2
MAV_1_MODE：Onboard
SER_TEL2_BAUD：961200 8N1
```

迷你主机通过串口连接TELLEM2  
TELLEM2： 5V TX RX CTS RTS GND

### 安装MAVROS

参考：https://blog.csdn.net/weixin_42037083/article/details/137102858

```bash
sudo apt-get install ros-humble-mavros ros-humble-mavros-extras
```

### 安装GeographicLib

```bash
cd ~
git clone https://github.com/weisama/GeographicLib.git
sudo cp -r GeographicLib /usr/share
rm -rf GeographicLib
```

### 查看最新的串口消息

```bash
ls /dev/ttyUSB*
sudo usermod -aG dialout $USER
sudo chmod 777 /dev/ttyUSB0
```

### 修改mavros串口设备和波特率

```bash
sudo nano /opt/ros/humble/share/mavros/launch/px4.launch
```

```xml
<arg name="fcu_url" default="/dev/ttyUSB0:921600" />
```

### 启动MAVROS

```bash
ros2 launch mavros px4.launch
ros2 launch mavros px4.launch fcu_url:=/dev/ttyUSB0:921600
```

### 查看话题列表

```bash
ros2 topic list
```

### 检查MAVROS状态

```bash
# 飞控状态
ros2 topic echo /mavros/state

# IUM数据
ros2 topic echo /mavros/imu/data
```

---

## 机载电脑mavros连接px4后，与机载电脑同wifi的本机QGC远程连接

```bash
sudo nano /opt/ros/humble/share/mavros/launch/px4.launch
```

```xml
<arg name="gcs_url" default="udp://:14509@" />
```

本机打开QGC，添加连接吊载无人机2  
type：UDP  
Port：14509  
Server：10.1.1.105:14509

**ip是机载电脑的IP**

---

## 云卓h12带屏遥控下载qgc，通过接收器连接飞控

QGC使用云卓技术人员微信提供的云卓QGC

```bash
MAV_0_CONFIG：TELLEM1
MAV_0_MODE：Normal
SER_TEL1_BAUD：57600 8N1
```

---

## 获取mid360点云，部署fastlio

**参考日志25.09.23_MID360_PC.md**

### 根据雷达安装位置修改雷达驱动设置

`gedit ~/ws_livox/src/livox_ros_driver2/config/MOD360_config.json`

```
      "extrinsic_parameter" : {
        "roll": 0.0,
        "pitch": 135.0,
        "yaw": 180.0,
        "x": -8,
        "y": 0,
        "z": -18
      }
```

```
cd ~/ws_livox
colcon build --packages-select livox_ros_driver2
```

```
##########建图，使用的是livox自定义格式点云，与聚类的点云格式不同
ros2 launch livox_ros_driver2 msg_MID360_launch.py
ros2 launch fast_lio mapping.launch.py

# 坐标系camera_init是启动时无人机原点，body是当前无人机坐标
```

---

## 获取动捕数据

**根据25.06.26_mocap.md部署，无人机为t1,货物为p1**

```
# git功能包后编译
cd ~/ws_livox
# 获取动捕数据功能包
colcon build --packages-select vrpn_listener
# 处理动捕数据功能包，修改无人机名称
gedit ~/ws_livox/src/vrpn_relative_pose/launch/vrpn_relative.launch.py
colcon build --packages-select vrpn_relative_pose

# 获取动捕数据
ros2 launch vrpn_listener sync_entity_state.launch
# 处理动捕数据
ros2 launch vrpn_relative_pose vrpn_relative.launch.py
ros2 topic echo /mavros/vision_pose/pose
# 转发动捕数据给飞控
ros2 launch mavros px4.launch
ros2 run topic_tools relay /vrpn/t1/pose /mavros/vision_pose/pose
```



## QGC设置飞控使用slam外部视觉坐标和yaw输入

### 重要参数，关乎slam定点飞行精度

- EKF2_EVP_NOISE = 1.0  
  为slam位置数据的方差，影响slam位置数据的置信度  
  过大会导致移动过程slam位置置信度较低，来回震荡  
  过小会导致LOCAL_POSITION_NED发散，EKF2估计坐标偏离slam位置  
  实测0.1过小

- EKF2_EVA_NOISE = 10  
  为slam姿态数据的方差，影响slam姿态数据的置信度

- EKF2_EV_DELAY = 125  
  slam数据延迟，从PX4_log.txt中日志查看slam数据四元素和imu四元素的延迟

- EKF2_AID_MASK = 24  
  勾选外部视觉（雷达）位置和yaw，用于EKF2（扩展卡尔曼），使用slam作为位姿数据来源  

- EKF2_HGT_MODE = 0
  默认，使用气压计

### 其他参数

- MIS_TAKEOFF_ALT = 1  
  无人机降落最小高度

- CBRK_SUPPLY_CHK = 894281  
  无备用电池允许遥控解锁

- SDLOG_PROFILE = 129  
  日志记录内容默认+机器视觉

- SDLOG_MODE = from boot until shutdown  
  日志记录从上电到掉电

- SYS_CTRL_ALLOC = Enable  
  允许控制分配功能

- COM_RC_OVERRIDE = 3  
  允许遥控器打杆时强制退出Offboard模式，并切换至Position模式

- COM_RC_STICK_OV = 20  
  定义打杆幅度阈值（例如摇杆偏移超过20%触发）

