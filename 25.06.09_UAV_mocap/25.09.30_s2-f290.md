# 购买配件搭建超维空间同款S2-F290，已实现动捕定点飞行
**飞控默认固件是PX4v1.13.3，机载电脑是迷你主机**

`ssh -Y chen@10.1.1.105`

---

## QGC配置

```bash
EKF2_AID_MASK = 0
```
禁用GPS

```bash
CBRK_SUPPLY_CHK = 894281
```
无备用电池允许遥控解锁

```bash
SYS_CTRL_ALLOC = Enable
```
允许控制分配功能

加载超维空间科技s2-f290固件参数  
更新其中PID（MPC_xxx）参数

---

## 机载电脑下载MAVROS

修改QGC中参数

```bash
MAV_1_CONFIG：TELLEM2
MAV_1_MODE：Onboard
SER_TEL2_BAUD：961200 8N1
```

迷你主机通过串口连接TELLEM2  
TELLEM2： 5V TX RX CTS RTS GND

### 安装MAVROS

参考：https://blog.csdn.net/weixin_42037083/article/details/137102858

```bash
sudo apt-get install ros-humble-mavros ros-humble-mavros-extras
```

### 安装GeographicLib

```bash
cd ~
git clone https://github.com/weisama/GeographicLib.git
sudo cp -r GeographicLib /usr/share
rm -rf GeographicLib
```

### 查看最新的串口消息

```bash
ls /dev/ttyUSB*
sudo usermod -aG dialout $USER
sudo chmod 777 /dev/ttyUSB0
```

### 修改mavros串口设备和波特率

```bash
sudo nano /opt/ros/humble/share/mavros/launch/px4.launch
```

```xml
<arg name="fcu_url" default="/dev/ttyUSB0:921600" />
```

### 启动MAVROS

```bash
ros2 launch mavros px4.launch
ros2 launch mavros px4.launch fcu_url:=/dev/ttyUSB0:921600
```

### 查看话题列表

```bash
ros2 topic list
```

### 检查MAVROS状态

```bash
# 飞控状态
ros2 topic echo /mavros/state

# IUM数据
ros2 topic echo /mavros/imu/data
```

---

## 机载电脑mavros连接px4后，与机载电脑同wifi的本机QGC远程连接

```bash
sudo nano /opt/ros/humble/share/mavros/launch/px4.launch
```

```xml
<arg name="gcs_url" default="udp://:14509@" />
```

本机打开QGC，添加连接吊载无人机2  
type：UDP  
Port：14509  
Server：10.1.1.105:14509

**ip是机载电脑的IP**

---

## 云卓h12带屏遥控下载qgc，通过接收器连接飞控

QGC使用云卓技术人员微信提供的云卓QGC

```bash
MAV_0_CONFIG：TELLEM1
MAV_0_MODE：Normal
SER_TEL1_BAUD：57600 8N1
```

---

## 获取mid360点云，部署fastlio

**参考日志25.09.23_MID360_PC.md**

### 根据雷达安装位置修改雷达驱动设置

`gedit ~/ws_livox/src/livox_ros_driver2/config/MOD360_config.json`

```
      "extrinsic_parameter" : {
        "roll": 0.0,
        "pitch": 45.0,
        "yaw": 0.0,
        "x": 5,
        "y": 0,
        "z": 12
      }
```

```
cd ~/ws_livox
colcon build --packages-select livox_ros_driver2
```

```
##########建图，使用的是livox自定义格式点云，与聚类的点云格式不同
ros2 launch livox_ros_driver2 msg_MID360_launch.py
ros2 launch fast_lio mapping.launch.py

# 坐标系camera_init是启动时无人机原点，body是当前无人机坐标
```

### 创建了功能包将/Odometry转发到/mavros/vision_pose/pose

```
ros2 launch mavros px4.launch
ros2 launch livox_ros_driver2 msg_MID360_launch.py
ros2 launch fast_lio mapping.launch.py
ros2 run pose_send pose_send_node
```

---

## 获取动捕数据

**根据25.06.26_mocap.md部署，无人机为t1,货物为p1**

**根据25.06.26_mocap.md设置飞控参数**

```
# git功能包后编译
cd ~/ws_livox
# 获取动捕数据功能包
colcon build --packages-select vrpn_listener
# 处理动捕数据功能包
colcon build --packages-select vrpn_relative_pose

# 飞控通信
ros2 launch mavros px4.launch
# 获取动捕数据
ros2 launch vrpn_listener sync_entity_state.launch
# 处理动捕数据并转发给飞控
ros2 launch vrpn_relative_pose vrpn_relative.launch.py
ros2 topic echo /mavros/vision_pose/pose

```

---

### 设置开机自启动

`gedit ~/autostart.sh`

**动捕版本**

```
#!/bin/bash
# 加载环境
source /opt/ros/humble/setup.bash
source /home/chen/ws_livox/install/setup.bash
sleep 5
# 启动命令
ros2 launch vrpn_listener sync_entity_state.launch &
sleep 3
ros2 launch mavros px4.launch &
sleep 3
ros2 launch vrpn_relative_pose vrpn_relative.launch.py &
# 防止脚本退出
while true; do sleep 1000; done
```

**slam版本**

```
#!/bin/bash
# 加载环境
source /opt/ros/humble/setup.bash
source /home/chen/ws_livox/install/setup.bash
sleep 5
# 启动命令
ros2 launch mavros px4.launch &
sleep 1
ros2 launch livox_ros_driver2 msg_MID360_launch.py &
sleep 1
ros2 launch fast_lio mapping.launch.py &
sleep 1
ros2 run pose_send pose_send_node &
# 防止脚本退出
while true; do sleep 1000; done
```

```
# 使能开机自启动
sudo systemctl enable autostart.service
# 运行脚本
sudo systemctl start autostart.service

# 停止脚本
sudo systemctl stop autostart.service
# 禁用开机自启动
sudo systemctl disable autostart.service
```
