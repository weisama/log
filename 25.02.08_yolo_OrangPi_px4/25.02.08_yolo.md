# 笔记本双系统ubuntu配置yolo运行环境

## 安装 yolo 所需环境（Ubuntu 24.04.1 LTS）

---

### 安装 python3.10.16
参考：<https://blog.csdn.net/weixin_43935402/article/details/121416812>

---

### 鱼香 ros 一键安装 VSCode
```bash
source <(wget -qO- http://fishros.com/install)
```
报错解决：
```bash
sudo pip3 install distro
```

---

### 更新显卡驱动
```bash
nvidia-smi
sudo apt-get remove --purge '^nvidia-.*'
sudo ubuntu-drivers autoinstall
sudo reboot
nvidia-smi
```
显示兼容 CUDA 12.4

---

### 安装 PyTorch（conda activate dl 前 sudo su）
先更新显卡驱动，再根据能安装的版本安装 CUDA（选择 Ubuntu 22 也行），安装 cuDNN，最后安装 Anaconda
> 不能 `sudo bash`，否则会安装在 root 下

参考：
- <https://blog.csdn.net/qq_35768355/article/details/131261838>
- <https://blog.csdn.net/jiangkp/article/details/138357584>

安装 cuDNN 参考：
<https://blog.csdn.net/KRISNAT/article/details/134870009>

```bash
sudo cp /home/chen/cudnn-linux-x86_64-8.9.7.29_cuda12-archive/include/* /usr/local/cuda-12.4/include
sudo cp /home/chen/cudnn-linux-x86_64-8.9.7.29_cuda12-archive/lib/libcudnn* /usr/local/cuda-12.4/lib64
sudo chmod a+r /usr/local/cuda-12.4/include/cudnn.h
sudo chmod a+r /usr/local/cuda-12.4/lib64/libcudnn*
cat /usr/local/cuda-12.4/include/cudnn_version.h | grep CUDNN_MAJOR -A 2
```

---

### 使用清华园镜像下载 PyTorch
> 在 conda 环境 `dl` 中安装

#### 进入/退出 conda 环境
```bash
conda activate dl
conda deactivate  # 退出环境
```

#### PyTorch 官网指令
```bash
conda activate dl
conda install pytorch==2.5.1 torchvision==0.20.1 torchaudio==2.5.1 pytorch-cuda=12.4 -c pytorch -c nvidia
```
报错 `[Errno 11] Resource temporarily unavailable`  
dp 回答使用以下安装：
```bash
conda activate dl
pip install torch torchvision --index-url https://mirrors.aliyun.com/pypi/simple/
```

---

### 关闭启动终端默认进入 base 环境
```bash
conda config --set auto_activate_base false
```

---

### 校验安装结果
```bash
conda activate dl
python3  # 进入 python 模式
```
```python
import torch
print(torch.cuda.is_available())  # 返回 True，安装了 GPU 加速版本
```

---

### 安装 YOLO
参考：<https://blog.csdn.net/qq_41204464/article/details/142769763>

```bash
conda activate dl
pip install ultralytics -i https://mirrors.aliyun.com/pypi/simple/
```

#### 验证安装
```bash
python3
```
```python
from ultralytics import YOLO
```

---

### 测试 Python 运行 YOLO11 脚本
使用 VSCode 编写 python 脚本：

```python
from ultralytics import YOLO

# 加载预训练的 YOLOv11n 模型
model = YOLO("yolo11n.pt")  # yolo11n.pt, yolo11s.pt, yolo11m.pt, yolo11x.pt

# 对 'bus.jpg' 图像进行推理，并获取结果
results = model.predict("/home/chen/test_code/test.png", save=True, imgsz=320, conf=0.5)

# 处理返回的结果
for result in results:
    boxes = result.boxes       # 获取边界框信息
    probs = result.probs       # 获取分类概率
    result.show()              # 显示结果
```

文件夹中放测试图片，终端运行脚本：
```bash
python3 '/home/chen/test_code/test_yolo11.py'
```

---

## 环境安装完成

### 注意事项
- yolo 和 pytorch 安装在 conda 环境中，运行前进入 dl 环境
  ```bash
  conda activate dl
  ```
- 环境中有两个 python，运行 yolo 用 `python3`

---

## 获取图片训练集
- 教程：BV1Xs421K7wH
- 访问 <https://roboflow.com/>
  - 新建工程
  - 访问 <https://universe.roboflow.com/>
  - 搜索数据集，将训练集中图片和标注克隆到自己工程（waiting）
  - 工程中编辑训练集的 class
  - 导出训练集为 zip
  - 修改 `/data/data.yaml`

---

## 训练模型
训练自己的 yolo 模型  
参考：BV1unxxe1E7s

```bash
cd /code/yolo
cp -r base new_name  # 复制工程
```

将工程添加进 VSCode 中编辑，修改以下文件中的绝对路径：
- `/data/data.yaml`
- `/train.py`

在 VSCode 中打开终端开始训练模型：
```bash
cd /code/yolo/...
python3 train.py  # 训练模型
```

复制 `/runs/detect/trainXX/weights` 中 `best.pt` 至工程文件夹中  
复制要验证的图片或视频至工程文件夹中，修改 `test.py` 中相对路径
```bash
python3 test.py  # 测试模型
```
```