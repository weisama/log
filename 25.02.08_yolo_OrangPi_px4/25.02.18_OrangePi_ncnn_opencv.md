# OrangePi 5 Plus上使用ncnn模型运行onnx 

不同的推理模型在运行速度上差异巨大，故采用腾讯ncnn模型运行onnx  
https://blog.csdn.net/qq_42589613/article/details/140892445?spm=1001.2014.3001.5506  

---  

安装OpenCV4.9，配置ncnn运行环境  
编译时报错，依赖库出现问题  
解决方法：github下载 OpenCV 和 OpenCV_contrib进行编译  
https://blog.csdn.net/mhyasadj/article/details/137886454?spm=1001.2014.3001.5506  

---  

测试OpenCV安装完成  

```cpp
#include <opencv2/opencv.hpp>
#include <iostream>

int main()
{
    // 加载图片
    cv::Mat img = cv::imread("test.png");
    if (img.empty())
    {
        std::cerr << "cv::imread test.png failed" << std::endl;
        return -1;
    }

    // 显示图片
    cv::imshow("Test Image", img);
    cv::waitKey(0);

    std::cout << "OpenCV installation test passed!" << std::endl;
    return 0;
}
```
该工程为测试opencv库正确安装  

```bash
g++ -o test_opencv test_opencv.cpp `pkg-config --cflags --libs opencv4`
./test_opencv
```

---  

以下内容并未成功编译，见ncnn_002，仍保留以下内容方便回顾  

网上大多教程使用ncnn编译完成的版本，但OrangePi的内核aarch64暂无编译完成版本，需自己手动编译  

安装环境  

```bash
sudo apt-get install build-essential
sudo apt-get install cmake 
sudo apt-get install autoconf automake libtool curl make g++ unzip
```

以下是安装protobuf的教程  

```bash
git clone https://github.com/google/protobuf.git 
cd protobuf
git submodule update --init --recursive
./autogen.sh
./configure
make
make check
sudo make install
sudo ldconfig           # refresh shared library cache.
```

查看protobuf版本自动检测  

```bash
protoc --version
```
来自 https://blog.csdn.net/qq_37373742/article/details/125218908  

---  

安装ncnn  

```bash
# check for updates (64-bit OS is still under development!)
sudo apt-get update
sudo apt-get upgrade
# install dependencies
sudo apt-get install cmake wget
sudo apt-get install libprotobuf-dev protobuf-compiler
# download ncnn
git clone --depth=1 https://github.com/Tencent/ncnn.git 
# install ncnn
cd ncnn
mkdir build
cd build
# build 64-bit ncnn
cmake -D NCNN_DISABLE_RTTI=OFF \
-D CMAKE_TOOLCHAIN_FILE=../toolchains/aarch64-linux-gnu.toolchain.cmake ..
make -j4
make install
# copy output to dirs
sudo mkdir /usr/local/lib/ncnn
sudo cp -r install/include/ncnn /usr/local/include/ncnn
sudo cp -r install/lib/libncnn.a /usr/local/lib/ncnn/libncnn.a
# once you've placed the output in your /usr/local directory,
# you may delete the ncnn directory if you have no tools or examples compiled
 
cd ~
sudo rm -rf ncnn
sudo /sbin/ldconfig
```
来自 https://blog.csdn.net/sxf1061700625/article/details/121630741  

---  

在笔记本上训练的yolo模型生产best.pt，运行yolo工程中的export.py将best.pt转化为tank_yoloV11.onnx，还需在香橙派中借助ncnn工具进一步转化为.param和.bin文件  
在ncnn的tools目录中找到onnx2ncnn工具，并使用它转换模型：  

```bash
./ncnn/tools/onnx/onnx2ncnn tank_yoloV11.onnx tank.param tank.bin
```