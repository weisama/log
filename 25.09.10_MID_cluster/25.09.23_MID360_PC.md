# 吊载无人机需要感知编队中其他无人机位置，使用MID360+聚类算法
超维空间科技 S2-F290 同款机架 + 迷你主机 部署记录

---

## 1 刷入 Ubuntu 22.04 系统

```bash
# Ubuntu 官网
https://releases.ubuntu.com/22.04/ubuntu-22.04.5-desktop-amd64.iso

# 清华镜像
https://mirrors.tuna.tsinghua.edu.cn/ubuntu-releases/22.04/ubuntu-22.04.5-desktop-amd64.iso
```

---

## 2 机载电脑基础设置

```bash
sudo wget http://fishros.com/install -O fishros && . fishros
sudo apt update
sudo apt upgrade
sudo apt install gedit git nano
```

### 2.1 SSH 连接

**机载端**
```bash
sudo apt install openssh-server -y
sudo systemctl enable --now ssh
ip a
```

**本机端**
```bash
ssh -Y chen@192.168.110.195
```

### 2.2 X11 转发窗口

**机载端**
```bash
sudo apt install xauth x11-apps -y
sudo nano /etc/ssh/sshd_config
```
修改内容：
```
X11Forwarding yes
X11DisplayOffset 10
X11UseLocalhost no
```
```bash
sudo systemctl restart ssh
```

**本机**
```bash
sudo apt install xauth -y
ssh -Y chen@192.168.110.195
echo $DISPLAY
xeyes
```

---

## 3 获取 Livox MID360 点云

> BV1PeHCzvEeE  
> https://github.com/Livox-SDK/livox_ros_driver2

### 3.1 网口连接雷达

手动设置有线连接：
- IPv4 手动
- 地址 `192.168.1.50`
- 子网掩码 `255.255.255.0`

### 3.2 上位机

```bash
cd /home/chen/software/LivoxViewer2v2.3.0
./LivoxViewer2.sh
```
> 报错后发现雷达 IP 为 `192.168.123.20`，遂改电脑地址为 `192.168.123.50` 后正常。  
> 上位机内设置：
```
Lidar IP      192.168.1.20
Points IP     192.168.1.50
IMU IP        192.168.1.50
Lidar info IP 192.168.1.50
```
再改回电脑地址 `192.168.1.50`，雷达 IP `192.168.1.20` 连接成功。

### 3.3 安装 SDK

```bash
cd ~
git clone https://github.com/Livox-SDK/Livox-SDK2.git
cd Livox-SDK2
mkdir build && cd build
cmake .. && make -j8
sudo make install
```

### 3.4 编译驱动

```bash
cd ~
git clone https://github.com/Livox-SDK/livox_ros_driver2.git ws_livox/src/livox_ros_driver2
```

修改配置：
```bash
gedit ~/ws_livox/src/livox_ros_driver2/config/MID360_config.json
```
对应上位机设置：
```json
"cmd_data_ip"   : "192.168.1.50",
"push_msg_ip"   : "192.168.1.50",
"point_data_ip" : "192.168.1.50",
"imu_data_ip"   : "192.168.1.50",
"ip"            : "192.168.1.20"
```

编译：
```bash
cd ~/ws_livox
colcon build --packages-select livox_ros_driver2
```

添加环境变量：
```bash
gedit ~/.bashrc
```
追加：
```bash
source ~/ws_livox/install/setup.bash
```

### 3.5 启动

```bash
# 发布 PointCloud2 + 自动 RViz
ros2 launch livox_ros_driver2 rviz_MID360_launch.py

# 发布 Livox 定制格式
ros2 launch livox_ros_driver2 msg_MID360_launch.py
```

> 修改默认不启动 RViz：
```bash
gedit ~/ws_livox/src/livox_ros_driver2/launch_ROS2/rviz_MID360_launch.py
```
删除 RViz 节点后：
```bash
~/ws_livox/src/livox_ros_driver2/build.sh humble
```

手动 RViz：
```bash
ros2 run rviz2 rviz2 -d ~/ws_livox/src/livox_ros_driver2/config/display_point_cloud_ROS2.rviz
```

---

## 4 过滤点云功能包

```bash
sudo apt install nlohmann-json3-dev
```

创建包：
```bash
cd ~/ws_livox/src
ros2 pkg create point_cloud_filter \
  --build-type ament_cmake \
  --dependencies rclcpp sensor_msgs pcl_conversions pcl_ros tf2_ros nlohmann_json \
  --license Apache-2.0
```

配置 `~/lidar.json`：
```json
{
  "intensity_threshold": 160,
  "node_settings": {
    "livox_ros_driver2_topic": "/livox/lidar",
    "point_cloud_filter_topic": "/filtered_pointcloud",
    "frame_id": "livox_frame"
  }
}
```

> 文件清单：
- `src/point_cloud_filter_node.cpp`
- `CMakeLists.txt`
- `package.xml`
- `launch/point_cloud_filter.launch.py`
- `config/display_point_cloud_ROS2.rviz`（话题改为 `/filtered_pointcloud`）

编译：
```bash
cd ~/ws_livox
colcon build --packages-select point_cloud_filter
```

运行：
```bash
ros2 launch livox_ros_driver2 rviz_MID360_launch.py
ros2 launch point_cloud_filter point_cloud_filter.launch.py
ros2 run rviz2 rviz2 -d ~/ws_livox/src/point_cloud_filter/config/display_point_cloud_ROS2.rviz
```

---

## 5 DBSCAN 聚类功能包

```bash
sudo apt-get install libpcap-dev libpcl-dev nlohmann-json3-dev
```

创建包：
```bash
cd ~/ws_livox/src
ros2 pkg create cluster_detection \
  --build-type ament_cmake \
  --dependencies rclcpp sensor_msgs pcl_ros pcl_conversions std_msgs geometry_msgs visualization_msgs
```

> 第三版配置（含卡尔曼 + 轨迹平滑）`~/lidar.json`：
```json
{
  "intensity_threshold": 160,
  "node_settings": { ... },
  "dbscan_parameters": { "eps": 0.05, "min_points": 5, "max_points": 100 },
  "ring_parameters": { "target_diameter": 0.120 },
  "kalman_filter": { "enabled": true, "process_noise": 0.1, "measurement_noise": 0.1, "prediction_enabled": true },
  "tracking_parameters": { "tracking_threshold": 0.2, "max_consecutive_misses": 3, "min_detections_for_stable": 3 }
}
```

> 文件清单：
- `src/ball_cluster_node.cpp`
- `CMakeLists.txt`
- `package.xml`
- `launch/ball_cluster.launch.py`
- `config/display_point_cloud_ROS2.rviz`

编译：
```bash
cd ~/ws_livox
colcon build --packages-select cluster_detection
```

运行：
```bash
ros2 launch livox_ros_driver2 rviz_MID360_launch.py
ros2 launch point_cloud_filter point_cloud_filter.launch.py
ros2 launch cluster_detection ball_cluster.launch.py
ros2 run rviz2 rviz2 -d ~/ws_livox/src/cluster_detection/config/display_point_cloud_ROS2.rviz
```

---

## 6 可视化单帧点云

```bash
sudo apt install python3-rosbag
ros2 bag record -o my_livox /livox/lidar
# Ctrl+C 停止
ros2 bag play my_livox   # 空格暂停
```
> RViz 中 Frame Rate 设为 1 即可看到单帧。

---

## 7 FAST-LIO2 建图

> https://github.com/Ericsii/FAST_LIO_ROS2  
> BV1PeHCzvEeE

```bash
cd ~/ws_livox/src
git clone https://github.com/Ericsii/FAST_LIO_ROS2.git --recursive

# 安装依赖
wget http://fishros.com/install -O fishros && . fishros
rosdepc update
cd ~/ws_livox
rosdepc install --from-paths src --ignore-src -y

# 编译
colcon build --packages-select fast_lio
```

建图：
```bash
ros2 launch livox_ros_driver2 msg_MID360_launch.py
ros2 launch fast_lio mapping.launch.py
```

主要话题：
```
/Laser_map   稠密地图
/Odometry    FAST-LIO 里程计
/livox/imu   IMU 数据
/livox/lidar 原始点云
/tf          动态坐标
/tf_static   静态坐标
```