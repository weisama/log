# 使用超维空间科技S2-F290同款机架和电机电调等，但机载电脑使用迷你主机

---

## 刷入ubuntu22系统
ubuntu官网下载  
https://releases.ubuntu.com/22.04/ubuntu-22.04.5-desktop-amd64.iso  
清华园镜像  
https://mirrors.tuna.tsinghua.edu.cn/ubuntu-releases/22.04/ubuntu-22.04.5-desktop-amd64.iso  

---

## 机载电脑基础设置
```bash
sudo wget http://fishros.com/install  -O fishros && . fishros
sudo apt update
sudo apt upgrade
sudo apt install gedit
sudo apt install git
sudo apt install nano
```

ssh连接  
机载电脑端  
```bash
sudo apt install openssh-server -y
sudo systemctl enable --now ssh
ip a
```
本机端  
```bash
ssh -Y chen@192.168.110.195
```

X11转发窗口  
jetson端  
```bash
sudo apt install xauth x11-apps -y
sudo nano /etc/ssh/sshd_config
```
```
X11Forwarding yes
X11DisplayOffset 10
X11UseLocalhost no
```
```bash
sudo systemctl restart ssh
```
本机  
```bash
sudo apt install xauth -y
ssh -Y chen@192.168.110.195
echo $DISPLAY
xeyes
```

---

## 获取点云
BV1PeHCzvEeE  
https://github.com/Livox-SDK/livox_ros_driver2  

### 网口连接雷达后，设置有线连接
IPv4方式设置为手动  
地址 192.168.1.50  
子掩码 255.255.255.0  

### 下载上位机
https://www.livoxtech.com/cn/downloads  

运行上位机  
```bash
cd /home/chen/software/LivoxViewer2v2.3.0
. LivoxViewer2.sh
```
报错  
运行LivoxViewer2.sh报错投喂ai后发现雷达ip为192.168.123.20  
修改有线连接地址192.168.123.50后成功上位机显示  
上位机中设置  
Lidar IP 192.168.1.20  
Points IP 192.168.1.50  
IMU IP 192.168.1.50  
Lidar info IP 192.168.1.50  
然后复原有线连接地址192.168.1.50  
成功连接雷达，ip为192.168.1.20  

### 下载安装SDK
```bash
cd ~
git clone https://github.com/Livox-SDK/Livox-SDK2.git 
cd Livox-SDK2
mkdir build && cd build
cmake .. && make -j8
sudo make install
```

### 下载编译功能包
https://github.com/Livox-SDK/livox_ros_driver2  
```bash
cd ~
git clone https://github.com/Livox-SDK/livox_ros_driver2.git  ws_livox/src/livox_ros_driver2
```

修改配置文件  
```bash
gedit ~/ws_livox/src/livox_ros_driver2/config/MID360_config.json
```
```
"cmd_data_ip" : "192.168.1.50",
"push_msg_ip": "192.168.1.50",
"point_data_ip": "192.168.1.50",	#同Points IP
"imu_data_ip" : "192.168.1.50",	#同IMU IP

"ip" : "192.168.1.20",		#同Lidar IP
```
修改完编译  
```bash
cd ~/ws_livox
colcon build --packages-select livox_ros_driver2
```

编辑环境变量  
```bash
gedit ~/.bashrc
```
```
source ~/ws_livox/install/setup.bash
```

官方给的启动点云launch  
发布pointcloud2格式数据，自动加载rviz  
```bash
ros2 launch livox_ros_driver2 rviz_MID360_launch.py
```
发布livox定制点云数据  
```bash
ros2 launch livox_ros_driver2 msg_MID360_launch.py
```
Fast-LIO2这些算法通常需要 Livox 自定义格式，RViz可视化使用PointCloud2 标准格式  
格式具体内容见https://github.com/Livox-SDK/livox_ros_driver2  

修改rviz_MID360.launch，默认不启动rviz，改为手动启动  
```bash
gedit ~/ws_livox/src/livox_ros_driver2/launch_ROS2/rviz_MID360_launch.py
```
删除rviz节点相关代码  
```bash
~/ws_livox/src/livox_ros_driver2/build.sh humble
```

启动雷达  
```bash
ros2 launch livox_ros_driver2 rviz_MID360_launch.py
```
手动启动rviz  
```bash
ros2 run rviz2 rviz2 -d ~/ws_livox/src/livox_ros_driver2/config/display_point_cloud_ROS2.rviz
```

---

## 过滤点云功能包
```bash
sudo apt install nlohmann-json3-dev

cd ~/ws_livox/src
ros2 pkg create point_cloud_filter --build-type ament_cmake --dependencies rclcpp sensor_msgs pcl_conversions pcl_ros tf2_ros nlohmann_json --license Apache-2.0
```

```bash
gedit ~/lidar.json
```
```
{
    "intensity_threshold": 160,					#过滤强度阈值
    "node_settings": {
        "livox_ros_driver2_topic": "/livox/lidar",		#初始点云话题
        "point_cloud_filter_topic": "/filtered_pointcloud",	#强度过滤点云话题
        "frame_id": "livox_frame"				#雷达相关话题坐标系
    }
}
```
intensity_threshold:120可以滤除大部分杂物，160可以滤除全部杂物但反光球过小  
后续可视化一帧点云，发现就算阈值设置3,15mm直径的反光球总有一些帧完全无点云  
雷达激光波长905nｍ  

```bash
gedit ~/ws_livox/src/point_cloud_filter/src/point_cloud_filter_node.cpp
gedit ~/ws_livox/src/point_cloud_filter/CMakeLists.txt
gedit ~/ws_livox/src/point_cloud_filter/package.xml
mkdir -p ~/ws_livox/src/point_cloud_filter/launch
gedit ~/ws_livox/src/point_cloud_filter/launch/point_cloud_filter.launch.py
```

创建rivz配置  
```bash
mkdir -p ~/ws_livox/src/point_cloud_filter/config
cp ~/ws_livox/src/livox_ros_driver2/config/display_point_cloud_ROS2.rviz ~/ws_livox/src/point_cloud_filter/config/display_point_cloud_ROS2.rviz
```
修改话题名称  
```bash
gedit ~/ws_livox/src/point_cloud_filter/config/display_point_cloud_ROS2.rviz
```
```
Topic: /filtered_pointcloud
```

编译  
```bash
cd ~/ws_livox
colcon build --packages-select point_cloud_filter
```

运行  
```bash
ros2 launch livox_ros_driver2 rviz_MID360_launch.py
ros2 launch point_cloud_filter point_cloud_filter.launch.py
```
可视化  
```bash
ros2 run rviz2 rviz2 -d ~/ws_livox/src/point_cloud_filter/config/display_point_cloud_ROS2.rviz
```

---

## DBSCAN聚类功能包
```bash
sudo apt-get install libpcap-dev
sudo apt-get install libpcl-dev
sudo apt-get install nlohmann-json3-dev

cd ~/ws_livox/src
ros2 pkg create cluster_detection --build-type ament_cmake --dependencies rclcpp sensor_msgs pcl_ros pcl_conversions std_msgs geometry_msgs visualization_msgs
```

第三版添加了卡尔曼滤波和平滑轨迹  
```bash
gedit ~/lidar.json
```
```
{
    "intensity_threshold": 160,
    "node_settings": {
        "livox_ros_driver2_topic": "/livox/lidar",
        "point_cloud_filter_topic": "/filtered_pointcloud",
        "frame_id": "livox_frame"
    },
    "dbscan_parameters": {
        "eps": 0.05,
        "min_points": 5,
        "max_points": 100
    },
    "ring_parameters": {
        "target_diameter": 0.120
    },
    "kalman_filter": {
        "enabled": true,
        "process_noise": 0.1,
        "measurement_noise": 0.1,
        "prediction_enabled": true
    },
    "tracking_parameters": {
        "tracking_threshold": 0.2,
        "max_consecutive_misses": 3,
        "min_detections_for_stable": 3
    }
}
```

第二版改为检测圆环  
```bash
gedit ~/lidar.json
```
```
{
    "intensity_threshold": 160,
    "node_settings": {
        "livox_ros_driver2_topic": "/livox/lidar",
        "point_cloud_filter_topic": "/filtered_pointcloud",
        "frame_id": "livox_frame"
    },
    "dbscan_parameters": {
        "eps": 0.05,
        "min_points": 5,
        "max_points": 100
    },
    "ring_parameters": {
        "target_diameter": 0.120
    }
}
```

```bash
gedit ~/lidar.json
```
```
{
    "intensity_threshold": 160,					#过滤强度阈值
    "node_settings": {
        "livox_ros_driver2_topic": "/livox/lidar",		#初始点云话题
        "point_cloud_filter_topic": "/filtered_pointcloud",	#强度过滤点云话题
        "frame_id": "livox_frame"				#雷达相关话题坐标系
    },
    "dbscan_parameters": {
        "eps": 0.02,			#聚类邻域半径
        "min_points": 5,		#最小的簇点数
        "max_points": 100		#最大的簇点数
    },
    "ball_parameters": {
        "target_diameter": 0.020,	#检测目标球的直径
        "diameter_tolerance": 0.005,	#检测目标球的直径容忍范围
        "min_cluster_size": 0.005,	#最小聚类尺寸
        "max_cluster_size": 0.030	#最大聚类尺寸
    }
}
```

```bash
gedit ~/ws_livox/src/cluster_detection/src/ball_cluster_node.cpp
gedit ~/ws_livox/src/cluster_detection/package.xml
gedit ~/ws_livox/src/cluster_detection/CMakeLists.txt
mkdir -p ~/ws_livox/src/cluster_detection/launch
gedit ~/ws_livox/src/cluster_detection/launch/ball_cluster.launch.py
```

添加rviz配置  
```bash
mkdir -p ~/ws_livox/src/cluster_detection/config
cp ~/ws_livox/src/point_cloud_filter/config/display_point_cloud_ROS2.rviz ~/ws_livox/src/cluster_detection/config/display_point_cloud_ROS2.rviz
```

编译  
```bash
cd ~/ws_livox
colcon build --packages-select cluster_detection
```

运行节点  
```bash
ros2 launch livox_ros_driver2 rviz_MID360_launch.py
ros2 launch point_cloud_filter point_cloud_filter.launch.py
ros2 launch cluster_detection ball_cluster.launch.py
```
可视化  
```bash
ros2 run rviz2 rviz2 -d ~/ws_livox/src/cluster_detection/config/display_point_cloud_ROS2.rviz
```

---

## 可视化一帧点云
rosbay可以录制和播放话题  

```bash
sudo apt install python3-rosbag
ros2 bag record -o my_livox /livox/lidar
```
ctrl+c暂停录制，注意修改首选项  
```bash
ros2 bag play my_livox
```
空格可暂停  

只要rviz的坐标系频率Frame Rate设置为1就可以看见单帧画面

---

## FAST-LIO
https://github.com/Ericsii/FAST_LIO_ROS2  
BV1PeHCzvEeE  

```bash
cd ~/ws_livox/src
git clone https://github.com/Ericsii/FAST_LIO_ROS2.git  --recursive
```

下载rosdepc更新组件  
```bash
wget http://fishros.com/install  -O fishros && . fishros
rosdepc update 
cd ~/ws_livox
rosdepc install --from-paths src --ignore-src -y
```

编译，忽略警告  
```bash
cd ~/ws_livox
colcon build --packages-select fast_lio
```

建图，使用的是livox自定义格式点云，与聚类的点云格式不同  
```bash
ros2 launch livox_ros_driver2 msg_MID360_launch.py
ros2 launch fast_lio mapping.launch.py
```

话题  
/Laser_map 构建的稠密地图  
/Odometry FAST-LIO 输出的里程计  
/livox/imu Livox 雷达内置 IMU 数据  
/livox/lidar Livox 原始点云数据  
/tf 动态坐标变换  
/tf_static 静态坐标变换
