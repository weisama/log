# 设置功能包launch启动自定义世界和无人机模型
基于美团低空经济挑战赛的仿真环境25.08.09_gazebo_px4  

---

## 构建通信功能包，失败，功能包不兼容humble，解决方法使用mavros通信

```bash
mkdir -p ~/ros2_ws/src/sim_test
cd ~/ros2_ws/src
# 修复后的功能包
git clone -b humble-fixes https://github.com/dronecore/px4_ros_com.git 
git clone -b release/1.13 https://github.com/PX4/px4_ros_com.git 
git clone https://github.com/PX4/px4_msgs.git 
sudo apt install python3-colcon-common-extensions ros-humble-eigen3-cmake-module
pip3 install empy==3.3.4 pyros-genmsg setuptools

cd ~/ros2_ws
colcon build
```

---

## 添加环境变量

```bash
gedit ~/.bashrc
source ~/ros2_ws/install/setup.bash
```

---

## 构建launch启动仿真功能包，失败，编译后无法启动launch.py

```bash
mkdir -p ~/ros2_ws/src/sim_test
cd ~/ros2_ws/src
ros2 pkg create --build-type ament_cmake sim_test --dependencies rclcpp gazebo_ros geometry_msgs
cd ~/ros2_ws/src/sim_test
mkdir -p models worlds launch
mv ~/ros2_ws/src/models/iris ./models/
mv ~/ros2_ws/src/worlds/empty.world ./worlds/
```

`gedit ~/ros2_ws/src/sim_test/launch/sim_test.launch.py`

```bash
from launch import LaunchDescription
from launch.actions import DeclareLaunchArgument, ExecuteProcess, SetEnvironmentVariable
from launch.substitutions import LaunchConfiguration
from launch_ros.actions import Node
import os
from ament_index_python.packages import get_package_share_directory

def generate_launch_description():
    pkg_path = get_package_share_directory('sim_test')
    world_path = os.path.join(pkg_path, 'worlds', 'empty.world')
    model_path = os.path.join(pkg_path, 'models')

    # 系统 Gazebo 模型路径
    system_model_path = '/usr/share/gazebo-11/models'

    # Gazebo 插件和资源路径
    plugin_path = '/usr/lib/x86_64-linux-gnu/gazebo-11/plugins'
    resource_path = '/usr/share/gazebo:/usr/share/gazebo-11'

    return LaunchDescription([
        # 设置 Gazebo 模型路径（系统 + 本地）
        SetEnvironmentVariable(
            name='GAZEBO_MODEL_PATH',
            value=f'{system_model_path}:{model_path}'
        ),
        # 设置插件路径
        SetEnvironmentVariable(
            name='GAZEBO_PLUGIN_PATH',
            value=plugin_path
        ),
        # 设置资源路径
        SetEnvironmentVariable(
            name='GAZEBO_RESOURCE_PATH',
            value=resource_path
        ),
        # 关闭在线模型库（可选）
        SetEnvironmentVariable(
            name='GAZEBO_MODEL_DATABASE_URI',
            value=''
        ),

        # 启动 Gazebo
        ExecuteProcess(
            cmd=['gazebo', '--verbose', world_path],
            output='screen'
        ),
    ])
```

`gedit ~/ros2_ws/src/sim_test/package.xml`

```
<?xml version="1.0"?>
<package format="3">
  <name>sim_test</name>
  <version>0.0.0</version>
  <description>Gazebo simulation test package for iris model</description>
  <maintainer email="chen@example.com">chen</maintainer>
  <license>Apache-2.0</license>

  <!-- 只保留 exec_depend，不要再写 <depend> -->
  <exec_depend>rclcpp</exec_depend>
  <exec_depend>gazebo_ros</exec_depend>
  <exec_depend>geometry_msgs</exec_depend>

  <buildtool_depend>ament_cmake</buildtool_depend>

  <export>
    <build_type>ament_cmake</build_type>
  </export>
</package>
```

`gedit ~/ros2_ws/src/sim_test/CMakeLists.txt`

```
cmake_minimum_required(VERSION 3.8)
project(sim_test)

find_package(ament_cmake REQUIRED)
find_package(rclcpp REQUIRED)
find_package(gazebo_ros REQUIRED)
find_package(geometry_msgs REQUIRED)

install(DIRECTORY
  launch
  models
  worlds
  DESTINATION share/${PROJECT_NAME}
)

ament_package()
```

---

## 编译运行

```bash
cd ~/ros2_ws
rm -rf build install log
colcon build --packages-select sim_test

gedit ~/.bashrc
source install/setup.bash
export GAZEBO_MODEL_DATABASE_URI=""

ros2 launch sim_test sim_test.launch.py
```
